<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Actas con Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- AGREGADO: Mock API para AD cuando no esté disponible -->
    <script>
        // Mock API para desarrollo - reemplazar con la implementación real
        if (typeof window.api === 'undefined') {
            window.api = {
                // Funciones existentes del API...
                searchAdWithCredentials: async function (params) {
                    console.log('Mock AD search:', params);
                    // Simular búsqueda en AD
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            if (params.username === 'test@consensocorp.com' && params.password === 'test123') {
                                resolve({
                                    success: true,
                                    user: {
                                        cn: 'USUARIO DE PRUEBA',
                                        description: '1234567890',
                                        department: 'TI',
                                        sAMAccountName: 'usuario.prueba',
                                        l: 'Cuenca',
                                        company: 'CONSENSO',
                                        mail: 'usuario.prueba@consensocorp.com'
                                    }
                                });
                            } else {
                                resolve({
                                    success: false,
                                    message: 'Credenciales incorrectas o usuario no encontrado'
                                });
                            }
                        }, 2000); // Simular delay de red
                    });
                },
                getImageAsBase64: async function (imageName) {
                    return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                },
                getDashboardData: async function () { return []; },
                getAllAssetsData: async function () { return []; },
                getDrafts: async function () { return []; },
                getFinalizedActas: async function () { return []; },
                saveDraft: async function () { return { success: true }; },
                loadDraft: async function () { return { success: true, acta: {}, equipos: [] }; },
                deleteDraft: async function () { return { success: true }; },
                addActaToDashboard: async function () { return { success: true }; },
                savePdf: async function () { return { success: true, path: 'test.pdf' }; },
                openPdf: async function () { return { success: true }; }
            };
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        #dashboard-table th,
        #retirados-table th,
        #saved-actas-table th,
        #finalized-actas-table th {
            position: sticky;
            top: 0;
            background-color: #1e40af;
            color: white;
            z-index: 10;
        }

        .bg-new-row {
            background-color: #dcfce7 !important;
        }

        .bg-old-row {
            background-color: #fef9c3 !important;
        }

        #acta-preview-content,
        #devolucion-content-wrapper,
        #change-preview-content {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 11pt;
            color: #000;
        }

        #acta-preview-content h1,
        #devolucion-content-wrapper h1,
        #change-preview-content h1 {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 5px;
            color: rgba(24, 121, 174, 1);
            border-bottom: 2px solid rgba(24, 121, 174, 1);
        }

        #acta-preview-content h2,
        #devolucion-content-wrapper h2,
        #change-preview-content h2 {
            font-size: 11pt;
            font-weight: bold;
            background-color: rgba(24, 121, 174, 1);
            color: #FFFFFF;
            padding: 5px;
            margin-top: 15px;
            margin-bottom: 0;
            text-align: center;
            border: 1px solid rgba(24, 121, 174, 1);
        }

        #acta-preview-content h2.package-header {
            font-size: 10pt;
            font-weight: bold;
            background-color: #e0e7ff;
            color: #312e81;
            text-align: left;
            padding: 6px 10px;
            margin-top: 20px;
            margin-bottom: 5px;
            border: 1px solid #c7d2fe;
        }

        #acta-preview-content table,
        #devolucion-content-wrapper table,
        #change-preview-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
        }

        #acta-preview-content th,
        #acta-preview-content td,
        #devolucion-content-wrapper th,
        #devolucion-content-wrapper td,
        #change-preview-content th,
        #change-preview-content td {
            border: 1px solid rgba(24, 121, 174, 1);
            padding: 2px 6px;
            text-align: left;
            vertical-align: middle;
        }

        #acta-preview-content .data-table .label,
        #devolucion-content-wrapper .data-table .label,
        #change-preview-content .data-table .label {
            font-weight: bold;
            background-color: #F2F2F2;
            color: rgba(24, 121, 174, 1);
            text-align: center;
        }

        #acta-preview-content .equipment-table th,
        #devolucion-content-wrapper .equipment-table th,
        #change-preview-content .equipment-table th {
            background-color: rgba(24, 121, 174, 1);
            color: #FFFFFF;
            font-weight: bold;
        }

        #acta-preview-content p,
        #devolucion-content-wrapper p,
        #change-preview-content p {
            margin-bottom: 10px;
            text-align: justify;
        }

        .clausulas-container {
            margin-top: 15px;
            page-break-inside: avoid;
        }

        .legal-text {
            font-family: Arial, sans-serif;
            font-size: 6pt;
            line-height: 1.2;
            text-align: justify;
            column-count: 1;
        }

        .legal-text h3 {
            font-size: 7pt;
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 3px;
        }

        .legal-text ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 5px;
        }

        .legal-text ul li {
            padding-left: 1em;
            position: relative;
            margin-bottom: 3px;
        }

        .legal-text ul li:before {
            content: '⚫';
            position: absolute;
            left: 0;
            top: 0.1em;
            font-size: 0.5em;
            color: black;
        }

        .legal-text ol {
            list-style-type: none;
            counter-reset: item;
            padding-left: 5px;
        }

        .legal-text ol li {
            display: block;
            margin-bottom: 3px;
        }

        .legal-text ol li:before {
            content: counter(item) ".- ";
            counter-increment: item;
            font-weight: bold;
        }

        .modal-overlay {
            transition: opacity 0.3s ease;
        }

        .modal-container {
            transition: transform 0.3s ease;
        }

        .search-panel {
            display: none;
        }

        .search-panel.active {
            display: block;
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            background-color: #f9fafb;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .photo-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            transition: transform 0.2s ease-in-out;
        }

        .photo-item:hover img {
            transform: scale(1.05);
        }

        .delete-photo-btn {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 9999px;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
            transition: background-color 0.2s;
        }

        .delete-photo-btn:hover {
            background-color: rgb(220 38 38);
        }

        .contenedor-con-marca-de-agua {
            position: relative;
            background-color: #fff;
        }

        .contenedor-con-marca-de-agua::before {
            content: "";
            background-image: url('consenso.png');
            background-position: center center;
            background-repeat: no-repeat;
            background-size: contain;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            z-index: -1;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-bar {
            height: 20px;
            width: 0%;
            background-color: #4ade80;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.4s ease;
        }
         /* Clase para el body cuando el splash está activo */
    body.splash-active {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .splash-screen {
        text-align: center;
        color: white;
        opacity: 0;
        transform: scale(0.8);
        animation: fadeInScale 0.8s ease-out forwards;
    }
    @keyframes fadeInScale {
        to { opacity: 1; transform: scale(1); }
    }
    .logos-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 50px;
        margin-bottom: 30px;
        animation: slideInFromTop 1s ease-out 0.5s both;
    }
    @keyframes slideInFromTop {
        from { opacity: 0; transform: translateY(-50px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .logo-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 160px; /* Ancho fijo para alinear */
        height: 100px; /* Alto fijo para alinear */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .program-title {
        font-size: 4rem;
        font-weight: 900;
        letter-spacing: 8px;
        margin: 30px 0 10px 0;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        animation: slideInFromBottom 1s ease-out 1s both;
    }
    @keyframes slideInFromBottom {
        from { opacity: 0; transform: translateY(50px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .program-subtitle {
        font-size: 1.2rem;
        font-weight: 300;
        letter-spacing: 3px;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 40px;
        animation: slideInFromBottom 1s ease-out 1.2s both;
    }
    .loading-container {
        width: 300px;
        margin: 0 auto;
        animation: slideInFromBottom 1s ease-out 1.5s both;
    }
    .loading-text {
        font-size: 0.9rem;
        margin-bottom: 10px;
        color: rgba(255, 255, 255, 0.8);
    }
    .loading-bar {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
    }
    .loading-progress {
        height: 100%;
        background: linear-gradient(90deg, #64b5f6, #42a5f5);
        border-radius: 2px;
        width: 0;
        animation: loadingProgress 4s ease-out 1.8s forwards;
        box-shadow: 0 0 10px rgba(100, 181, 246, 0.5);
    }
    .version {
        position: absolute;
        bottom: 30px;
        right: 30px;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
        animation: fadeIn 1s ease-out 2s both;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .fade-out {
        animation: fadeOut 0.5s ease-out forwards;
    }
    @keyframes fadeOut {
        to {
            opacity: 0;
            transform: scale(0.95);
        }
    }

    #app-container.show {
        display: block;
        animation: dashboardFadeIn 0.8s ease-out;
    }
    @keyframes dashboardFadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ***** INICIO DE NUEVOS ESTILOS PARA SPLASH SCREEN ***** */
        body.splash-active {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .splash-screen {
            text-align: center; color: white; opacity: 0; transform: scale(0.8);
            animation: fadeInScale 0.8s ease-out forwards;
        }
        @keyframes fadeInScale { to { opacity: 1; transform: scale(1); } }
        .logos-container {
            display: flex; justify-content: center; align-items: center; gap: 50px;
            margin-bottom: 30px; animation: slideInFromTop 1s ease-out 0.5s both;
        }
        @keyframes slideInFromTop { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .logo-box {
            background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);
            width: 160px; height: 100px; display: flex; align-items: center; justify-content: center;
        }
        .program-title {
            font-size: 4rem; font-weight: 900; letter-spacing: 8px; margin: 30px 0 10px 0;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3); animation: slideInFromBottom 1s ease-out 1s both;
        }
        @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        .program-subtitle {
            font-size: 1.2rem; font-weight: 300; letter-spacing: 3px; color: rgba(255, 255, 255, 0.9);
            margin-bottom: 40px; animation: slideInFromBottom 1s ease-out 1.2s both;
        }
        .loading-container {
            width: 300px; margin: 0 auto; animation: slideInFromBottom 1s ease-out 1.5s both;
        }
        .loading-text { font-size: 0.9rem; margin-bottom: 10px; color: rgba(255, 255, 255, 0.8); }
        .loading-bar { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; overflow: hidden; }
        .loading-progress {
            height: 100%; background: linear-gradient(90deg, #64b5f6, #42a5f5); border-radius: 2px;
            width: 0; animation: loadingProgress 4s ease-out 1.8s forwards; box-shadow: 0 0 10px rgba(100, 181, 246, 0.5);
        }
        @keyframes loadingProgress { to { width: 100%; } }
        .version {
            position: absolute; bottom: 30px; right: 30px; font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6); animation: fadeIn 1s ease-out 2s both;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-out { animation: fadeOut 0.5s ease-out forwards; }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.95); } }
        #app-container.show { display: block; animation: dashboardFadeIn 0.8s ease-out; }
        @keyframes dashboardFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100">

    <!---------------------------PRESENTACION------------------------------>
    <div class="splash-screen" id="splashScreen">
    <div class="logos-container">
        <div class="logo-box">
            <div class="tecnasa-logo">
                <img src="tecnasa.png" alt="Tecnasa" style="width: 100px;">
            </div>
        </div>
        <div class="logo-box">
            <div class="consenso-logo">
                <img src="consenso.png" alt="Consenso" style="width: 100px;">
            </div>
        </div>
    </div>
    <h1 class="program-title">SIGMA</h1>
    <h2 class="program-subtitle">ACTAS</h2>
    <h3 class="text-white text-lg font-semibold">Precisión en cada acta, control total de tus activos.</h3>
    <h4 class="text-center">--------------------</h4>
    <div class="loading-container">
        <div class="loading-text">Cargando sistema...</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>
    <div class="version">v2.0.1</div>
</div>
    <!---------------------------FIN PRESENTACION------------------------------>
    
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white text-lg font-semibold">Cargando...</p>
        </div>
    </div>
    <div id="app-container" style="display: none;">
        <div id="modal"
            class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0">
            <div class="modal-container bg-white w-full max-w-md rounded-lg shadow-xl p-6 transform scale-95">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <p id="modal-message" class="text-gray-600 mb-6"></p>
                <div id="modal-progress-container" class="hidden">
                    <div class="progress-bar-container">
                        <div id="modal-progress-bar" class="progress-bar"></div>
                    </div>
                    <p id="modal-progress-text" class="text-center text-sm text-gray-500 mt-2"></p>
                </div>
                <div id="modal-buttons" class="flex justify-end space-x-4"></div>
            </div>
        </div>
        <div id="asset-selection-modal"
            class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0">
            <div class="modal-container bg-white w-full max-w-lg rounded-lg shadow-xl transform scale-95">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Seleccionar Activos a Devolver</h3>
                    <p class="text-gray-600 mb-4">Marque los equipos que se están devolviendo. Los no marcados
                        aparecerán como faltantes.</p>
                    <div id="asset-list-container" class="space-y-2 max-h-64 overflow-y-auto border p-3 rounded-md">
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-4 rounded-b-lg">
                    <button id="cancel-asset-selection-btn" type="button"
                        class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md font-semibold">Cancelar</button>
                    <button id="confirm-asset-selection-btn" type="button"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold">Confirmar
                        Selección</button>
                </div>
            </div>
        </div>
        <div id="user-selection-modal"
            class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0">
            <div class="modal-container bg-white w-full max-w-2xl rounded-lg shadow-xl transform scale-95">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Múltiples Coincidencias Encontradas</h3>
                    <p class="text-gray-600 mb-4">Se encontraron varios usuarios que coinciden con su búsqueda. Por
                        favor, seleccione el correcto.</p>
                    <div id="user-list-container" class="space-y-2 max-h-80 overflow-y-auto border p-3 rounded-md">
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-4 rounded-b-lg">
                    <button id="cancel-user-selection-btn" type="button"
                        class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md font-semibold">Cancelar</button>
                </div>
            </div>
        </div>

        <header class="bg-white shadow-md sticky top-0 z-40">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-blue-600">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <h1 class="text-xl font-bold ml-2 text-gray-800">Sistema de Gestión de Actas</h1>
                </div>
            </nav>
            <div class="bg-gray-100 border-b border-t border-gray-200">
                <div class="container mx-auto px-6 py-2 flex justify-center items-center space-x-4">
                    <button id="nav-form-btn"
                        class="px-3 py-2 text-sm font-medium bg-blue-600 text-white rounded-md">Formulario de
                        Acta</button>
                    <button id="nav-change-btn"
                        class="px-3 py-2 text-sm font-medium bg-white text-gray-700 rounded-md hover:bg-gray-50">Formulario
                        de Cambio</button>
                    <button id="nav-saved-actas-btn"
                        class="px-3 py-2 text-sm font-medium bg-white text-gray-700 rounded-md hover:bg-gray-50">Actas
                        Guardadas</button>
                    <button id="nav-finalized-actas-btn"
                        class="px-3 py-2 text-sm font-medium bg-white text-gray-700 rounded-md hover:bg-gray-50">Historial
                        de Actas</button>
                    <button id="nav-devolucion-btn"
                        class="px-3 py-2 text-sm font-medium bg-white text-gray-700 rounded-md hover:bg-gray-50">Formulario
                        de Devolución</button>
                    <button id="nav-dashboard-btn"
                        class="px-3 py-2 text-sm font-medium bg-white text-gray-700 rounded-md hover:bg-gray-50">Dashboard
                        de Exportación</button>
                    <button id="nav-retirados-btn"
                        class="px-3 py-2 text-sm font-medium bg-white text-gray-700 rounded-md hover:bg-gray-50">Administración
                        de Activos</button>
                </div>
            </div>
        </header>

        <main>
            <div id="main-view" class="view active">
                <div class="flex flex-col lg:flex-row min-h-screen">
                    <div class="w-full lg:w-1/2 p-6 bg-white overflow-y-auto">
                        <div class="max-w-3xl mx-auto">
                            <div id="saved-actas-container" class="mb-6 p-4 border rounded-lg bg-gray-50">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">Borradores Recientes</h3>
                                <div class="mb-3">
                                    <input type="search" id="drafts-search-input"
                                        placeholder="Buscar por N° de Acta o Colaborador..."
                                        class="w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div id="lista-actas-guardadas" class="space-y-2"></div>
                            </div>
                            <div class="mb-6 p-4 border-2 border-dashed rounded-lg bg-blue-50">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">Fuente de Datos del Usuario</h3>
                                <div class="flex border-b border-gray-300">
                                    <button id="source-excel-btn"
                                        class="flex-1 py-2 px-4 text-sm font-medium text-center text-white bg-blue-600 rounded-t-lg">Buscar
                                        en Facturación (Excel)</button>
                                    <button id="source-ad-btn"
                                        class="flex-1 py-2 px-4 text-sm font-medium text-center text-gray-700 bg-gray-100 rounded-t-lg">Buscar
                                        en Directorio Activo (AD)</button>
                                </div>
                                <div id="excel-search-panel" class="search-panel active pt-4">
                                    <div class="mb-4">
                                        <label for="excel-file" class="block text-sm font-medium text-gray-600">1.
                                            Cargar Archivo Excel (.xlsx)</label>
                                        <input type="file" id="excel-file" accept=".xlsx"
                                            class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                                    </div>
                                    <div>
                                        <label for="excel-search-input"
                                            class="block text-sm font-medium text-gray-600">2. Buscar por Cédula o
                                            Nombre</label>
                                        <div class="mt-1 flex rounded-md shadow-sm">
                                            <input type="text" id="excel-search-input"
                                                placeholder="Ingrese Cédula o Apellidos y Nombres..."
                                                class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border">
                                            <button type="button" id="excel-search-btn"
                                                class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100">Buscar</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="ad-search-panel" class="search-panel pt-4">
                                    <div>
                                        <label for="ad-search-input"
                                            class="block text-sm font-medium text-gray-600">Buscar por Usuario o Cédula
                                            en AD</label>
                                        <div class="mt-1 flex rounded-md shadow-sm">
                                            <input type="text" id="ad-search-input"
                                                placeholder="Ingrese nombre de usuario o cédula..."
                                                class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border">
                                            <button type="button" id="ad-search-btn"
                                                class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100">
                                                <span id="ad-search-text">Buscar en AD</span>
                                                <div id="ad-search-spinner" class="hidden ml-2">
                                                    <svg class="animate-spin h-4 w-4 text-gray-600"
                                                        xmlns="http://www.w3.org/2000/svg" fill="none"
                                                        viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10"
                                                            stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor"
                                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                        </path>
                                                    </svg>
                                                </div>
                                            </button>
                                        </div>

                                        <!-- Panel de credenciales AD -->
                                         <!--
                                        <div id="ad-credentials-panel"
                                            class="hidden mt-4 p-3 border border-gray-300 rounded-md bg-gray-50">
                                            <h5 class="text-sm font-medium text-gray-700 mb-2">Credenciales de
                                                Directorio Activo</h5>
                                            <div class="space-y-2">
                                                <div>
                                                    <label for="ad-username"
                                                        class="block text-xs font-medium text-gray-600">Usuario</label>
                                                    <div class="flex">
                                                        <input type="text" id="ad-username" placeholder="usuario"
                                                            class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border text-sm">
                                                        <span
                                                            class="inline-flex items-center px-3 border border-l-0 border-gray-300 bg-gray-100 text-gray-600 text-sm">@consensocorp.com</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label for="ad-password"
                                                        class="block text-xs font-medium text-gray-600">Contraseña</label>
                                                    <input type="password" id="ad-password" placeholder="Contraseña"
                                                        class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                                </div>
                                                <div class="flex space-x-2">
                                                    <button type="button" id="ad-authenticate-btn"
                                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm">
                                                        Autenticar y Buscar
                                                    </button>
                                                    <button type="button" id="ad-cancel-btn"
                                                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">
                                                        Cancelar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        -->
                                        <div id="ad-credentials-panel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">

                                            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all">
                                                
                                                <h3 class="text-xl font-bold text-gray-800 mb-4">Credenciales de Directorio Activo</h3>
                                                
                                                <div class="space-y-4">
                                                    <div>
                                                        <label for="ad-username" class="block text-sm font-medium text-gray-700">Usuario</label>
                                                        <div class="mt-1 flex">
                                                            <input type="text" id="ad-username" placeholder="usuario"
                                                                class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border focus:ring-blue-500 focus:border-blue-500">
                                                            <span
                                                                class="inline-flex items-center px-3 border border-l-0 border-gray-300 bg-gray-100 text-gray-600 rounded-r-md">@consensocorp.com</span>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label for="ad-password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                                                        <input type="password" id="ad-password" placeholder="••••••••"
                                                            class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                                    </div>
                                                    <div class="flex flex-col sm:flex-row gap-3 pt-2">
                                                        <button type="button" id="ad-authenticate-btn"
                                                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                                            Autenticar y Buscar
                                                        </button>
                                                        <button type="button" id="ad-cancel-btn"
                                                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                                            Cancelar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- -->
                                    </div>
                                </div>
                            </div>
                            <form id="acta-form">
                                <div class="mb-6 p-4 border rounded-lg">
                                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Datos del Acta</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="tipo_acta" class="block text-sm font-medium text-gray-700">Tipo
                                                de Acta</label>
                                            <select id="tipo_acta" class="mt-1 block w-full p-2 border rounded-md">
                                                <option>ENTREGA DE EQUIPOS</option>
                                                <option>RETIRO DE EQUIPOS</option>
                                                <option selected>REGULARIZACION DE EQUIPOS</option>
                                                <option>DEVOLUCION DE EQUIPOS</option>
                                            </select>
                                        </div>

                                        <!-- Panel para tipo de entrega -->
                                        <div id="entrega-panel"
                                            class="hidden md:col-span-2 p-3 border-2 border-blue-300 rounded-lg bg-blue-50">
                                            <h4 class="text-md font-semibold mb-3 text-blue-800">Tipo de Entrega</h4>
                                            <div class="space-y-2">
                                                <div class="flex items-center">
                                                    <input type="radio" id="entrega_completo" name="entrega_tipo"
                                                        value="completo"
                                                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                                                        checked>
                                                    <label for="entrega_completo"
                                                        class="ml-2 block text-sm font-medium text-gray-900">Entrega de
                                                        Equipo Completo</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input type="radio" id="entrega_activos" name="entrega_tipo"
                                                        value="activos"
                                                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                                    <label for="entrega_activos"
                                                        class="ml-2 block text-sm font-medium text-gray-900">Entrega de
                                                        Activos Específicos</label>
                                                </div>
                                            </div>
                                        </div>

                                        <input type="text" id="acta_n" placeholder="N° ACTA"
                                            class="p-2 border rounded-md">
                                        <input type="date" id="fecha" class="p-2 border rounded-md">
                                        <div>
                                            <label for="tecnico_responsable"
                                                class="block text-sm font-medium text-gray-700">Técnico
                                                Responsable</label>
                                            <select id="tecnico_responsable"
                                                class="mt-1 block w-full p-2 border rounded-md"></select>
                                        </div>
                                        <input type="text" id="usuario" placeholder="USUARIO"
                                            class="p-2 border rounded-md bg-gray-100" readonly>
                                        <input type="text" id="nombre" placeholder="NOMBRE"
                                            class="p-2 border rounded-md bg-gray-100" readonly>
                                        <input type="text" id="cedula" placeholder="CÉDULA"
                                            class="p-2 border rounded-md bg-gray-100" readonly>
                                        <input type="text" id="ciudad" placeholder="CIUDAD"
                                            class="p-2 border rounded-md">
                                        <div>
                                            <label for="ubicacion"
                                                class="block text-sm font-medium text-gray-700">Ubicación</label>
                                            <select id="ubicacion"
                                                class="mt-1 block w-full p-2 border rounded-md"></select>
                                        </div>
                                        <div>
                                            <label for="empresa"
                                                class="block text-sm font-medium text-gray-700">Empresa</label>
                                            <select id="empresa"
                                                class="mt-1 block w-full p-2 border rounded-md"></select>
                                        </div>
                                        <input type="text" id="departamento" placeholder="DEPARTAMENTO"
                                            class="p-2 border rounded-md">
                                        <div class="md:col-span-2">
                                            <label for="correo_usuario"
                                                class="block text-sm font-medium text-gray-700">Correo
                                                Electrónico</label>
                                            <div class="mt-1 flex rounded-md shadow-sm">
                                                <input type="text" id="correo_usuario" placeholder="usuario"
                                                    class="flex-1 block w-full min-w-0 rounded-none rounded-l-md p-2 border-gray-300 border">
                                                <select id="correo_dominio_select"
                                                    class="inline-flex items-center px-3 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 text-sm"></select>
                                                <input type="text" id="correo_dominio_manual" placeholder="@dominio.com"
                                                    class="flex-1 block w-full min-w-0 rounded-none rounded-r-md p-2 border-gray-300 border hidden">
                                            </div>
                                        </div>
                                        <input type="text" id="zona" placeholder="ZONA" class="p-2 border rounded-md">
                                        <input type="text" id="hostname" placeholder="HOSTNAME"
                                            class="p-2 border rounded-md">
                                        <input type="text" id="jefatura" placeholder="JEFATURA"
                                            class="p-2 border rounded-md">
                                        <input type="text" id="ticket" placeholder="TICKET"
                                            class="p-2 border rounded-md">
                                        <div
                                            class="md:col-span-2 flex items-center space-x-3 bg-yellow-100 border border-yellow-300 p-3 rounded-lg">
                                            <input type="checkbox" id="salida_personal_check"
                                                class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                            <label for="salida_personal_check" class="font-bold text-red-700">Salida de
                                                personal</label>
                                        </div>
                                        <textarea id="observaciones" rows="3" placeholder="OBSERVACIONES GENERALES"
                                            class="p-2 border rounded-md md:col-span-2"></textarea>
                                        <div class="md:col-span-2">
                                            <button type="button" id="generate-devolucion-btn"
                                                class="hidden w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Generar
                                                Documento de Devolución</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Panel especial para Retiro de Equipos -->
                                <div id="retiro-panel"
                                    class="hidden mb-6 p-4 border-2 border-orange-300 rounded-lg bg-orange-50">
                                    <h3 class="text-lg font-semibold mb-3 text-orange-800">Opciones de Retiro</h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center">
                                            <input type="radio" id="retiro_todos" name="retiro_tipo" value="todos"
                                                class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300"
                                                checked>
                                            <label for="retiro_todos"
                                                class="ml-2 block text-sm font-medium text-gray-900">Retiro de todos los
                                                activos</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="radio" id="retiro_especificos" name="retiro_tipo"
                                                value="especificos"
                                                class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300">
                                            <label for="retiro_especificos"
                                                class="ml-2 block text-sm font-medium text-gray-900">Retiro de activos
                                                específicos</label>
                                        </div>
                                    </div>

                                    <!-- Lista de activos para selección específica -->
                                    <div id="retiro-activos-list" class="hidden mt-4">
                                        <h4 class="text-md font-semibold mb-2 text-gray-700">Seleccionar Activos a
                                            Retirar</h4>
                                        <p class="text-sm text-gray-600 mb-3">Marque los equipos que se van a retirar.
                                            Los no marcados aparecerán como activos que mantiene el usuario.</p>
                                        <div class="overflow-x-auto border rounded-lg">
                                            <table class="min-w-full bg-white">
                                                <thead class="bg-orange-100">
                                                    <tr>
                                                        <th
                                                            class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Retirar</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Tipo</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Marca</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Serie</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Código</th>
                                                        <th
                                                            class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Editar</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="retiro-activos-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6 p-4 border rounded-lg">
                                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Gestión de Equipos</h3>

                                    <!-- Sección para activos que mantiene (solo visible en entrega de activos específicos) -->
                                    <div id="activos-mantiene-section"
                                        class="hidden mb-4 p-3 border-2 border-yellow-300 rounded-lg bg-yellow-50">
                                        <h4 class="text-md font-semibold mb-2 text-yellow-800">Activos que Mantiene el
                                            Usuario</h4>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full bg-white">
                                                <thead class="bg-yellow-100">
                                                    <tr>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Tipo</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Marca</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Serie</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Código</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="activos-mantiene-body"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <button type="button" id="toggle-manual-form"
                                        class="w-full mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">Añadir
                                        / Editar Activos Manualmente</button>
                                    <div id="equipment-form-container"
                                        class="hidden p-4 border border-dashed rounded-lg bg-gray-50 space-y-3">
                                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Formulario de Equipos</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <select id="eq_tipo" class="p-2 border rounded-md">
                                                <option value="">-- TIPO --</option>
                                            </select>
                                            <input type="text" id="eq_tipo_manual" placeholder="Especifique otro tipo"
                                                class="p-2 border rounded-md hidden">
                                            <select id="eq_marca" class="p-2 border rounded-md">
                                                <option value="">-- MARCA --</option>
                                            </select>
                                            <input type="text" id="eq_marca_manual" placeholder="Especifique otra marca"
                                                class="p-2 border rounded-md hidden">
                                        </div>
                                        <select id="eq_desc" class="p-2 border rounded-md w-full">
                                            <option value="">-- DESCRIPCIÓN --</option>
                                        </select>
                                        <input type="text" id="eq_desc_manual"
                                            placeholder="Especifique otra descripción"
                                            class="p-2 border rounded-md w-full hidden">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <input type="text" id="eq_mtm" placeholder="MTM/SKU"
                                                class="p-2 border rounded-md">
                                            <input type="text" id="eq_serie" placeholder="Serie"
                                                class="p-2 border rounded-md">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <select id="eq_estado" class="p-2 border rounded-md">
                                                <option value="">-- ESTADO --</option>
                                            </select>
                                            <input type="text" id="eq_codigo" placeholder="Código de Activo"
                                                class="p-2 border rounded-md bg-gray-200" readonly>
                                        </div>
                                        <button type="button" id="add-update-equipo-btn"
                                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Agregar
                                            Equipo</button>
                                    </div>
                                    <div class="mt-6">
                                        <div id="equipos-entregados-section" class="hidden mb-4">
                                            <h4 class="text-md font-semibold mb-2 text-green-600">Activos Entregados
                                            </h4>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full bg-white">
                                                    <thead class="bg-green-100">
                                                        <tr>
                                                            <th
                                                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Tipo</th>
                                                            <th
                                                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Marca</th>
                                                            <th
                                                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Serie</th>
                                                            <th
                                                                class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Daño</th>
                                                            <th
                                                                class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Faltante</th>
                                                            <th
                                                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="equipos-entregados-body"></tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <h4 class="text-md font-semibold mb-2 text-gray-600">Equipos Asignados</h4>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full bg-white">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Tipo</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Marca</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Serie</th>
                                                        <th
                                                            class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Daño</th>
                                                        <th
                                                            class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Faltante</th>
                                                        <th
                                                            class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="lista-equipos-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-6 p-4 border rounded-lg">
                                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Fotografías</h3>
                                    <label for="fotos-input" class="block text-sm font-medium text-gray-600">Cargar
                                        nuevas fotos</label>
                                    <input type="file" id="fotos-input" multiple accept="image/*"
                                        class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                                    <div id="fotos-unificadas-preview" class="photo-gallery">
                                    </div>
                                </div>
                                <div class="mb-6 p-4 border rounded-lg">
                                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Firma Alternativa</h3>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="firmar_jefatura"
                                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                        <label for="firmar_jefatura" class="ml-2 block text-sm text-gray-900">Firma
                                            Jefatura en lugar de Usuario</label>
                                    </div>
                                    <div id="jefatura-firma-container"
                                        class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <input type="text" id="jefatura_nombre" placeholder="Nombre de quien firma"
                                            class="p-2 border rounded-md">
                                        <input type="text" id="jefatura_cedula" placeholder="Cédula de quien firma"
                                            class="p-2 border rounded-md">
                                    </div>
                                </div>
                                <div class="mt-8 text-center space-y-3">
                                    <button type="button" id="preguardar-btn"
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Preguardar
                                        Borrador</button>
                                    <button type="button" id="generate-pdf"
                                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Generar
                                        Acta en PDF</button>
                                    <button type="button" id="clear-btn"
                                        class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg">Limpiar
                                        Formulario</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="w-full lg:w-1/2 p-6 bg-gray-200">
                        <div class="sticky top-24">
                            <div class="flex justify-center items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Vista Previa del Acta</h2>
                                <div class="flex items-center ml-4 space-x-2">
                                    <button type="button" id="add-to-dashboard-btn"
                                        class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-3 rounded-lg flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <path d="M12 18v-6"></path>
                                            <path d="m15 15-3-3-3 3"></path>
                                        </svg>
                                        Finalizar y Añadir al Dashboard
                                    </button>
                                </div>
                            </div>
                            <div id="acta-preview" class="bg-white shadow-lg p-8 mx-auto contenedor-con-marca-de-agua"
                                style="width: 21cm; min-height: 29.7cm;">
                                <div id="acta-preview-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista de Cambio -->
            <div id="change-view" class="view p-6 lg:p-8">
                <div class="flex flex-col lg:flex-row min-h-screen">
                    <div class="w-full lg:w-1/2 p-6 bg-white overflow-y-auto">
                        <div class="max-w-3xl mx-auto">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6">Formulario de Cambio de Activos</h2>
                            <div class="mb-6 p-4 border-2 border-dashed rounded-lg bg-blue-50">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">1. Buscar Colaborador</h3>
                                <div>
                                    <label for="change-excel-search-input"
                                        class="block text-sm font-medium text-gray-600">Buscar por Cédula o Nombre en
                                        Excel</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="change-excel-search-input"
                                            placeholder="Ingrese Cédula o Apellidos y Nombres..."
                                            class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border">
                                        <button type="button" id="change-excel-search-btn"
                                            class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100">Buscar</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-6 p-4 border rounded-lg">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">Datos del Acta de Cambio</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="change-acta_n" placeholder="N° ACTA"
                                        class="p-2 border rounded-md">
                                    <input type="date" id="change-fecha" class="p-2 border rounded-md">
                                    <div>
                                        <label for="change-tecnico_responsable"
                                            class="block text-sm font-medium text-gray-700">Técnico Responsable</label>
                                        <select id="change-tecnico_responsable"
                                            class="mt-1 block w-full p-2 border rounded-md"></select>
                                    </div>
                                    <input type="text" id="change-ticket" placeholder="TICKET"
                                        class="p-2 border rounded-md">
                                </div>
                            </div>
                            <div class="mb-6 p-4 border rounded-lg">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">Datos del Usuario (Editable)</h3>
                                <div id="change-contract-data" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <p class="col-span-2 text-gray-500">Busque un colaborador para ver y editar sus
                                        datos.</p>
                                </div>
                                <div class="mt-4">
                                    <label for="change-observaciones"
                                        class="block text-sm font-medium text-gray-700">Observaciones del Cambio</label>
                                    <textarea id="change-observaciones" rows="3"
                                        placeholder="Ej: Se retira mouse por problemas con el scroll..."
                                        class="mt-1 p-2 border rounded-md w-full"></textarea>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h3 class="text-lg font-semibold mb-3 text-gray-700">2. Activos del Colaborador</h3>
                                    <p class="text-xs text-gray-500 mb-2">Seleccione el equipo que será reemplazado.</p>

                                    <div class="mb-2">
                                        <input type="search" id="change-assigned-search" placeholder="Buscar activo..."
                                            class="w-full p-1.5 border rounded-md text-sm">
                                    </div>
                                    <div class="overflow-auto max-h-80">
                                        <table class="min-w-full bg-white text-xs">
                                            <thead class="bg-gray-200">
                                                <tr>
                                                    <th class="p-2 text-center sticky top-0 bg-gray-200">Cambiar</th>
                                                    <th class="p-2 text-left sticky top-0 bg-gray-200">Tipo</th>
                                                    <th class="p-2 text-left sticky top-0 bg-gray-200">Serie</th>
                                                </tr>
                                            </thead>
                                            <tbody id="change-assigned-list"></tbody>
                                        </table>
                                    </div>
                                    <div id="change-assigned-pagination"
                                        class="flex justify-between items-center mt-2 text-xs">
                                        <button id="change-prev-page"
                                            class="px-2 py-1 bg-gray-200 rounded-md disabled:opacity-50">Anterior</button>
                                        <span id="change-page-info"></span>
                                        <button id="change-next-page"
                                            class="px-2 py-1 bg-gray-200 rounded-md disabled:opacity-50">Siguiente</button>
                                    </div>
                                </div>

                                <div class="p-4 border rounded-lg bg-blue-50">
                                    <h3 class="text-lg font-semibold mb-3 text-gray-700">3. Equipo Nuevo a Entregar</h3>
                                    <p class="text-xs text-gray-500 mb-2">Complete los datos del activo de reemplazo.
                                    </p>

                                    <div id="change-equipment-form" class="space-y-2">
                                        <select id="change-eq_tipo" class="p-2 border rounded-md w-full text-sm">
                                            <option value="">-- TIPO --</option>
                                        </select>
                                        <input type="text" id="change-eq_tipo_manual"
                                            placeholder="Especifique otro tipo"
                                            class="p-2 border rounded-md w-full text-sm hidden">
                                        <select id="change-eq_marca" class="p-2 border rounded-md w-full text-sm">
                                            <option value="">-- MARCA --</option>
                                        </select>
                                        <select id="change-eq_desc" class="p-2 border rounded-md w-full text-sm">
                                            <option value="">-- DESCRIPCIÓN --</option>
                                        </select>
                                        <input type="text" id="change-eq_mtm" placeholder="MTM/SKU"
                                            class="p-2 border rounded-md w-full text-sm">
                                        <input type="text" id="change-eq_serie" placeholder="Serie"
                                            class="p-2 border rounded-md w-full text-sm">
                                        <select id="change-eq_estado" class="p-2 border rounded-md w-full text-sm">
                                            <option value="">-- ESTADO --</option>
                                        </select>
                                        <input type="text" id="change-eq_codigo" placeholder="Código de Activo"
                                            class="p-2 border rounded-md w-full text-sm bg-gray-200" readonly>
                                        <button type="button" id="change-add-equipo-btn"
                                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md text-sm">Agregar
                                            Equipo a la Lista</button>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 border-2 border-dashed rounded-lg bg-green-50">
                                    <h4 class="font-bold text-green-800 mb-2">Resumen: Equipo a Entregar</h4>
                                    <p class="text-xs text-gray-500 mb-2">Seleccione con el radio button el equipo que
                                        se entregará finalmente.</p>
                                    <div class="overflow-auto max-h-40">
                                        <table class="min-w-full bg-white text-xs">
                                            <thead class="bg-green-200">
                                                <tr>
                                                    <th class="p-2 text-center">Entregar</th>
                                                    <th class="p-2 text-left">Tipo</th>
                                                    <th class="p-2 text-left">Serie</th>
                                                    <th class="p-2 text-center">X</th>
                                                </tr>
                                            </thead>
                                            <tbody id="change-added-list"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="p-4 border-2 border-dashed rounded-lg bg-red-50">
                                    <h4 class="font-bold text-red-800 mb-2">Resumen: Equipo a Retirar</h4>
                                    <div class="overflow-auto max-h-40">
                                        <table class="min-w-full bg-white text-xs">
                                            <thead class="bg-red-200">
                                                <tr>
                                                    <th class="p-2 text-left">Tipo</th>
                                                    <th class="p-2 text-left">Serie</th>
                                                    <th class="p-2 text-left">Descripción</th>
                                                </tr>
                                            </thead>
                                            <tbody id="change-retired-display-list">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 p-4 border rounded-lg">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">4. Activos que el Colaborador
                                    Conserva</h3>
                                <div class="overflow-auto max-h-60">
                                    <table class="min-w-full bg-white text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th
                                                    class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Tipo</th>
                                                <th
                                                    class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Serie</th>
                                                <th
                                                    class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Descripción</th>
                                                <th
                                                    class="p-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Código Activo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="change-maintained-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="mb-6 p-4 border rounded-lg">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">Fotografías del Activo a Entregar
                                </h3>
                                <label for="change-fotos-entregado"
                                    class="block text-sm font-medium text-gray-600">Cargar fotos</label>
                                <input type="file" id="change-fotos-entregado" multiple accept="image/*"
                                    class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                                <div id="change-fotos-entregado-preview" class="photo-gallery"></div>
                            </div>
                            <div class="mb-6 p-4 border rounded-lg">
                                <h3 class="text-lg font-semibold mb-3 text-gray-700">Fotografías del Activo a Retirar
                                </h3>
                                <label for="change-fotos-retirado"
                                    class="block text-sm font-medium text-gray-600">Cargar fotos</label>
                                <input type="file" id="change-fotos-retirado" multiple accept="image/*"
                                    class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                                <div id="change-fotos-retirado-preview" class="photo-gallery"></div>
                            </div>
                            <div class="mt-8 text-center space-y-3">
                                <button type="button" id="preguardar-change-btn"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Preguardar
                                    Borrador de Cambio</button>
                                <button type="button" id="generate-change-pdf"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Generar
                                    Acta de Cambio en PDF</button>
                                <button type="button" id="clear-change-btn"
                                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg">Limpiar
                                    Formulario de Cambio</button>
                            </div>
                        </div>
                    </div>
                    <div class="w-full lg:w-1/2 p-6 bg-gray-200">
                        <div class="sticky top-24">
                            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Vista Previa del Acta de
                                Cambio</h2>
                            <div id="change-preview" class="bg-white shadow-lg p-8 mx-auto"
                                style="width: 21cm; min-height: 29.7cm;">
                                <div id="change-preview-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="saved-actas-view" class="view p-6 lg:p-8">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Administración de Borradores</h2>
                        <div class="w-1/3">
                            <input type="search" id="saved-actas-search-input"
                                placeholder="Buscar por N° de Acta o Colaborador..."
                                class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div class="bg-white shadow-lg rounded-lg overflow-auto" style="max-height: 80vh;">
                        <table id="saved-actas-table" class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-white uppercase bg-blue-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3">N° Acta</th>
                                    <th scope="col" class="px-6 py-3">Tipo</th>
                                    <th scope="col" class="px-6 py-3">Colaborador</th>
                                    <th scope="col" class="px-6 py-3">Fecha de Guardado</th>
                                    <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="finalized-actas-view" class="view p-6 lg:p-8">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Historial de Actas Finalizadas</h2>
                        <div class="w-1/3">
                            <input type="search" id="finalized-actas-search-input"
                                placeholder="Buscar por N° de Acta o Colaborador..."
                                class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div class="bg-white shadow-lg rounded-lg overflow-auto" style="max-height: 80vh;">
                        <table id="finalized-actas-table" class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-white uppercase bg-blue-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3">N° Acta</th>
                                    <th scope="col" class="px-6 py-3">Tipo</th>
                                    <th scope="col" class="px-6 py-3">Colaborador</th>
                                    <th scope="col" class="px-6 py-3">Fecha de Finalización</th>
                                    <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="dashboard-view" class="view p-6 lg:p-8">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Dashboard de Exportación</h2>
                        <button id="export-dashboard-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Exportar Tabla a Excel
                        </button>
                    </div>
                    <div class="bg-white shadow-lg rounded-lg overflow-auto" style="max-height: 80vh;">
                        <table id="dashboard-table" class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-white uppercase bg-blue-800">
                                <tr></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
<!--
            <div id="devolucion-view" class="view p-6 lg:p-8">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Formulario de Devolución</h2>
                        <button id="export-devolucion-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Exportar Devolución a PDF
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="p-4 border rounded-lg bg-white">
                            <label for="devolucion-search-input" class="block text-sm font-medium text-gray-600">Buscar
                                por
                                Apellidos en Dashboard</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="devolucion-search-input"
                                    placeholder="Ingrese Apellidos del Colaborador..."
                                    class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border">
                                <button type="button" id="devolucion-search-btn"
                                    class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100">Buscar
                                    y Llenar</button>
                            </div>
                        </div>

                        <div class="p-4 border rounded-lg bg-white">
                            <h4 class="text-md font-semibold mb-3 text-gray-700">Datos Manuales</h4>
                            <div class="space-y-2">
                                <input type="text" id="devolucion-manual-nombre" placeholder="Nombre del Colaborador"
                                    class="w-full p-2 border border-gray-300 rounded-md">
                                <input type="text" id="devolucion-manual-cedula" placeholder="Cédula"
                                    class="w-full p-2 border border-gray-300 rounded-md">
                                <input type="text" id="devolucion-manual-usuario" placeholder="Usuario"
                                    class="w-full p-2 border border-gray-300 rounded-md">
                                <button type="button" id="devolucion-manual-btn"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Cargar
                                    Datos Manuales</button>
                            </div>
                        </div>
                    </div>

                    <div id="devolucion-content-wrapper" class="bg-white shadow-lg p-8 mx-auto"
                        style="width: 21cm; min-height: 29.7cm;"></div>
                </div>
            </div>
        -->
            <!--
            <div class="container mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Formulario de Devolución</h2>
        <button id="export-devolucion-btn"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Exportar Devolución a PDF
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="p-4 border rounded-lg bg-white">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Origen de Datos</h3>
            <div class="flex border-b border-gray-300 mb-4">
                <button id="devolucion-tab-buscar" class="flex-1 py-2 px-4 text-sm font-medium text-center text-white bg-blue-600 rounded-t-lg">Buscar Colaborador</button>
                <button id="devolucion-tab-manual" class="flex-1 py-2 px-4 text-sm font-medium text-center text-gray-700 bg-gray-100 rounded-t-lg">Ingresar Usuario Manual</button>
            </div>

            <div id="devolucion-panel-buscar" class="devolucion-panel">
                <label for="devolucion-search-input" class="block text-sm font-medium text-gray-600">Buscar por Apellidos en Dashboard</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="devolucion-search-input" placeholder="Ingrese Apellidos del Colaborador..." class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border">
                    <button type="button" id="devolucion-search-btn" class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100">Buscar</button>
                </div>
            </div>

            <div id="devolucion-panel-manual" class="devolucion-panel hidden space-y-3">
                 <input type="text" id="devolucion-manual-nombre" placeholder="Nombre Completo del Colaborador" class="w-full p-2 border border-gray-300 rounded-md">
                 <input type="text" id="devolucion-manual-cedula" placeholder="Cédula" class="w-full p-2 border border-gray-300 rounded-md">
                 <input type="text" id="devolucion-manual-usuario" placeholder="Usuario de Red (Opcional)" class="w-full p-2 border border-gray-300 rounded-md">
                 <button type="button" id="devolucion-manual-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Cargar Datos Manuales</button>
            </div>
             <div class="mt-4">
                 <label for="devolucion-observaciones" class="block text-sm font-medium text-gray-700">Observaciones</label>
                <textarea id="devolucion-observaciones" rows="2" placeholder="Observaciones generales de la devolución..." class="mt-1 p-2 border rounded-md w-full"></textarea>
            </div>
        </div>

        <div class="p-4 border rounded-lg bg-white">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Recibido Por (Firma)</h3>
            <div class="space-y-3">
                <div class="flex items-center">
                    <input type="radio" id="recibe-grupo-tecnicos" name="recibe_grupo" value="tecnicos" class="h-4 w-4 text-blue-600" checked>
                    <label for="recibe-grupo-tecnicos" class="ml-2 block text-sm font-medium text-gray-900">Grupo Técnicos</label>
                </div>
                <div class="flex items-center">
                    <input type="radio" id="recibe-grupo-observabilidad" name="recibe_grupo" value="observabilidad" class="h-4 w-4 text-blue-600">
                    <label for="recibe-grupo-observabilidad" class="ml-2 block text-sm font-medium text-gray-900">Grupo Observabilidad</label>
                </div>
                <div class="flex items-center">
                    <input type="radio" id="recibe-grupo-manual" name="recibe_grupo" value="manual" class="h-4 w-4 text-blue-600">
                    <label for="recibe-grupo-manual" class="ml-2 block text-sm font-medium text-gray-900">Ingreso Manual</label>
                </div>
            </div>
            <div id="devolucion-recibe-selector-container" class="mt-4">
                 <select id="devolucion-recibe-select" class="block w-full p-2 border-gray-300 rounded-md shadow-sm"></select>
            </div>
            <div id="devolucion-recibe-manual-container" class="hidden mt-4 space-y-3">
                <input type="text" id="devolucion-recibe-manual-nombre" placeholder="Nombre de quien recibe" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="text" id="devolucion-recibe-manual-cedula" placeholder="Cédula de quien recibe" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
        </div>
        
        <div class="lg:col-span-2 p-4 border rounded-lg bg-white">
             <h3 class="text-lg font-semibold mb-3 text-gray-700">Gestión de Equipos a Devolver</h3>
             <div id="devolucion-equipment-form-container" class="p-4 border border-dashed rounded-lg bg-gray-50 space-y-3">
                </div>
             <div class="mt-4">
                <h4 class="text-md font-semibold mb-2 text-gray-600">Equipos en el Acta de Devolución</h4>
                <div id="devolucion-equipos-list" class="overflow-x-auto"></div>
             </div>
        </div>
    </div>
    <div id="devolucion-content-wrapper" class="bg-white shadow-lg p-8 mx-auto"
        style="width: 21cm; min-height: 29.7cm;">
        </div>
</div>






-->
<!---->
            <div id="devolucion-view" class="view p-6 lg:p-8">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Formulario de Devolución</h2>
                        
                        <button id="generate-devolucion-pdf"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Exportar Devolución a PDF
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Origen de Datos</h3>
                            <div class="flex border-b border-gray-300 mb-4">
                                <button id="devolucion-tab-buscar" class="flex-1 py-2 px-4 text-sm font-medium text-center text-white bg-blue-600 rounded-t-lg">Buscar Colaborador</button>
                                <button id="devolucion-tab-manual" class="flex-1 py-2 px-4 text-sm font-medium text-center text-gray-700 bg-gray-100 rounded-t-lg">Ingresar Usuario Manual</button>
                            </div>
                
                            <div id="devolucion-panel-buscar" class="devolucion-panel">
                                <label for="devolucion-search-input" class="block text-sm font-medium text-gray-600">Buscar por Apellidos en Dashboard</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="devolucion-search-input" placeholder="Ingrese Apellidos del Colaborador..." class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300 border">
                                    <button type="button" id="devolucion-search-btn" class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100">Buscar</button>
                                </div>
                            </div>
                
                            <div id="devolucion-panel-manual" class="devolucion-panel hidden space-y-3">
                                 <input type="text" id="devolucion-manual-nombre" placeholder="Nombre Completo del Colaborador" class="w-full p-2 border border-gray-300 rounded-md">
                                 <input type="text" id="devolucion-manual-cedula" placeholder="Cédula" class="w-full p-2 border border-gray-300 rounded-md">
                                 <input type="text" id="devolucion-manual-usuario" placeholder="Usuario de Red (Opcional)" class="w-full p-2 border border-gray-300 rounded-md">
                                 <button type="button" id="devolucion-manual-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Cargar Datos Manuales</button>
                            </div>
                             <div class="mt-4">
                                 <label for="devolucion-observaciones" class="block text-sm font-medium text-gray-700">Observaciones</label>
                                <textarea id="devolucion-observaciones" rows="2" placeholder="Observaciones generales de la devolución..." class="mt-1 p-2 border rounded-md w-full"></textarea>
                            </div>
                        </div>

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Recibido Por (Firma)</h3>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="radio" id="recibe-grupo-tecnicos" name="recibe_grupo" value="tecnicos" class="h-4 w-4 text-blue-600" checked>
                                    <label for="recibe-grupo-tecnicos" class="ml-2 block text-sm font-medium text-gray-900">Grupo Técnicos</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="recibe-grupo-observabilidad" name="recibe_grupo" value="observabilidad" class="h-4 w-4 text-blue-600">
                                    <label for="recibe-grupo-observabilidad" class="ml-2 block text-sm font-medium text-gray-900">Grupo Observabilidad</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="recibe-grupo-manual" name="recibe_grupo" value="manual" class="h-4 w-4 text-blue-600">
                                    <label for="recibe-grupo-manual" class="ml-2 block text-sm font-medium text-gray-900">Ingreso Manual</label>
                                </div>
                            </div>
                            <div id="devolucion-recibe-selector-container" class="mt-4">
                                 <select id="devolucion-recibe-select" class="block w-full p-2 border-gray-300 rounded-md shadow-sm"></select>
                            </div>
                            <div id="devolucion-recibe-manual-container" class="hidden mt-4 space-y-3">
                                <input type="text" id="devolucion-recibe-manual-nombre" placeholder="Nombre de quien recibe" class="w-full p-2 border border-gray-300 rounded-md">
                                <input type="text" id="devolucion-recibe-manual-cedula" placeholder="Cédula de quien recibe" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>

                         <div class="lg:col-span-2 p-4 border rounded-lg bg-white">
                             <h3 class="text-lg font-semibold mb-3 text-gray-700">Gestión de Equipos a Devolver</h3>
                             <div id="devolucion-equipment-form-container" class="p-4 border border-dashed rounded-lg bg-gray-50 space-y-3">
                                </div>
                             <div class="mt-4">
                                <h4 class="text-md font-semibold mb-2 text-gray-600">Equipos en el Acta de Devolución</h4>
                                <div id="devolucion-equipos-list" class="overflow-x-auto"></div>
                             </div>
                        </div>
                    </div>
                    <div id="devolucion-content-wrapper" class="bg-white shadow-lg p-8 mx-auto"
                        style="width: 21cm; min-height: 29.7cm;">
                    </div>
                </div>
            </div>
            <!---->
            </div>
        </main>
    </div>


<!---->
            <div id="retirados-view" class="view p-6 lg:p-8">
<!--
                *********************************************
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Administración de Activos</h2>
                        <button id="export-retirados-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Exportar a Excel
                        </button>
                    </div>
                    <div class="bg-white shadow-lg rounded-lg overflow-auto" style="max-height: 80vh;">
                        <table id="retirados-table" class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-white uppercase bg-blue-800">
                                <tr></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                *********************************************
            -->
 
    <!--
    ********************************
    -->

    <script>
    // --- LÓGICA DE LA PANTALLA DE BIENVENIDA ---
    (function() {
        document.body.classList.add('splash-active');
        const splashScreen = document.getElementById('splashScreen');
        const appContainer = document.getElementById('app-container');

        function showApp() {
            if (!splashScreen || splashScreen.style.display === 'none') return;
            splashScreen.classList.add('fade-out');
            document.body.classList.remove('splash-active');
            setTimeout(() => {
                splashScreen.style.display = 'none';
                appContainer.style.display = 'block';
                appContainer.classList.add('show');
            }, 500);
        }

        const splashTimeout = setTimeout(showApp, 5000);
        document.addEventListener('click', () => {
            clearTimeout(splashTimeout);
            showApp();
        }, { once: true });
    })();

    
        document.addEventListener('DOMContentLoaded', function () {

            const loadingOverlay = document.getElementById('loading-overlay');

            function showLoader() {
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('hidden');
                }
            }

            function hideLoader() {
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }

            if (typeof window.api === 'undefined') {
                document.getElementById('app-container').innerHTML = `
                   <div class="flex items-center justify-center h-screen bg-red-100">
                       <div class="text-center p-8 bg-white rounded-lg shadow-lg max-w-lg">
                           <h1 class="text-2xl font-bold text-red-700 mb-4">Error de Carga de la Aplicación</h1>
                           <p class="text-gray-700">La interfaz no pudo comunicarse con la base de datos.</p>
                           <p class="text-gray-600 mt-4">Este problema ocurre cuando el archivo <code class="bg-gray-200 p-1 rounded">index.html</code> se abre directamente en un navegador web.</p>
                           <p class="text-gray-600 mt-2">Para que la aplicación funcione correctamente, debe ejecutarla desde su terminal con el comando:</p>
                           <pre class="bg-gray-800 text-white p-3 rounded-md mt-4 text-left"><code>npm start</code></pre>
                       </div>
                   </div>
               `;
                return;
            }
            
//
            // Agrega esto para que los botones de selección de fuente de datos funcionen
            const sourceExcelBtn = document.getElementById('source-excel-btn');
            const sourceAdBtn = document.getElementById('source-ad-btn');
            const excelSearchPanel = document.getElementById('excel-search-panel');
            const adSearchPanel = document.getElementById('ad-search-panel');

            sourceExcelBtn.addEventListener('click', () => {
                // Muestra el panel de Excel y oculta el de AD
                excelSearchPanel.classList.add('active');
                adSearchPanel.classList.remove('active');
                
                // Cambia los estilos de los botones para mostrar cuál está activo
                sourceExcelBtn.classList.add('bg-blue-600', 'text-white');
                sourceExcelBtn.classList.remove('bg-gray-100', 'text-gray-700');
                sourceAdBtn.classList.add('bg-gray-100', 'text-gray-700');
                sourceAdBtn.classList.remove('bg-blue-600', 'text-white');
            });

            sourceAdBtn.addEventListener('click', () => {
                // Muestra el panel de AD y oculta el de Excel
                adSearchPanel.classList.add('active');
                excelSearchPanel.classList.remove('active');

                // Cambia los estilos de los botones para mostrar cuál está activo
                sourceAdBtn.classList.add('bg-blue-600', 'text-white');
                sourceAdBtn.classList.remove('bg-gray-100', 'text-gray-700');
                sourceExcelBtn.classList.add('bg-gray-100', 'text-gray-700');
                sourceExcelBtn.classList.remove('bg-blue-600', 'text-white');
            });


            //

            const { jsPDF } = window.jspdf;
            
            
            //const dashboardHeaders = ['No.', 'Hostname', 'Modelo Consenso', 'Componentes', 'Modelo MTM', 'Tipo Monitor', 'Requiere Teclado y Mouse', 'LICENCIA MS365 E3', 'CANDADO', 'Detalle', 'Nombre de usuario', 'SERIE PC', 'SERIE MON', 'SERIE MON 2', 'Código de activo del equipo', 'Código de activo del Monitor', 'Código de activo del Monitor 2', 'Código de activo del teclado', 'Código de activo del Mouse', 'Código de activo del Cargador', 'Paquete', 'Activo Mochila', 'Activo Extra 1', 'Activo Extra 2', 'Activo Extra 3', 'Activo Extra 4', 'Activo Extra 5', 'Nombre de usuario (duplicado)', 'Colaborador', 'Cédulas', 'FECHA DE ENTREGA REAL', 'ACTA DE ENTREGA', 'ACTA DE RETIRO', 'FECHA DE DESVINCULACION', 'TECNICO', 'LINK DE ACTA', 'REGULARIZADA', 'MOTIVO DE CAMBIO', 'Observaciones'];
            //-------------
            /*
            const dashboardHeaders = [
                'No.', 'Hostname', 'Modelo Consenso', 'Componentes', 'Modelo MTM', 'Tipo Monitor', 'Requiere Teclado y Mouse', 
                'LICENCIA MS365 E3', 'CANDADO', 'Detalle', 'Nombre de usuario', 'SERIE PC', 'SERIE MON', 'SERIE MON 2', 
                'Código de activo del equipo', 'Código de activo del Monitor', 'Código de activo del Monitor 2', 
                'Código de activo del teclado', 'Código de activo del Mouse', 'Código de activo del Cargador', 
                'Paquete', 'Activo Mochila', 'Activo Extra 1', 'Activo Extra 2', 'Activo Extra 3', 'Activo Extra 4', 'Activo Extra 5',
                'Nombre de usuario (duplicado)', 'Colaborador', 'Cédulas', 'FECHA DE ENTREGA REAL', 'ACTA DE ENTREGA', 'ACTA DE RETIRO',
                'FECHA DE DESVINCULACION', 'TECNICO', 'LINK DE ACTA', 'REGULARIZADA', 'MOTIVO DE CAMBIO', 'Observaciones'
            ];
            */
            //---------------
            const dashboardHeaders = [
                'Paquete', // <-- ¡Movido al principio!
                'No.', 'Hostname', 'Modelo Consenso', 'Componentes', 'Modelo MTM', 'Tipo Monitor', 'Requiere Teclado y Mouse', 
                'LICENCIA MS365 E3', 'CANDADO', 'Detalle', 'Nombre de usuario', 'SERIE PC', 'SERIE MON', 'SERIE MON 2', 
                'Código de activo del equipo', 'Código de activo del Monitor', 'Código de activo del Monitor 2', 
                'Código de activo del teclado', 'Código de activo del Mouse', 'Código de activo del Cargador', 
                'Activo Mochila', 'Activo Extra 1', 'Activo Extra 2', 'Activo Extra 3', 'Activo Extra 4', 'Activo Extra 5',
                'Nombre de usuario (duplicado)', 'Colaborador', 'Cédulas', 'FECHA DE ENTREGA REAL', 'ACTA DE ENTREGA', 'ACTA DE RETIRO',
                'FECHA DE DESVINCULACION', 'TECNICO', 'LINK DE ACTA', 'REGULARIZADA', 'MOTIVO DE CAMBIO', 'Observaciones'
            ];
            //-------------
            const allAssetsHeaders = ['Tipo Acta', 'Tipo', 'Marca', 'Descripción', 'Serie', 'Daño', 'Estado', 'Faltante', 'Acta N°', 'Fecha', 'Usuario Original'];

            async function renderDashboardTable() {
                const data = await window.api.getDashboardData();
                const tableHead = document.querySelector('#dashboard-table thead tr');
                const tableBody = document.querySelector('#dashboard-table tbody');

                tableHead.innerHTML = '';
                tableBody.innerHTML = '';

                dashboardHeaders.forEach(headerText => {
                    const header = document.createElement('th');
                    header.scope = 'col';
                    header.className = 'px-6 py-3 text-left';
                    header.textContent = headerText;
                    tableHead.appendChild(header);
                });

                if (!data || data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${dashboardHeaders.length}" class="text-center p-8">No hay actas finalizadas en el dashboard.</td></tr>`;
                    return;
                }

                 // --- INICIO DE LA NUEVA LÓGICA DE COLOREADO ---

                // 1. Obtenemos la fecha de hoy en un formato simple (YYYY-MM-DD) para comparar
                const hoy = new Date();
                const hoyStr = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
                
                data.forEach((rowData) => {
                    const row = document.createElement('tr');
                    
                    // 2. Obtenemos la fecha de la fila del dashboard
                    // La fecha viene en formato 'DD/MM/YYYY', la convertimos a 'YYYY-MM-DD' para comparar
                    const fechaEntrega = rowData['FECHA DE ENTREGA REAL'] || '';
                    const partesFecha = fechaEntrega.split('/');
                    const fechaFilaStr = partesFecha.length === 3 ? `${partesFecha[2]}-${partesFecha[1]}-${partesFecha[0]}` : null;

                    // 3. Asignamos el color de fondo según la fecha
                    if (fechaFilaStr === hoyStr) {
                        // Celeste para las filas de hoy (Tailwind: bg-blue-100)
                        row.className = 'border-b bg-blue-100'; 
                    } else {
                        // Rosado pastel para las filas antiguas (Tailwind: bg-pink-100)
                        row.className = 'border-b bg-pink-100'; 
                    }
                    // --- FIN DE LA NUEVA LÓGICA DE COLOREADO ---

                    dashboardHeaders.forEach(header => {
                        const cell = document.createElement('td');
                        cell.className = 'px-6 py-4';
                        cell.textContent = rowData[header] || '';
                        row.appendChild(cell);
                    });
                    tableBody.appendChild(row);
                });

/*
                const today = new Date().toDateString();

                data.forEach((rowData) => {
                    const row = document.createElement('tr');
                    const rowDate = rowData['FECHA DE ENTREGA REAL'] ? new Date(rowData['FECHA DE ENTREGA REAL']).toDateString() : null;

                    // Determinar color de fila
                    if (rowDate === today) {
                        row.className = 'border-b bg-new-row'; // Verde para datos del día
                    } else {
                        row.className = 'border-b bg-old-row'; // Amarillo para datos anteriores
                    }

                    dashboardHeaders.forEach(header => {
                        const cell = document.createElement('td');
                        cell.className = 'px-6 py-4';
                        cell.textContent = rowData[header] || '';
                        row.appendChild(cell);
                    });
                    tableBody.appendChild(row);
                });
*/                
            }

            async function renderAllAssetsTable() {
                const data = await window.api.getAllAssetsData();
                const tableHead = document.querySelector('#retirados-table thead tr');
                const tableBody = document.querySelector('#retirados-table tbody');

                tableHead.innerHTML = '';
                tableBody.innerHTML = '';

                allAssetsHeaders.forEach(headerText => {
                    const header = document.createElement('th');
                    header.scope = 'col';
                    header.className = 'px-6 py-3 text-left';
                    header.textContent = headerText;
                    tableHead.appendChild(header);
                });

                if (!data || data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${allAssetsHeaders.length}" class="text-center p-8">No hay activos registrados en las actas finalizadas.</td></tr>`;
                    return;
                }

                data.forEach((rowData) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    allAssetsHeaders.forEach(header => {
                        const cell = document.createElement('td');
                        cell.className = 'px-6 py-4';
                        cell.textContent = rowData[header] || '';
                        row.appendChild(cell);
                    });
                    tableBody.appendChild(row);
                });
            }

            async function generateAndSavePdfForFinalize() {
                try {
                    const dataForPdf = await getFormData();

                    const getFilenameData = (data) => {
                        let siglas = '';
                        const tipoActaUpper = data.tipo_acta.toUpperCase();
                        let folderName = 'actas_otros';

                        if (tipoActaUpper.includes('RETIRO')) {
                            siglas = 'RET'; folderName = 'actas_retiro';
                        } else if (tipoActaUpper.includes('ENTREGA')) {
                            siglas = 'ASIG'; folderName = 'actas_entrega';
                        } else if (tipoActaUpper.includes('DEVOLUCION')) {
                            siglas = 'DEV'; folderName = 'actas_devolucion';
                        } else if (tipoActaUpper.includes('REGULARIZACION')) {
                            siglas = 'REG'; folderName = 'actas_regularizacion';
                        }

                        const nombreUsuario = (data.nombre || 'SIN_USUARIO').replace(/\s+/g, '_').toUpperCase();
                        const pc = data.equipos.find(e => e.tipo === 'PC' || e.tipo === 'LAPTOP');
                        const seriePC = pc ? pc.serie : 'SIN_SERIE_PC';
                        const fecha = new Date(data.fecha + 'T00:00:00');
                        const fechaStr = fecha.getDate().toString().padStart(2, '0') +
                            (fecha.getMonth() + 1).toString().padStart(2, '0') +
                            fecha.getFullYear();

                        const filename = `ACT - ${siglas} - ${nombreUsuario} - ${seriePC} - ${fechaStr}.pdf`;
                        return { filename, folderName };
                    };

                    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const logoRightBase64 = await window.api.getImageAsBase64('consenso.png');
                    await pageContent(doc, dataForPdf, logoRightBase64);

                    const { filename, folderName } = getFilenameData(dataForPdf);
                    const result = await window.api.savePdf({
                        pdfData: doc.output('arraybuffer'),
                        folderName: folderName,
                        filename: filename
                    });

                    if (result.success) {
                        return { success: true, path: result.path };
                    } else {
                        return { success: false, message: result.message };
                    }

                } catch (error) {
                    console.error("Error crítico durante la generación del PDF para finalizar:", error);
                    return { success: false, message: error.message };
                }
            }
/*
            async function addActaToDashboard() {
                if (!validateForm()) return;

                showModal('Finalizando Acta...', 'Generando PDF y guardando datos, por favor espere.', [], 'progress');

                try {
                    const pdfResult = await generateAndSavePdfForFinalize();
                    if (!pdfResult.success) {
                        hideModal();
                        showModal('Error de PDF', `No se pudo generar el PDF: ${pdfResult.message}`);
                        return;
                    }
                    updateModalProgress(50, 'PDF generado. Procesando datos para el dashboard...');

                    const actaData = await getFormData();
                    const NA = 'NO APLICA';
                    const tipoActaUpper = actaData.tipo_acta.toUpperCase();
                    const tecnicoSeleccionado = tecnicos.find(t => t.cedula === actaData.tecnico_responsable) || { nombre: '', cedula: '' };

                    const dashboardRows = [];
                    const paquetes = actaData.equipos.filter(e => ['PC', 'LAPTOP'].includes((e.tipo || '').toUpperCase()));

                    if (paquetes.length === 0) {
                        paquetes.push({ tipo: 'General', serie: 'NINGUNO' });
                    }

                    for (const paquete of paquetes) {
                        const esPaqueteVirtual = paquete.serie === 'NINGUNO';
                        let componentesPaquete = esPaqueteVirtual ? [] : [paquete.tipo];
                        let observacionesPaquete = [];

                        const perifericos = esPaqueteVirtual
                            ? actaData.equipos.filter(e => !e.idPaquete)
                            : actaData.equipos.filter(p => p.idPaquete === paquete.serie);

                        const monitors = perifericos.filter(e => (e.tipo || '').toUpperCase() === 'MONITOR');
                        const teclado = perifericos.find(e => (e.tipo || '').toUpperCase() === 'TECLADO');
                        const mouse = perifericos.find(e => (e.tipo || '').toUpperCase() === 'RATÓN' || (e.tipo || '').toUpperCase() === 'MOUSE');
                        const cargador = perifericos.find(e => (e.tipo || '').toUpperCase() === 'CARGADOR');
                        const mochila = perifericos.find(e => (e.tipo || '').toUpperCase() === 'MOCHILA');

                        const otrosActivos = perifericos.filter(e => !['MONITOR', 'TECLADO', 'RATÓN', 'MOUSE', 'CARGADOR', 'MOCHILA'].includes((e.tipo || '').toUpperCase()));

                        // Agregar componentes de otros activos
                        otrosActivos.forEach(otro => {
                            componentesPaquete.push(otro.tipo);
                            observacionesPaquete.push(`${otro.tipo}: ${otro.desc || ''} (Serie: ${otro.serie || 'N/A'})`);
                        });

                        let siglas = '';
                        if (tipoActaUpper.includes('RETIRO')) siglas = 'RET';
                        else if (tipoActaUpper.includes('ENTREGA')) siglas = 'ASIG';
                        else if (tipoActaUpper.includes('REGULARIZACION')) siglas = 'REG';
                        else if (tipoActaUpper.includes('DEVOLUCION')) siglas = 'DEV';

                        const nombreUsuario = actaData.nombre.toUpperCase() || 'SIN_NOMBRE';
                        const serieLaptop = esPaqueteVirtual ? 'SIN_SERIE' : (paquete.serie || 'SIN_SERIE');
                        const hoy = new Date(actaData.fecha + 'T00:00:00');
                        const fechaActualStr = `${String(hoy.getDate()).padStart(2, '0')}${String(hoy.getMonth() + 1).padStart(2, '0')}${hoy.getFullYear()}`;
                        const linkDeActa = `ACT - ${siglas} - ${nombreUsuario} - ${serieLaptop} - ${fechaActualStr}`;

                        const newRowData = {
                            'No.': actaData.acta_n || NA,
                            'Hostname': esPaqueteVirtual ? (actaData.hostname || NA) : (paquete.hostname || actaData.hostname || NA),
                            'Modelo Consenso': esPaqueteVirtual ? NA : (paquete.desc || NA),
                            'Componentes': componentesPaquete.join(', ') || NA,
                            'Modelo MTM': esPaqueteVirtual ? NA : (paquete.mtm || NA),
                            'Tipo Monitor': monitors.length > 0 ? (monitors[0].desc || NA) : NA,
                            'Requiere Teclado y Mouse': (teclado && mouse) ? 'SI' : 'NO',
                            'LICENCIA MS365 E3': NA,
                            'CANDADO': NA,
                            'Detalle': actaData.tipo_acta.replace(' DE EQUIPOS', '') || NA,
                            'Nombre de usuario': actaData.usuario || NA,
                            'SERIE PC': esPaqueteVirtual ? NA : (paquete.serie || NA),
                            'SERIE MON': monitors.length > 0 ? (monitors[0].serie || NA) : NA,
                            'SERIE MON 2': monitors.length > 1 ? (monitors[1].serie || NA) : NA,
                            'Código de activo del equipo': esPaqueteVirtual ? NA : (paquete.codigo || NA),
                            'Código de activo del Monitor': monitors.length > 0 ? (monitors[0].codigo || NA) : NA,
                            'Código de activo del Monitor 2': monitors.length > 1 ? (monitors[1].codigo || NA) : NA,
                            'Código de activo del teclado': teclado ? (teclado.codigo || NA) : NA,
                            'Código de activo del Mouse': mouse ? (mouse.codigo || NA) : NA,
                            'Código de activo del Cargador': cargador ? (cargador.codigo || NA) : NA,
                            'Paquete': esPaqueteVirtual ? 'GENERAL' : (paquete.serie || NA),
                            'Activo Mochila': mochila ? (mochila.serie || 'SI') : NA,
                            'Activo Extra 1': otrosActivos.length > 0 ? `${otrosActivos[0].tipo}: ${otrosActivos[0].serie}` : NA,
                            'Activo Extra 2': otrosActivos.length > 1 ? `${otrosActivos[1].tipo}: ${otrosActivos[1].serie}` : NA,
                            'Activo Extra 3': otrosActivos.length > 2 ? `${otrosActivos[2].tipo}: ${otrosActivos[2].serie}` : NA,
                            'Activo Extra 4': otrosActivos.length > 3 ? `${otrosActivos[3].tipo}: ${otrosActivos[3].serie}` : NA,
                            'Activo Extra 5': otrosActivos.length > 4 ? `${otrosActivos[4].tipo}: ${otrosActivos[4].serie}` : NA,
                            'Nombre de usuario (duplicado)': actaData.usuario || NA,
                            'Colaborador': actaData.nombre || NA,
                            'Cédulas': actaData.cedula || NA,
                            'FECHA DE ENTREGA REAL': actaData.fecha ? new Date(actaData.fecha + 'T00:00:00').toLocaleDateString('es-ES') : NA,
                            'ACTA DE ENTREGA': (tipoActaUpper.includes('ENTREGA') || tipoActaUpper.includes('REGULARIZACION')) ? actaData.acta_n : NA,
                            'ACTA DE RETIRO': (tipoActaUpper.includes('RETIRO') || tipoActaUpper.includes('DEVOLUCION')) ? actaData.acta_n : NA,
                            'FECHA DE DESVINCULACION': NA,
                            'TECNICO': tecnicoSeleccionado.nombre || NA,
                            'LINK DE ACTA': linkDeActa,
                            'REGULARIZADA': tipoActaUpper.includes('REGULARIZACION') ? 'OK' : NA,
                            'MOTIVO DE CAMBIO': actaData.ticket || NA,
                            'Observaciones': [actaData.observaciones || '', ...observacionesPaquete].join('. ').trim()
                        };
                        dashboardRows.push(newRowData);
                    }

                    const result = await window.api.addActaToDashboard({
                        acta: actaData,
                        equipos: equipos,
                        dashboardRows: dashboardRows,
                        pdfPath: pdfResult.path
                    });

                    updateModalProgress(100, '¡Completado!');

                    if (result.success) {
                        hideModal();
                        showModal('Éxito', 'El acta ha sido finalizada y guardada correctamente.', [
                            { text: 'OK', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                            {
                                text: 'Ver Historial', class: 'bg-blue-600 hover:bg-blue-700', action: () => {
                                    hideModal();
                                    switchView('finalized-actas-view');
                                }
                            }
                        ]);
                        renderSavedActasList();
                        renderDashboardTable();
                        renderFinalizedActasDashboard();
                    } else {
                        hideModal();
                        showModal('Error', 'No se pudo guardar el acta en la base de datos: ' + result.message);
                    }
                } catch (error) {
                    hideModal();
                    console.error("Error finalizing acta:", error);
                    showModal('Error', 'Ocurrió un error al finalizar el acta.');
                }
            }
*/

            // CORRECCIÓN COMPLETA: Función reescrita para manejar filas por paquete y columnas dinámicas
            async function addActaToDashboard() {
                if (!validateForm()) return;

                showModal('Finalizando Acta...', 'Generando PDF y guardando datos, por favor espere.', [], 'progress');

                try {
                    // 1. Generar el PDF primero
                    const pdfResult = await generateAndSavePdfForFinalize();
                    if (!pdfResult.success) {
                        hideModal();
                        showModal('Error de PDF', `No se pudo generar el PDF: ${pdfResult.message}`);
                        return;
                    }
                    updateModalProgress(50, 'PDF generado. Procesando datos para el dashboard...');

                    // 2. Obtener todos los datos del formulario
                    const actaData = await getFormData();
                    const NA = 'NO APLICA';
                    const tipoActaUpper = actaData.tipo_acta.toUpperCase();
                    const tecnicoSeleccionado = tecnicos.find(t => t.cedula === actaData.tecnico_responsable) || { nombre: '', cedula: '' };
                    
                    // 3. Preparar las filas para el Dashboard (NUEVA LÓGICA)
                    const dashboardRows = [];
                    const tiposDeComputadora = ['PC', 'LAPTOP', 'IMAC', 'MAC STUDIO', 'MACBOOK', 'MACBOOKPRO', 'WORKSTATION'];
                    const paquetes = actaData.equipos.filter(e => tiposDeComputadora.includes((e.tipo || '').toUpperCase()));

                    // Si no hay computadoras, crear un "paquete virtual" para que los periféricos sueltos se listen
                    if (paquetes.length === 0) {
                        paquetes.push({ tipo: 'General', serie: 'NINGUNO' });
                    }

                    // 4. Iterar sobre cada paquete para crear una fila por cada uno
                    for (const paquete of paquetes) {
                        const esPaqueteVirtual = paquete.serie === 'NINGUNO';
                        
                        // Encontrar todos los periféricos para este paquete específico
                        const perifericos = esPaqueteVirtual
                            ? actaData.equipos.filter(p => !p.idPaquete && !tiposDeComputadora.includes(p.tipo.toUpperCase()))
                            : actaData.equipos.filter(p => p.idPaquete === paquete.serie);

                        // Clasificar periféricos
                        const monitors = perifericos.filter(e => (e.tipo || '').toUpperCase() === 'MONITOR');
                        const teclado = perifericos.find(e => (e.tipo || '').toUpperCase() === 'TECLADO');
                        const mouse = perifericos.find(e => (e.tipo || '').toUpperCase() === 'RATÓN' || (e.tipo || '').toUpperCase() === 'MOUSE');
                        const cargador = perifericos.find(e => (e.tipo || '').toUpperCase() === 'CARGADOR');
                        const mochila = perifericos.find(e => (e.tipo || '').toUpperCase() === 'MOCHILA');
                        
                        // Encontrar todos los demás activos que serán "extras"
                        const activosEstandar = ['MONITOR', 'TECLADO', 'RATÓN', 'MOUSE', 'CARGADOR', 'MOCHILA'];
                        const otrosActivos = perifericos.filter(e => !activosEstandar.includes((e.tipo || '').toUpperCase()));
                        
                        let componentesPaquete = esPaqueteVirtual ? [] : [paquete.tipo];
                        perifericos.forEach(p => componentesPaquete.push(p.tipo));

                        // Construir el objeto de la fila del dashboard
                        const newRowData = {
                            'No.': actaData.acta_n || NA,
                            'Hostname': esPaqueteVirtual ? (actaData.hostname || NA) : (paquete.hostname || actaData.hostname || NA),
                            'Modelo Consenso': esPaqueteVirtual ? NA : (paquete.desc || NA),
                            'Componentes': componentesPaquete.join(', ') || NA,
                            'Modelo MTM': esPaqueteVirtual ? NA : (paquete.mtm || NA),
                            'Tipo Monitor': monitors.length > 0 ? (monitors[0].desc || NA) : NA,
                            'Requiere Teclado y Mouse': (teclado && mouse) ? 'SI' : 'NO',
                            'LICENCIA MS365 E3': NA,
                            'CANDADO': NA,
                            'Detalle': actaData.tipo_acta.replace(' DE EQUIPOS', '') || NA,
                            'Nombre de usuario': actaData.usuario || NA,
                            'SERIE PC': esPaqueteVirtual ? NA : (paquete.serie || NA),
                            'SERIE MON': monitors.length > 0 ? (monitors[0].serie || NA) : NA,
                            'SERIE MON 2': monitors.length > 1 ? (monitors[1].serie || NA) : NA,
                            'Código de activo del equipo': esPaqueteVirtual ? NA : (paquete.codigo || NA),
                            'Código de activo del Monitor': monitors.length > 0 ? (monitors[0].codigo || NA) : NA,
                            'Código de activo del Monitor 2': monitors.length > 1 ? (monitors[1].codigo || NA) : NA,
                            'Código de activo del teclado': teclado ? (teclado.codigo || NA) : NA,
                            'Código de activo del Mouse': mouse ? (mouse.codigo || NA) : NA,
                            'Código de activo del Cargador': cargador ? (cargador.codigo || NA) : NA,
                            'Paquete': esPaqueteVirtual ? 'GENERAL' : (paquete.serie || NA),
                            'Activo Mochila': mochila ? 'SI' : NA,
                            // Llenar columnas de activos extra
                            'Activo Extra 1': otrosActivos.length > 0 ? `${otrosActivos[0].tipo}: ${otrosActivos[0].serie}` : NA,
                            'Activo Extra 2': otrosActivos.length > 1 ? `${otrosActivos[1].tipo}: ${otrosActivos[1].serie}` : NA,
                            'Activo Extra 3': otrosActivos.length > 2 ? `${otrosActivos[2].tipo}: ${otrosActivos[2].serie}` : NA,
                            'Activo Extra 4': otrosActivos.length > 3 ? `${otrosActivos[3].tipo}: ${otrosActivos[3].serie}` : NA,
                            'Activo Extra 5': otrosActivos.length > 4 ? `${otrosActivos[4].tipo}: ${otrosActivos[4].serie}` : NA,
                            'Nombre de usuario (duplicado)': actaData.usuario || NA,
                            'Colaborador': actaData.nombre || NA,
                            'Cédulas': actaData.cedula || NA,
                            'FECHA DE ENTREGA REAL': actaData.fecha ? new Date(actaData.fecha + 'T00:00:00').toLocaleDateString('es-ES') : NA,
                            'ACTA DE ENTREGA': (tipoActaUpper.includes('ENTREGA') || tipoActaUpper.includes('REGULARIZACION')) ? actaData.acta_n : NA,
                            'ACTA DE RETIRO': (tipoActaUpper.includes('RETIRO') || tipoActaUpper.includes('DEVOLUCION')) ? actaData.acta_n : NA,
                            'FECHA DE DESVINCULACION': NA,
                            'TECNICO': tecnicoSeleccionado.nombre || NA,
                            'LINK DE ACTA': `ACT - ${(tipoActaUpper.match(/[A-Z]{3}/) || ['GEN'])[0]} - ${actaData.nombre.replace(/\s+/g, '_').toUpperCase()} - ${paquete.serie || 'SIN_SERIE'} - ${new Date(actaData.fecha + 'T00:00:00').toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', year:'numeric'}).replace(/\//g,'')}`,
                            'REGULARIZADA': tipoActaUpper.includes('REGULARIZACION') ? 'OK' : NA,
                            'MOTIVO DE CAMBIO': actaData.ticket || NA,
                            'Observaciones': actaData.observaciones || ''
                        };
                        dashboardRows.push(newRowData);
                    }

                    // 5. Enviar los datos al backend
                    const result = await window.api.addActaToDashboard({
                        acta: actaData,
                        equipos: equipos,
                        dashboardRows: dashboardRows, // Enviamos el array de filas
                        pdfPath: pdfResult.path
                    });

                    updateModalProgress(100, '¡Completado!');

                    if (result.success) {
                        hideModal();
                        showModal('Éxito', 'El acta ha sido finalizada y guardada correctamente.', [
                            { text: 'OK', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                            { text: 'Ver Historial', class: 'bg-blue-600 hover:bg-blue-700', action: () => { hideModal(); switchView('finalized-actas-view'); } }
                        ]);
                        renderSavedActasList();
                        renderDashboardTable();
                        renderFinalizedActasDashboard();
                    } else {
                        hideModal();
                        showModal('Error', 'No se pudo guardar el acta en la base de datos: ' + result.message);
                    }
                } catch (error) {
                    hideModal();
                    console.error("Error finalizing acta:", error);
                    showModal('Error', 'Ocurrió un error al finalizar el acta.');
                }
            }
/////
/*
            async function exportDashboardToExcel(dashboardType) {
                const data = dashboardType === 'main' ? await window.api.getDashboardData() : await window.api.getAllAssetsData();
                const headers = dashboardType === 'main' ? dashboardHeaders : allAssetsHeaders;
                const filename = dashboardType === 'main' ? 'REGISTRO-FACTURACION' : 'ADMINISTRACION-ACTIVOS';

                if (!data || data.length === 0) {
                    showModal('Vacío', 'No hay datos en este dashboard para exportar.');
                    return;
                }

                const wb = XLSX.utils.book_new();
                const ws_name = 'Reporte';
                const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "1E40AF" } } };
                const ws = XLSX.utils.sheet_to_json(data, { header: headers });

                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (!ws[address]) continue;
                    ws[address].s = headerStyle;
                }

                ws['!cols'] = headers.map(() => ({ wch: 20 }));
                XLSX.utils.book_append_sheet(wb, ws, ws_name);
                XLSX.writeFile(wb, `${filename}.xlsx`);
            }
*/

            async function exportDashboardToExcel(dashboardType) {
                const data = dashboardType === 'main' ? await window.api.getDashboardData() : await window.api.getAllAssetsData();
                const headers = dashboardType === 'main' ? dashboardHeaders : allAssetsHeaders;
                const filename = dashboardType === 'main' ? 'REGISTRO-FACTURACION' : 'ADMINISTRACION-ACTIVOS';

                if (!data || data.length === 0) {
                    showModal('Tabla Vacía', 'No hay datos en este dashboard para exportar.');
                    return;
                }

                const dataAsArray = data.map(row => headers.map(header => row[header] || ''));
                const finalData = [headers, ...dataAsArray];
                const ws = XLSX.utils.aoa_to_sheet(finalData);

                // --- Definimos los estilos ---
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "1F774C" } }, // Verde oscuro
                    alignment: { vertical: "center", horizontal: "center" }
                };
                const todayRowStyle = {
                    fill: { fgColor: { rgb: "DDEBF7" } }, // Celeste pastel
                    border: {
                        top: { style: "thin", color: { auto: 1 } }, bottom: { style: "thin", color: { auto: 1 } },
                        left: { style: "thin", color: { auto: 1 } }, right: { style: "thin", color: { auto: 1 } }
                    }
                };
                const pastRowStyle = {
                    fill: { fgColor: { rgb: "F8DDDD" } }, // Rosado/Rojo pastel
                    border: {
                        top: { style: "thin", color: { auto: 1 } }, bottom: { style: "thin", color: { auto: 1 } },
                        left: { style: "thin", color: { auto: 1 } }, right: { style: "thin", color: { auto: 1 } }
                    }
                };

                // --- Lógica de comparación de fechas MEJORADA ---
                const range = XLSX.utils.decode_range(ws['!ref']);
                const today = new Date();
                const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const dateColumnIndex = headers.indexOf('FECHA DE ENTREGA REAL');

                for (let R = range.s.r; R <= range.e.r; ++R) {
                    let rowStyle = null; 
                    if (R > 0 && dateColumnIndex !== -1) {
                        const dateCellRef = XLSX.utils.encode_cell({ c: dateColumnIndex, r: R });
                        const cellValue = ws[dateCellRef] ? ws[dateCellRef].v : '';
                        
                        let cellDateString = '';
                        const parts = String(cellValue).split('/');
                        if (parts.length === 3) {
                            cellDateString = `${parts[2]}-${String(parts[1]).padStart(2, '0')}-${String(parts[0]).padStart(2, '0')}`;
                        }

                        if (cellDateString && cellDateString === todayString) {
                            rowStyle = todayRowStyle;
                        } else {
                            rowStyle = pastRowStyle;
                        }
                    }

                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                        if (!ws[cell_ref]) continue;

                        if (R === 0) {
                            ws[cell_ref].s = headerStyle;
                        } else if (rowStyle) {
                            ws[cell_ref].s = rowStyle;
                        }
                    }
                }

                ws['!cols'] = headers.map(() => ({ wch: 30 }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
                XLSX.writeFile(wb, `${filename}.xlsx`);
            }
            ///////*---------------------------------------------------------------------
            async function switchView(viewId) {
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');

                const buttons = {
                    'main-view': document.getElementById('nav-form-btn'),
                    'change-view': document.getElementById('nav-change-btn'),
                    'saved-actas-view': document.getElementById('nav-saved-actas-btn'),
                    'finalized-actas-view': document.getElementById('nav-finalized-actas-btn'),
                    'dashboard-view': document.getElementById('nav-dashboard-btn'),
                    'devolucion-view': document.getElementById('nav-devolucion-btn'),
                    'retirados-view': document.getElementById('nav-retirados-btn')
                };

                for (const id in buttons) {
                    if (buttons[id]) {
                        buttons[id].className = 'px-3 py-2 text-sm font-medium bg-white text-gray-700 rounded-md hover:bg-gray-50';
                    }
                }

                if (buttons[viewId]) {
                    buttons[viewId].className = 'px-3 py-2 text-sm font-medium bg-blue-600 text-white rounded-md';
                }

                if (viewId === 'saved-actas-view') await renderSavedActasDashboard();
                if (viewId === 'finalized-actas-view') await renderFinalizedActasDashboard();
                if (viewId === 'dashboard-view') await renderDashboardTable();
                if (viewId === 'retirados-view') await renderAllAssetsTable();
            }

            let nominaData = [];
            let activosData = [];
            let equipos = [];
            let equiposEntregados = []; // Nueva variable para activos entregados específicos
            let activosMantiene = []; // Nueva variable para activos que mantiene el usuario
            let editingEquipoId = null;
            //let currentDevolucionData = {};
            let fotosParaActa = [];
            let activosParaRetiro = []; // Nueva variable para retiros específicos
            let tipoRetiro = 'todos'; // 'todos' o 'especificos'
            let tipoEntrega = 'completo'; // 'completo' o 'activos'
            

            const tecnicos = [
                { cedula: '0705827525', nombre: 'CAROLINA VANESSA TORRES REYES', display: 'Carolina, Torres {EXT}' },
                { cedula: '0954130670', nombre: 'DANIEL ALFREDO DECKER DIAZ', display: 'Daniel, Decker {EXT}' },
                { cedula: '0107174765', nombre: 'PEDRO JOSE RENGEL RIVERA', display: 'Pedro, Rengel {EXT}' },
                { cedula: '0104774047', nombre: 'EDGAR FERNANDO MORA BERMEO', display: 'Edgar, Mora {EXT}' },
                { cedula: '1314937093', nombre: 'HERNAN ALEXANDER CEDEÑO QUIJIJE', display: 'Hernan, Cedeño {EXT}' },
                { cedula: '0105949598', nombre: 'JONNATHAN JAVIER RODRIGUEZ SARMIENTO', display: 'Javier, Rodriguez {EXT}' },
                { cedula: '2200235998', nombre: 'JHONATAN ALEXANDER JIMENEZ SUAREZ', display: 'Jhonatan, Jimenez {EXT}' },
                { cedula: '550014427', nombre: 'JOSE ALEXIS CHACON ESTRELLA', display: 'Jose, Chacon {EXT}' },
                { cedula: '0107154270', nombre: 'KEVIN ALFREDO CHILLOGALLO CAMPOVERDE', display: 'Kevin, Chillogallo {EXT}' },
                { cedula: '09512555479', nombre: 'KEVIN JOEL GUERRERO OBANDO', display: 'Kevin,Guerrero {EXT}' },
                { cedula: '1723453518', nombre: 'PATRICIO ANDY TIPAN CHAPACA', display: 'Patricio, Tipan {EXT}' },
                { cedula: '0105401822', nombre: 'WILMER JOHN DURAZNO ZAPATANGA', display: 'Wilmer, Durazno {EXT}' },
                { cedula: '0803832245', nombre: 'WILSON ANTONIO ORELLANA MONTESDEOCA', display: 'Wilson, Orellana {EXT}' },
                { cedula: '0106729411', nombre: 'CHRISTIAN SALOMON PICO BUENO', display: 'Christian, Pico {EXT}' },
                { cedula: '0105401996', nombre: 'PABLO FERNANDO GUAMAN NOVILLO', display: 'Pablo, Guaman {EXT}' }
            ];

            const observabilidadUsers = [
                { nombre: 'BRUNO SEBASTIAN PESANTEZ TAPIA', cedula: '0107794745' },
                { nombre: 'VANESSA ALEXANDRA QUILLE QUEZADA', cedula: '0106053697' },
                { nombre: 'HENRY EMANUEL SAQUINAULA QUINDE', cedula: '0104367099' }
            ];

            const tipoOptions = ['PC', 'LAPTOP L14', 'LAPTOP P16V', 'LAPTOP YOGA', 'MONITOR', 'TECLADO', 'RATÓN', 'CARGADOR', 'MOCHILA', 'OTRO'];
            const marcaOptions = [
                'LENOVO',
                'APPLE',
                'HP',
                'DELL',
                'ASUS',
                'ACER',
                'NA',  // Valor común del Excel
                'OTRO'
            ];
            const descOptions = ['THINKCENTRE M70Q GEN 4', 'THINKPAD L14 GEN 4', 'THINKPAD P16 GEN 2', 'THINKPAD X1 YOGA GEN 8', 'CARGADOR M70Q', 'CARGADOR YOGA X1 ', 'CARGADOR L14', 'CARGADOR P16', 'ESSENTIAL KEYBOARD', 'ESSENTIAL MOUSE', 'THINKVISION E20-30', 'THINKVISION C22E-20', 'MOCHILA B210 BLACK (ECO)', 'OTRO'];
            const estadoOptions = ['', 'NUEVO', 'REASIGNADO', 'RETIRADO', 'REGULARIZADO'];
            const ubicacionOptions = ['', 'CARDECA', 'MARCIMEX', 'MERCANDINA', 'SERINCO', 'INDURAMA', 'TARPUQ', 'MP3', 'ENSAFRANCE', 'CYBER SURE', 'HOSPITAL HUMANITARIO', 'SERVIHOGAR', 'CYBER SUR'];
            const empresaOptions = ['', 'CAR SOUNDVISION', 'ENSAFRANCE', 'Hospital HUMANITARIO', 'INDURAMA', 'MARCIMEX', 'MERCANDINA', 'SERINCO', 'SERVIANDINA', 'SERVI HOGAR', 'TARPUQ'];
            const domainOptions = ['consensocorp.com', 'marcimex.com.ec', 'indurama.com', 'mercandina.com', 'otro'];

            const form = document.getElementById('acta-form');
            const previewContent = document.getElementById('acta-preview-content');
            const excelFileInput = document.getElementById('excel-file');
            const excelSearchInput = document.getElementById('excel-search-input');
            const excelSearchBtn = document.getElementById('excel-search-btn');
            const adSearchInput = document.getElementById('ad-search-input');
            const adSearchBtn = document.getElementById('ad-search-btn');
            const clearBtn = document.getElementById('clear-btn');
            const equipmentFormContainer = document.getElementById('equipment-form-container');
            const toggleManualFormBtn = document.getElementById('toggle-manual-form');

            const entregaPanel = document.getElementById('entrega-panel');
            const entregaCompletoRadio = document.getElementById('entrega_completo');
            const entregaActivosRadio = document.getElementById('entrega_activos');
            const equiposEntregadosSection = document.getElementById('equipos-entregados-section');
            const equiposEntregadosBody = document.getElementById('equipos-entregados-body');
            const activosMantienesSection = document.getElementById('activos-mantiene-section');
            const activosMantienesBody = document.getElementById('activos-mantiene-body');

            const eqForm = {
                tipo: document.getElementById('eq_tipo'),
                tipo_manual: document.getElementById('eq_tipo_manual'),
                marca: document.getElementById('eq_marca'),
                marca_manual: document.getElementById('eq_marca_manual'),
                desc: document.getElementById('eq_desc'),
                desc_manual: document.getElementById('eq_desc_manual'),
                mtm: document.getElementById('eq_mtm'),
                serie: document.getElementById('eq_serie'),
                estado: document.getElementById('eq_estado'),
                codigo: document.getElementById('eq_codigo'),
                btn: document.getElementById('add-update-equipo-btn')
            };
            const listaEquiposBody = document.getElementById('lista-equipos-body');

            const firmarJefaturaCheck = document.getElementById('firmar_jefatura');
            const jefaturaFirmaContainer = document.getElementById('jefatura-firma-container');

            const allFormInputIds = ['tipo_acta', 'acta_n', 'fecha', 'tecnico_responsable', 'usuario', 'nombre', 'cedula', 'ciudad', 'ubicacion', 'empresa', 'departamento', 'zona', 'hostname', 'jefatura', 'ticket', 'observaciones', 'jefatura_nombre', 'jefatura_cedula'];

            const correoUsuarioInput = document.getElementById('correo_usuario');
            const correoDominioSelect = document.getElementById('correo_dominio_select');
            const correoDominioManual = document.getElementById('correo_dominio_manual');

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const modalProgressContainer = document.getElementById('modal-progress-container');
            const modalProgressBar = document.getElementById('modal-progress-bar');
            const modalProgressText = document.getElementById('modal-progress-text');

            const preguardarBtn = document.getElementById('preguardar-btn');
            const listaActasGuardadas = document.getElementById('lista-actas-guardadas');
            const salidaPersonalCheck = document.getElementById('salida_personal_check');
            const observacionesTextarea = document.getElementById('observaciones');
            const draftsSearchInput = document.getElementById('drafts-search-input');

            // Elementos del panel de retiro
            const retiroPanel = document.getElementById('retiro-panel');
            const retiroTodosRadio = document.getElementById('retiro_todos');
            const retiroEspecificosRadio = document.getElementById('retiro_especificos');
            const retiroActivosList = document.getElementById('retiro-activos-list');
            const retiroActivosBody = document.getElementById('retiro-activos-body');

            // Elementos para AD con credenciales
            const adCredentialsPanel = document.getElementById('ad-credentials-panel');
            const adUsernameInput = document.getElementById('ad-username');
            const adPasswordInput = document.getElementById('ad-password');
            const adAuthenticateBtn = document.getElementById('ad-authenticate-btn');
            const adCancelBtn = document.getElementById('ad-cancel-btn');
            const adSearchSpinner = document.getElementById('ad-search-spinner');
            const adSearchText = document.getElementById('ad-search-text');

            // Variables para cambios
            let change_assignedEquipos = [];
            let change_addedEquipos = [];
            let change_currentUserData = null;
            let change_assignedCurrentPage = 1;
            const CHANGE_ITEMS_PER_PAGE = 15;
            let change_assignedSearchTerm = '';
            let change_fotosEntregado = [];
            let change_fotosRetirado = [];

            const changeExcelSearchBtn = document.getElementById('change-excel-search-btn');
            const changeExcelSearchInput = document.getElementById('change-excel-search-input');
            const changeContractDataContainer = document.getElementById('change-contract-data');
            const changeAssignedList = document.getElementById('change-assigned-list');
            const changeAddedList = document.getElementById('change-added-list');
            const changeAddEquipoBtn = document.getElementById('change-add-equipo-btn');
            const changePreviewContent = document.getElementById('change-preview-content');
            const generateChangePdfBtn = document.getElementById('generate-change-pdf');
            const changeAssignedSearchInput = document.getElementById('change-assigned-search');
            const changePrevPageBtn = document.getElementById('change-prev-page');
            const changeNextPageBtn = document.getElementById('change-next-page');
            const changePageInfo = document.getElementById('change-page-info');
            const preguardarChangeBtn = document.getElementById('preguardar-change-btn');
            const clearChangeBtn = document.getElementById('clear-change-btn');

            const changeRetiredDisplayList = document.getElementById('change-retired-display-list');
            const changeMaintainedList = document.getElementById('change-maintained-list');

            const changeEqForm = {
                tipo: document.getElementById('change-eq_tipo'),
                tipo_manual: document.getElementById('change-eq_tipo_manual'),
                marca: document.getElementById('change-eq_marca'),
                desc: document.getElementById('change-eq_desc'),
                mtm: document.getElementById('change-eq_mtm'),
                serie: document.getElementById('change-eq_serie'),
                estado: document.getElementById('change-eq_estado'),
                codigo: document.getElementById('change-eq_codigo'),
                btn: document.getElementById('change-add-equipo-btn')
            };

            // Funciones para el tipo de entrega
            function toggleEntregaPanel() {
                const tipoActa = document.getElementById('tipo_acta').value;
                if (tipoActa === 'ENTREGA DE EQUIPOS') {
                    entregaPanel.classList.remove('hidden');
                } else {
                    entregaPanel.classList.add('hidden');
                    resetEntregaPanel();
                }
            }

            function resetEntregaPanel() {
                entregaCompletoRadio.checked = true;
                entregaActivosRadio.checked = false;
                tipoEntrega = 'completo';
                equiposEntregadosSection.classList.add('hidden');
                activosMantienesSection.classList.add('hidden');
                equiposEntregados = [];
                activosMantiene = [];
                renderEquiposEntregados();
                renderActivosMantiene();
            }

            function renderEquiposEntregados() {
                equiposEntregadosBody.innerHTML = '';
                equiposEntregados.forEach(eq => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                       <td class="px-4 py-2 whitespace-nowrap">${eq.tipo || ''}</td>
                       <td class="px-4 py-2 whitespace-nowrap">${eq.marca || ''}</td>
                       <td class="px-4 py-2 whitespace-nowrap">${eq.serie || ''}</td>
                       <td class="px-2 py-2 whitespace-nowrap text-center"><input type="checkbox" class="dano-check h-4 w-4 text-indigo-600 border-gray-300 rounded" data-id="${eq.id}" ${eq.dano ? 'checked' : ''}></td>
                       <td class="px-2 py-2 whitespace-nowrap text-center"><input type="checkbox" class="faltante-check h-4 w-4 text-red-600 border-gray-300 rounded" data-id="${eq.id}" ${eq.faltante ? 'checked' : ''}></td>
                       <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                           <button type="button" class="text-indigo-600 hover:text-indigo-900 edit-btn" data-id="${eq.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                   <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                   <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                               </svg>
                           </button>
                           <button type="button" class="text-red-600 hover:text-red-900 ml-4 delete-btn" data-id="${eq.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                   <polyline points="3 6 5 6 21 6"></polyline>
                                   <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                   <line x1="10" y1="11" x2="10" y2="17"></line>
                                   <line x1="14" y1="11" x2="14" y2="17"></line>
                               </svg>
                           </button>
                       </td>`;
                    equiposEntregadosBody.appendChild(row);
                });
                updatePreview();
            }

            function renderActivosMantiene() {
                activosMantienesBody.innerHTML = '';
                activosMantiene.forEach(eq => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                       <td class="px-4 py-2 whitespace-nowrap">${eq.tipo || ''}</td>
                       <td class="px-4 py-2 whitespace-nowrap">${eq.marca || ''}</td>
                       <td class="px-4 py-2 whitespace-nowrap">${eq.serie || ''}</td>
                       <td class="px-4 py-2 whitespace-nowrap">${eq.codigo || ''}</td>`;
                    activosMantienesBody.appendChild(row);
                });
            }

            // Event listeners para tipo de entrega
            entregaCompletoRadio.addEventListener('change', () => {
                if (entregaCompletoRadio.checked) {
                    tipoEntrega = 'completo';
                    equiposEntregadosSection.classList.add('hidden');
                    activosMantienesSection.classList.add('hidden');
                    updatePreview();
                }
            });

            entregaActivosRadio.addEventListener('change', () => {
                if (entregaActivosRadio.checked) {
                    tipoEntrega = 'activos';
                    equiposEntregadosSection.classList.remove('hidden');
                    activosMantienesSection.classList.remove('hidden');

                    // Mover equipos existentes a "activosMantiene" si no están ya ahí
                    if (activosMantiene.length === 0 && equipos.length > 0) {
                        activosMantiene = [...equipos];
                        renderActivosMantiene();
                    }
                    updatePreview();
                }
            });

            // CORRECCIÓN: Funciones de AD actualizadas
            /*
            adSearchBtn.addEventListener('click', () => {
                const searchTerm = adSearchInput.value.trim();
                if (!searchTerm) {
                    showModal('Atención', 'Por favor, ingrese un nombre de usuario o cédula para buscar.');
                    return;
                }

                // Mostrar panel de credenciales
                adCredentialsPanel.classList.remove('hidden');
                adUsernameInput.focus();
            });
*/

/*
            adSearchBtn.addEventListener('click', async () => {
                const searchTerm = adSearchInput.value.trim();
                if (!searchTerm) {
                    showModal('Atención', 'Por favor, ingrese un nombre de usuario o cédula para buscar.');
                    return;
                }
                if (activosData.length === 0) {
                    showModal('Atención', 'Por favor, cargue primero el archivo de Excel para poder buscar los activos del usuario.');
                    return;
                }
                showLoader();

                // Mostrar spinner de carga
                adSearchText.textContent = 'Buscando...';
                adSearchSpinner.classList.remove('hidden');
                adSearchBtn.disabled = true;

                try {
                    // Intenta buscar usando la sesión
                    //const result = await window.api.searchAdReal({ searchTerm: searchTerm });
                    const result = await window.api.searchAdReal({ searchTerm });

                    if (result.success && result.user) {
                        // Éxito: Procesa los datos del usuario como ya lo hacías
                        const userData = result.user;
                        clearFormFields(false);

                        const nombreAD = userData.cn || '';
                        const cedulaAD = normalizeCedula(userData.description);

                        document.getElementById('nombre').value = nombreAD;
                        document.getElementById('cedula').value = cedulaAD;
                        document.getElementById('departamento').value = userData.department || '';
                        document.getElementById('usuario').value = userData.sAMAccountName || '';
                        document.getElementById('ciudad').value = userData.l || '';
                        document.getElementById('empresa').value = userData.company || '';

                        const userEmail = userData.mail || '';
                        if (userEmail.includes('@')) {
                            const [user, domain] = userEmail.split('@');
                            correoUsuarioInput.value = user;
                            if (domainOptions.includes(domain)) {
                                correoDominioSelect.value = domain;
                            } else {
                                correoDominioSelect.value = 'otro';
                                correoDominioManual.value = domain;
                            }
                            correoDominioSelect.dispatchEvent(new Event('change'));
                        }
                        //////
                        //showModal('Éxito', `Datos de ${nombreAD} cargados desde AD.`);

                        let todosLosActivosDelUsuario = [];
                        if (cedulaAD) {
                            todosLosActivosDelUsuario = activosData.filter(asset =>
                                normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula')) === cedulaAD
                            );
                        } else if (nombreAD) {
                            todosLosActivosDelUsuario = activosData.filter(asset =>
                                String(getSafeProp(asset, 'Colaborador') || '').trim().toUpperCase() === nombreAD.toUpperCase()
                            );
                        }

                        equipos = [];
                        if (todosLosActivosDelUsuario.length > 0) {
                            const extractSerial = (value) => {
                                if (!value || typeof value !== 'string') return '';
                                if (value.toUpperCase().startsWith('CA-')) {
                                    const tjIndex = value.toUpperCase().indexOf('TJ');
                                    if (tjIndex !== -1) return value.substring(tjIndex + 2);
                                }
                                const parts = value.split('-');
                                return parts[parts.length - 1];
                            };

                            todosLosActivosDelUsuario.forEach(asset => {
                                const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                                if (componente === 'PC' || componente === 'NOTEBOOK' || componente === 'LAPTOP') {
                                    equipos.push({ id: Math.random(), tipo: (componente === 'NOTEBOOK' || componente === 'LAPTOP') ? 'LAPTOP' : 'PC', marca: getSafeProp(asset, 'MARCA'), desc: getSafeProp(asset, 'Modelo Consenso'), mtm: getSafeProp(asset, 'Modelo MTM'), serie: getSafeProp(asset, 'SERIE PC'), codigo: getSafeProp(asset, 'Código de activo del equipo'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR')) {
                                    equipos.push({ id: Math.random(), tipo: 'MONITOR', marca: 'NA', desc: getSafeProp(asset, 'Tipo Monitor'), mtm: 'NA', serie: getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR'), codigo: getSafeProp(asset, 'Código de activo del Monitor'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'Código de activo del teclado')) {
                                    equipos.push({ id: Math.random(), tipo: 'TECLADO', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')), codigo: getSafeProp(asset, 'Código de activo del teclado'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'Código de activo del Mouse')) {
                                    equipos.push({ id: Math.random(), tipo: 'RATÓN', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')), codigo: getSafeProp(asset, 'Código de activo del Mouse'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'Código de activo del Cargador')) {
                                    equipos.push({ id: Math.random(), tipo: 'CARGADOR', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')), codigo: getSafeProp(asset, 'Código de activo del Cargador'), estado: '', dano: false, faltante: false });
                                }
                            });
                            showModal('Éxito', `Datos de ${nombreAD} cargados desde AD. Se encontraron ${equipos.length} activos asociados.`);
                        } else {
                            showModal('Éxito', `Datos de ${nombreAD} cargados desde AD, pero no se encontraron activos en el archivo Excel.`);
                        }

                        //////**********
                        renderEquiposList(); // Asegúrate de que esta lógica siga aquí
                        updatePreview();

                    } else if (result.reason === 'NEEDS_CREDENTIALS') {
                        // El backend necesita credenciales, ahora mostramos el panel
                        showModal('Autenticación Requerida', result.message || 'Por favor, ingrese sus credenciales de red para continuar.', [{ text: 'OK', action: hideModal }]);
                        adCredentialsPanel.classList.remove('hidden');
                        adUsernameInput.focus();
                    } else {
                        // Hubo otro tipo de error
                        showModal('Error de Búsqueda', result.message || 'No se pudo encontrar al usuario.');
                    }
                } catch (error) {
                    console.error('Error en búsqueda AD:', error);
                    showModal('Error', 'Error al conectar con el Directorio Activo: ' + error.message);
                } finally {
                    // Restaurar botón de búsqueda
                    adSearchText.textContent = 'Buscar en AD';
                    adSearchSpinner.classList.add('hidden');
                    adSearchBtn.disabled = false;
                }
            });
*/
/*
            adSearchBtn.addEventListener('click', async () => {
                const searchTerm = adSearchInput.value.trim();
                if (!searchTerm) {
                    showModal('Atención', 'Por favor, ingrese un término de búsqueda.');
                    return;
                }
                if (activosData.length === 0) {
                    showModal('Atención', 'Por favor, cargue primero el archivo de Excel para poder buscar los activos del usuario.');
                    return;
                }

                showLoader();
                adSearchText.textContent = 'Buscando...';
                adSearchSpinner.classList.remove('hidden');
                adSearchBtn.disabled = true;

                try {
                    // 1. Intenta buscar directamente en el Directorio Activo
                    const result = await window.api.searchAdReal({ searchTerm });

                    if (result.success && result.user) {
                        // 2. ¡ÉXITO! Ahora usamos los datos de AD para llenar el formulario Y BUSCAR EN EL EXCEL.
                        const userData = result.user;
                        clearFormFields(false); // Limpia el formulario

                        // Llenar datos personales del formulario
                        const nombreAD = userData.cn || '';
                        const cedulaAD = normalizeCedula(userData.description);
                        document.getElementById('nombre').value = nombreAD;
                        document.getElementById('cedula').value = cedulaAD;
                        document.getElementById('departamento').value = userData.department || '';
                        document.getElementById('usuario').value = userData.sAMAccountName || '';
                        document.getElementById('ciudad').value = userData.l || '';
                        document.getElementById('empresa').value = userData.company || '';

                        const userEmail = userData.mail || '';
                        if (userEmail.includes('@')) {
                            const [user, domain] = userEmail.split('@');
                            correoUsuarioInput.value = user;
                            if (domainOptions.includes(domain)) {
                                correoDominioSelect.value = domain;
                            } else {
                                correoDominioSelect.value = 'otro';
                                correoDominioManual.value = domain;
                            }
                            correoDominioSelect.dispatchEvent(new Event('change'));
                        }

                        // --- Lógica para buscar los activos en el archivo de facturación ---
                        let todosLosActivosDelUsuario = [];
                        if (cedulaAD) {
                            todosLosActivosDelUsuario = activosData.filter(asset =>
                                normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula')) === cedulaAD
                            );
                        }

                        equipos = []; // Limpia la lista de equipos anterior
                        if (todosLosActivosDelUsuario.length > 0) {
                            const extractSerial = (value) => {
                                if (!value || typeof value !== 'string') return '';
                                if (value.toUpperCase().startsWith('CA-')) {
                                    const tjIndex = value.toUpperCase().indexOf('TJ');
                                    if (tjIndex !== -1) return value.substring(tjIndex + 2);
                                }
                                const parts = value.split('-');
                                return parts[parts.length - 1];
                            };

                            todosLosActivosDelUsuario.forEach(asset => {
                                const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                                if (componente === 'PC' || componente === 'NOTEBOOK' || componente === 'LAPTOP') {
                                    equipos.push({ id: Math.random(), tipo: (componente === 'NOTEBOOK' || componente === 'LAPTOP') ? 'LAPTOP' : 'PC', marca: getSafeProp(asset, 'MARCA'), desc: getSafeProp(asset, 'Modelo Consenso'), mtm: getSafeProp(asset, 'Modelo MTM'), serie: getSafeProp(asset, 'SERIE PC'), codigo: getSafeProp(asset, 'Código de activo del equipo'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR')) {
                                    equipos.push({ id: Math.random(), tipo: 'MONITOR', marca: 'NA', desc: getSafeProp(asset, 'Tipo Monitor'), mtm: 'NA', serie: getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR'), codigo: getSafeProp(asset, 'Código de activo del Monitor'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'Código de activo del teclado')) {
                                    equipos.push({ id: Math.random(), tipo: 'TECLADO', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')), codigo: getSafeProp(asset, 'Código de activo del teclado'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'Código de activo del Mouse')) {
                                    equipos.push({ id: Math.random(), tipo: 'RATÓN', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')), codigo: getSafeProp(asset, 'Código de activo del Mouse'), estado: '', dano: false, faltante: false });
                                }
                                if (getSafeProp(asset, 'Código de activo del Cargador')) {
                                    equipos.push({ id: Math.random(), tipo: 'CARGADOR', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')), codigo: getSafeProp(asset, 'Código de activo del Cargador'), estado: '', dano: false, faltante: false });
                                }
                                // ... (y así con el resto de tus activos: Mouse, Cargador, etc.)
                            });
                            //showModal('Éxito', `Datos de ${nombreAD} cargados desde AD. Se encontraron ${equipos.length} activos asociados.`);
                            showSuccessModal(
                                '¡Datos Cargados Exitosamente!',
                                nombreAD,
                                'Active Directory (AD)',
                                equipos.length
                            );
                        } else {
                            //showModal('Éxito', `Datos de ${nombreAD} cargados desde AD, pero no se encontraron activos en el archivo Excel.`);
                            showSuccessModal(
                                '¡Datos Cargados Exitosamente!',
                                nombreAD,
                                'Active Directory (AD)',
                                0 // Indicamos que se encontraron 0 activos
                            );
                        }

                        renderEquiposList();
                        updatePreview();

                    } else if (result.reason === 'NEEDS_CREDENTIALS') {
                        // 3. Si necesita credenciales, AHORA SÍ muestra la ventana emergente.
                        showModal('Autenticación Requerida', result.message || 'Por favor, ingrese sus credenciales de red.');
                        adCredentialsPanel.classList.remove('hidden');
                        adUsernameInput.focus();
                    } else {
                        // 4. Hubo otro tipo de error
                        showModal('Error de Búsqueda', result.message || 'No se pudo encontrar al usuario.');
                    }
                } catch (error) {
                    console.error('Error en búsqueda AD:', error);
                    showModal('Error', 'Error al conectar con el Directorio Activo: ' + error.message);
                } finally {
                    // 5. Restaura el botón de búsqueda
                    hideLoader();
                    adSearchText.textContent = 'Buscar en AD';
                    adSearchSpinner.classList.add('hidden');
                    adSearchBtn.disabled = false;
                }
            });

            adSearchBtn.addEventListener('click', async () => {
                const searchTerm = adSearchInput.value.trim();
                if (!searchTerm) {
                    showModal('Atención', 'Por favor, ingrese un término de búsqueda.');
                    return;
                }
                if (activosData.length === 0) {
                    showModal('Atención', 'Por favor, cargue primero el archivo de Excel.');
                    return;
                }

                showLoader();
                adSearchText.textContent = 'Buscando...';
                adSearchSpinner.classList.remove('hidden');
                adSearchBtn.disabled = true;

                try {
                    const result = await window.api.searchAdReal({ searchTerm });

                    if (result.success && result.user) {
                        clearFormFields(false);
                        const userData = result.user;
                        populateFormWithUserData(userData, true);

                        const cedulaAD = normalizeCedula(userData.description);
                        const todosLosActivosDelUsuario = activosData.filter(asset =>
                            normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula')) === cedulaAD
                        );
                        
                        equipos = extractEquiposFromAssets(todosLosActivosDelUsuario);
                        renderEquiposList();
                        updatePreview();

                        showSuccessModal(
                            '¡Datos Cargados Exitosamente!',
                            userData.cn || 'N/A',
                            'Active Directory (AD)',
                            equipos.length
                        );

                    } else if (result.reason === 'NEEDS_CREDENTIALS') {
                        showModal('Autenticación Requerida', result.message || 'Por favor, ingrese sus credenciales de red.');
                        adCredentialsPanel.classList.remove('hidden');
                        adUsernameInput.focus();
                    } else {
                        showModal('Error de Búsqueda', result.message || 'No se pudo encontrar al usuario.');
                    }
                } catch (error) {
                    console.error('Error en búsqueda AD:', error);
                    showModal('Error', 'Error al conectar con el Directorio Activo: ' + error.message);
                } finally {
                    hideLoader();
                    adSearchText.textContent = 'Buscar en AD';
                    adSearchSpinner.classList.add('hidden');
                    adSearchBtn.disabled = false;
                }
            });
*/
            // ✅ REEMPLAZA LO ANTERIOR CON ESTO
            adSearchBtn.addEventListener('click', async () => {
                const searchTerm = adSearchInput.value.trim();
                if (!searchTerm) {
                    showModal('Atención', 'Por favor, ingrese un término de búsqueda.');
                    return;
                }
                if (activosData.length === 0) {
                    showModal('Atención', 'Por favor, cargue primero el archivo de Excel.');
                    return;
                }

                showLoader();
                try {
                    const result = await window.api.searchAdReal({ searchTerm });

                    if (result.success) {
                        clearFormFields(false);
                        populateFormWithUserData(result.user, true);
                        
                        
                        const cedulaAD = normalizeCedula(result.user.description);
                        const todosLosActivos = activosData.filter(asset => normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula')) === cedulaAD);
                        
                        if (todosLosActivos.length === 0) {
                            // Si no se encuentran activos, mostramos un mensaje específico y útil
                            Swal.fire({
                                icon: 'warning',
                                title: 'Usuario Encontrado, pero sin Activos',
                                html: `Se encontraron los datos de <b>${result.user.cn}</b> en el Directorio Activo.<br><br>Sin embargo, no se encontraron activos en el archivo Excel para la cédula: <b>${cedulaAD}</b>.<br><br><u>Por favor, verifica que la cédula en el Excel sea correcta.</u>`,
                                confirmButtonText: 'Entendido'
                            });
                            equipos = []; // Vaciamos la lista de equipos por si acaso
                        } else {
                            // Si sí se encontraron activos, procedemos como antes
                            equipos = extractEquiposFromAssets(todosLosActivos);
                            showSuccessModal('¡Datos Cargados!', result.user.cn, 'Active Directory (AD)', equipos.length);
                        }

                        //equipos = extractEquiposFromAssets(todosLosActivos);
                        renderEquiposList();
                        updatePreview();
                        
                        //showSuccessModal('¡Datos Cargados!', result.user.cn, 'Active Directory (AD)', equipos.length);

                    } else if (result.reason === 'NEEDS_CREDENTIALS') {
                        //showModal('Autenticación Requerida', result.message || 'Por favor, ingrese sus credenciales de red.');
                        adCredentialsPanel.classList.remove('hidden');
                        adUsernameInput.focus();
                    } else {
                        showModal('Error de Búsqueda', result.message);
                    }
                } catch (error) {
                    showModal('Error Crítico', 'Error en la comunicxación: ' + error.message);
                } finally {
                    hideLoader();
                }
            });
            //---------------------------------------------------------------------------------------------------------------------------------
            adCancelBtn.addEventListener('click', () => {
                adCredentialsPanel.classList.add('hidden');
                adUsernameInput.value = '';
                adPasswordInput.value = '';
            });
/*
            adAuthenticateBtn.addEventListener('click', async () => {
                const searchTerm = adSearchInput.value.trim();
                const username = adUsernameInput.value.trim();
                const password = adPasswordInput.value.trim();

                if (!username || !password) {
                    showModal('Atención', 'Por favor, complete usuario y contraseña.');
                    return;
                }

                if (activosData.length === 0) {
                    showModal('Atención', 'Por favor, cargue primero el archivo de Excel para poder buscar los activos del usuario.');
                    return;
                }

                // Mostrar spinner de carga
                adSearchText.textContent = 'Buscando...';
                adSearchSpinner.classList.remove('hidden');
                adAuthenticateBtn.innerHTML = 'Autenticando...';
                adAuthenticateBtn.disabled = true;

                try {
                    const fullUsername = username + '@consensocorp.com';
                    const setResult = await window.api.setAdCredentials({ username: fullUsername, password: password });
                    if (setResult.success) {
                        adCredentialsPanel.classList.add('hidden');
                        // Le pedimos al botón principal que haga todo el trabajo de nuevo
                        adSearchBtn.click();
                    } else {
                        showModal('Error', 'No se pudieron guardar las credenciales.');
                    }
                    //const result = await window.api.searchAdWithCredentials({
                    const result = await window.api.searchAdReal({
                        searchTerm: searchTerm,
                        username: fullUsername,
                        password: password
                    });

                    if (result.success && result.user) {
                        const userData = result.user;
                        clearFormFields(false);

                        const nombreAD = userData.cn || '';
                        const cedulaAD = normalizeCedula(userData.description);

                        document.getElementById('nombre').value = nombreAD;
                        document.getElementById('cedula').value = cedulaAD;
                        document.getElementById('departamento').value = userData.department || '';
                        document.getElementById('usuario').value = userData.sAMAccountName || '';
                        document.getElementById('ciudad').value = userData.l || '';
                        document.getElementById('empresa').value = userData.company || '';

                        const userEmail = userData.mail || '';
                        if (userEmail.includes('@')) {
                            const [user, domain] = userEmail.split('@');
                            correoUsuarioInput.value = user;
                            if (domainOptions.includes(domain)) {
                                correoDominioSelect.value = domain;
                            } else {
                                correoDominioSelect.value = 'otro';
                                correoDominioManual.value = domain;
                            }
                            correoDominioSelect.dispatchEvent(new Event('change'));
                        }

                        // Buscar activos del usuario
                        let todosLosActivosDelUsuario = [];
                        if (cedulaAD) {
                            todosLosActivosDelUsuario = activosData.filter(asset =>
                                normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula')) === cedulaAD
                            );
                        } else if (nombreAD) {
                            todosLosActivosDelUsuario = activosData.filter(asset =>
                                String(getSafeProp(asset, 'Colaborador') || '').trim().toUpperCase() === nombreAD.toUpperCase()
                            );
                        }

                        equipos = [];
                        if (todosLosActivosDelUsuario.length > 0) {
                            const extractSerial = (value) => {
                                if (!value || typeof value !== 'string') return '';
                                if (value.toUpperCase().startsWith('CA-')) {
                                    const tjIndex = value.toUpperCase().indexOf('TJ');
                                    if (tjIndex !== -1) return value.substring(tjIndex + 2);
                                }
                                const parts = value.split('-');
                                return parts[parts.length - 1];
                            };

                            todosLosActivosDelUsuario.forEach(asset => {
                                const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                                if (componente === 'PC' || componente === 'NOTEBOOK' || componente === 'LAPTOP') {
                                    equipos.push({
                                        id: Math.random(),
                                        tipo: (componente === 'NOTEBOOK' || componente === 'LAPTOP') ? 'LAPTOP' : 'PC',
                                        marca: getSafeProp(asset, 'MARCA'),
                                        desc: getSafeProp(asset, 'Modelo Consenso'),
                                        mtm: getSafeProp(asset, 'Modelo MTM'),
                                        serie: getSafeProp(asset, 'SERIE PC'),
                                        codigo: getSafeProp(asset, 'Código de activo del equipo'),
                                        estado: '',
                                        dano: false,
                                        faltante: false
                                    });
                                }
                                if (getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR')) {
                                    equipos.push({
                                        id: Math.random(),
                                        tipo: 'MONITOR',
                                        marca: 'NA',
                                        desc: getSafeProp(asset, 'Tipo Monitor'),
                                        mtm: 'NA',
                                        serie: getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR'),
                                        codigo: getSafeProp(asset, 'Código de activo del Monitor'),
                                        estado: '',
                                        dano: false,
                                        faltante: false
                                    });
                                }
                                if (getSafeProp(asset, 'Código de activo del teclado')) {
                                    equipos.push({
                                        id: Math.random(),
                                        tipo: 'TECLADO',
                                        marca: 'NA',
                                        desc: '',
                                        mtm: 'NA',
                                        serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')),
                                        codigo: getSafeProp(asset, 'Código de activo del teclado'),
                                        estado: '',
                                        dano: false,
                                        faltante: false
                                    });
                                }
                                if (getSafeProp(asset, 'Código de activo del Mouse')) {
                                    equipos.push({
                                        id: Math.random(),
                                        tipo: 'RATÓN',
                                        marca: 'NA',
                                        desc: '',
                                        mtm: 'NA',
                                        serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')),
                                        codigo: getSafeProp(asset, 'Código de activo del Mouse'),
                                        estado: '',
                                        dano: false,
                                        faltante: false
                                    });
                                }
                                if (getSafeProp(asset, 'Código de activo del Cargador')) {
                                    equipos.push({
                                        id: Math.random(),
                                        tipo: 'CARGADOR',
                                        marca: 'NA',
                                        desc: '',
                                        mtm: 'NA',
                                        serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')),
                                        codigo: getSafeProp(asset, 'Código de activo del Cargador'),
                                        estado: '',
                                        dano: false,
                                        faltante: false
                                    });
                                }
                            });
                            showModal('Éxito', `Datos de ${nombreAD} cargados desde AD. Se encontraron ${equipos.length} activos asociados.`);
                        } else {
                            showModal('Éxito', `Datos de ${nombreAD} cargados desde AD, pero no se encontraron activos en el archivo Excel.`);
                        }

                        renderEquiposList();
                        updatePreview();

                        // Ocultar panel de credenciales
                        adCredentialsPanel.classList.add('hidden');
                        adUsernameInput.value = '';
                        adPasswordInput.value = '';

                    } else {
                        showModal('Error de Autenticación', result.message || 'Credenciales incorrectas o usuario no encontrado en AD.');
                    }
                } catch (error) {
                    console.error('Error en búsqueda AD:', error);
                    showModal('Error', 'Error al conectar con el Directorio Activo: ' + error.message);
                } finally {
                    // Restaurar botón
                    adAuthenticateBtn.innerHTML = 'Autenticar y Buscar';
                    adSearchText.textContent = 'Buscar en AD';
                    adSearchSpinner.classList.add('hidden');
                    adAuthenticateBtn.disabled = false;
                }
            });
*/
            // PEGA ESTE CÓDIGO CORREGIDO EN LUGAR DEL ANTERIOR
/*
            adAuthenticateBtn.addEventListener('click', async () => {
                const username = adUsernameInput.value.trim();
                const password = adPasswordInput.value.trim();

                if (!username || !password) {
                    showModal('Atención', 'Por favor, complete usuario y contraseña.');
                    return;
                }

                adAuthenticateBtn.innerHTML = 'Autenticando...';
                adAuthenticateBtn.disabled = true;

                try {
                    // 1. Guardamos las credenciales en la sesión del backend
                    const fullUsername = username + '@consensocorp.com';
                    const setResult = await window.api.setAdCredentials({ username: fullUsername, password: password });

                    if (setResult.success) {
                        // 2. Si se guardaron, ocultamos el panel
                        adCredentialsPanel.classList.add('hidden');

                        // 3. Y disparamos un clic en el botón principal para que ÉL haga la búsqueda.
                        // ¡No hacemos nada más en este botón!
                        adSearchBtn.click();
                    } else {
                        showModal('Error', 'No se pudieron guardar las credenciales.');
                    }
                } catch (error) {
                    showModal('Error Crítico', 'Ocurrió un error en el proceso de autenticación.');
                } finally {
                    hideLoader();
                    // Restaurar botón de autenticación
                    adAuthenticateBtn.innerHTML = 'Autenticar y Buscar';
                    adAuthenticateBtn.disabled = false;
                }
            });
*/
/*
            adAuthenticateBtn.addEventListener('click', async () => {
                const username = adUsernameInput.value.trim();
                const password = adPasswordInput.value.trim();
                if (!username || !password) {
                    showModal('Atención', 'Por favor, complete usuario y contraseña.');
                    return;
                }
                showLoader();
                dAuthenticateBtn.innerHTML = 'Autenticando...';
                adAuthenticateBtn.disabled = true;

                try {
                    const fullUsername = username + '@consensocorp.com';
                    const setResult = await window.api.setAdCredentials({ username: fullUsername, password: password });
                    if (setResult.success) {
                        adCredentialsPanel.classList.add('hidden');
                        adSearchBtn.click(); // Reintenta la búsqueda principal
                    } else {
                        showModal('Error', 'No se pudieron guardar las credenciales.');
                    }
                } catch (error) {
                    showModal('Error Crítico', 'Ocurrió un error en la autenticación.');
                } finally {
                    hideLoader();
                    adAuthenticateBtn.innerHTML = 'Autenticar y Buscar';
                    adAuthenticateBtn.disabled = false;
                }
            });
*/
            // ✅ REEMPLAZA LO ANTERIOR CON ESTO
            /*
            adAuthenticateBtn.addEventListener('click', async () => {
                const username = adUsernameInput.value.trim();
                const password = adPasswordInput.value.trim();

                if (!username || !password) {
                    showModal('Atención', 'Por favor, complete usuario y contraseña.');
                    return;
                }
                
                showLoader();
                adAuthenticateBtn.innerHTML = 'Autenticando...';
                adAuthenticateBtn.disabled = true;

                try {
                    const fullUsername = username + '@consensocorp.com';
                    const setResult = await window.api.setAdCredentials({ username: fullUsername, password: password });

                    if (setResult.success) {
                        adCredentialsPanel.classList.add('hidden');
                        adSearchBtn.click(); // Reintenta la búsqueda principal
                    } else {
                        showModal('Error', 'No se pudieron guardar las credenciales.');
                    }
                } catch (error) {
                    showModal('Error Crítico', 'Ocurrió un error en el proceso de autenticación.');
                } finally {
                    hideLoader();
                    adAuthenticateBtn.innerHTML = 'Autenticar y Buscar';
                    adAuthenticateBtn.disabled = false;
                }
            });
*/

            adAuthenticateBtn.addEventListener('click', async () => {
                const username = adUsernameInput.value.trim();
                const password = adPasswordInput.value.trim();
                if (!username || !password) {
                    showModal('Atención', 'Por favor, complete usuario y contraseña.');
                    return;
                }
                showLoader();
                adAuthenticateBtn.innerHTML = 'Autenticando...';
                adAuthenticateBtn.disabled = true;
                try {
                    const fullUsername = username + '@consensocorp.com';
                    // 1. Envía las credenciales al backend para que las guarde.
                    await window.api.setAdCredentials({ username: fullUsername, password: password });

                    // 2. Oculta la ventana emergente.
                    adCredentialsPanel.classList.add('hidden');
                    
                    // 3. Vuelve a presionar el botón de búsqueda principal para reintentar.
                    adSearchBtn.click();
                } catch (error) {
                    showModal('Error Crítico', 'Ocurrió un error en la autenticación.');
                } finally {
                    hideLoader();
                    adAuthenticateBtn.innerHTML = 'Autenticar y Buscar';
                    adAuthenticateBtn.disabled = false;
                }
            });
            //**************************************************************************
            // Soporte para tecla Enter en los campos de búsqueda
            excelSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchExcel();
                }
            });

            adSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    adSearchBtn.click();
                }
            });

            adPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    adAuthenticateBtn.click();
                }
            });

            // Funciones para devolución
            /*
            async function searchDevolucion() {
                const searchTerm = document.getElementById('devolucion-search-input').value.trim();
                if (!searchTerm) {
                    showModal('Atención', 'Por favor, ingrese apellidos para buscar.');
                    return;
                }

                try {
                    const dashboardData = await window.api.getDashboardData();
                    const matchingUsers = dashboardData.filter(row =>
                        (row.Colaborador || '').toUpperCase().includes(searchTerm.toUpperCase())
                    );

                    if (matchingUsers.length === 0) {
                        showModal('No Encontrado', 'No se encontraron colaboradores con esos apellidos en el dashboard.');
                        return;
                    }

                    if (matchingUsers.length === 1) {
                        loadDevolucionData(matchingUsers[0]);
                    } else {
                        showUserSelectionModalForDevolucion(matchingUsers);
                    }
                } catch (error) {
                    showModal('Error', 'Error al buscar en el dashboard: ' + error.message);
                }
            }

            function showUserSelectionModalForDevolucion(users) {
                const userListContainer = document.getElementById('user-list-container');
                userListContainer.innerHTML = '';

                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'p-3 border rounded-md hover:bg-blue-100 cursor-pointer';
                    userDiv.innerHTML = `
                       <p class="font-semibold text-gray-800">${user.Colaborador || 'Sin Nombre'}</p>
                       <p class="text-sm text-gray-600">Cédula: ${user.Cédulas || 'N/A'} | Hostname: ${user.Hostname || 'N/A'}</p>
                   `;

                    userDiv.addEventListener('click', () => {
                        loadDevolucionData(user);
                        hideUserSelectionModal();
                    });

                    userListContainer.appendChild(userDiv);
                });

                const modal = document.getElementById('user-selection-modal');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            }

            function loadDevolucionData(userData) {
                currentDevolucionData = userData;
                generateDevolucionPreview(userData);
            }

            function loadManualDevolucionData() {
                const nombre = document.getElementById('devolucion-manual-nombre').value.trim();
                const cedula = document.getElementById('devolucion-manual-cedula').value.trim();
                const usuario = document.getElementById('devolucion-manual-usuario').value.trim();

                if (!nombre || !cedula) {
                    showModal('Atención', 'Por favor, complete al menos el nombre y la cédula.');
                    return;
                }

                const manualData = {
                    Colaborador: nombre,
                    'Cédulas': cedula,
                    'Nombre de usuario': usuario,
                    Hostname: 'MANUAL',
                    'SERIE PC': 'N/A'
                };

                loadDevolucionData(manualData);
            }

            function generateDevolucionPreview(userData) {
                const wrapper = document.getElementById('devolucion-content-wrapper');
                const today = new Date().toLocaleDateString('es-ES');

                wrapper.innerHTML = `
                   <div style="font-family: 'Calibri', Arial, sans-serif; font-size: 11pt; color: #000;">
                       <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid rgba(24,121,174,1); margin-bottom: 15px;">
                           <div style="width: 4cm;"></div>
                           <h1 style="font-size: 16pt; font-weight: bold; color: rgba(24,121,174,1); margin: 0; padding: 0; border: none; text-align: center; flex-grow: 1;">ACTA DE DEVOLUCIÓN DE EQUIPOS</h1>
                           <img src="consenso.png" alt="Logo Consenso" style="height: 1.5cm; object-fit: contain; max-width: 4cm;">
                       </div>
                       
                       <table style="width: 100%; border-collapse: collapse; border: 1px solid rgba(24,121,174,1); font-size: 9pt; margin-bottom: 20px;">
                           <thead>
                               <tr>
                                   <th colspan="8" style="background-color: rgba(24,121,174,1); color: white; text-align: center; font-size: 11pt; padding: 5px;">DATOS DEL COLABORADOR</th>
                               </tr>
                           </thead>
                           <tbody>
                               <tr>
                                   <td style="font-weight: bold; background-color: #F2F2F2; color: rgba(24,121,174,1); text-align: center; border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">Colaborador</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;" colspan="3">${userData.Colaborador || 'N/A'}</td>
                                   <td style="font-weight: bold; background-color: #F2F2F2; color: rgba(24,121,174,1); text-align: center; border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">Fecha</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;" colspan="3">${today}</td>
                               </tr>
                               <tr>
                                   <td style="font-weight: bold; background-color: #F2F2F2; color: rgba(24,121,174,1); text-align: center; border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">Cédula</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;" colspan="3">${userData['Cédulas'] || 'N/A'}</td>
                                   <td style="font-weight: bold; background-color: #F2F2F2; color: rgba(24,121,174,1); text-align: center; border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">Usuario</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;" colspan="3">${userData['Nombre de usuario'] || 'N/A'}</td>
                               </tr>
                               <tr>
                                   <td style="font-weight: bold; background-color: #F2F2F2; color: rgba(24,121,174,1); text-align: center; border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">Hostname</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;" colspan="7">${userData.Hostname || 'N/A'}</td>
                               </tr>
                           </tbody>
                       </table>

                       <h2 style="font-size: 11pt; font-weight: bold; background-color: rgba(24,121,174,1); color: #FFFFFF; padding: 5px; margin-top: 15px; margin-bottom: 0; text-align: center; border: 1px solid rgba(24,121,174,1);">EQUIPOS A DEVOLVER</h2>
                       <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                           <thead>
                               <tr style="background-color: rgba(24,121,174,1); color: #FFFFFF;">
                                   <th style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">TIPO</th>
                                   <th style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">SERIE</th>
                                   <th style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">DESCRIPCIÓN</th>
                                   <th style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">CÓDIGO DE ACTIVO</th>
                                   <th style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">ESTADO</th>
                               </tr>
                           </thead>
                           <tbody>
                               <tr>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">PC/LAPTOP</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['SERIE PC'] || 'N/A'}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['Modelo Consenso'] || 'N/A'}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['Código de activo del equipo'] || 'N/A'}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">USADO</td>
                               </tr>
                               ${userData['SERIE MON'] ? `
                               <tr>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">MONITOR</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['SERIE MON']}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['Tipo Monitor'] || 'N/A'}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['Código de activo del Monitor'] || 'N/A'}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">USADO</td>
                               </tr>` : ''}
                               ${userData['Código de activo del teclado'] ? `
                               <tr>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">TECLADO</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">N/A</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">TECLADO ESTÁNDAR</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['Código de activo del teclado']}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">USADO</td>
                               </tr>` : ''}
                               ${userData['Código de activo del Mouse'] ? `
                               <tr>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">MOUSE</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">N/A</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">MOUSE ESTÁNDAR</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">${userData['Código de activo del Mouse']}</td>
                                   <td style="border: 1px solid rgba(24,121,174,1); padding: 2px 6px;">USADO</td>
                               </tr>` : ''}
                           </tbody>
                       </table>

                       <div style="margin-top: 50px;">
                           <p style="margin-bottom: 10px; text-align: justify;">
                               Por medio de la presente, el colaborador <strong>${userData.Colaborador || 'N/A'}</strong> 
                               con cédula <strong>${userData['Cédulas'] || 'N/A'}</strong> hace entrega de los equipos 
                               informáticos detallados anteriormente, los cuales estuvieron bajo su custodia durante 
                               su permanencia en la empresa.
                           </p>
                           <p style="margin-bottom: 10px; text-align: justify;">
                               Los equipos se entregan en las condiciones detalladas y cualquier daño o faltante 
                               ha sido debidamente documentado.
                           </p>
                       </div>

                       <table style="width: 100%; margin-top: 80px; page-break-inside: avoid; border: none;">
                           <tbody>
                               <tr>
                                   <td style="width: 50%; text-align: center; border: none; vertical-align: bottom; padding: 0 15px;">
                                       <div style="height: 80px;"></div>
                                       <div style="border-top: 1px solid black; margin-bottom: 8px;"></div>
                                       <p style="text-align: center; margin: 0; font-size: 10pt; line-height: 1.4;">
                                           <strong>ENTREGA</strong><br>${userData.Colaborador || 'N/A'}<br>CI: ${userData['Cédulas'] || 'N/A'}
                                       </p>
                                   </td>
                                   <td style="width: 50%; text-align: center; border: none; vertical-align: bottom; padding: 0 15px;">
                                       <div style="height: 80px;"></div>
                                       <div style="border-top: 1px solid black; margin-bottom: 8px;"></div>
                                       <p style="text-align: center; margin: 0; font-size: 10pt; line-height: 1.4;">
                                           <strong>RECIBE (TÉCNICO TI)</strong><br>TÉCNICO RESPONSABLE<br>CI: ______________
                                       </p>
                                   </td>
                               </tr>
                           </tbody>
                       </table>
                   </div>
               `;
            }
            // FIN DE LAS Funciones para devolución
            */
           // PEGA ESTE BLOQUE COMPLETO EN LUGAR DE LAS FUNCIONES DE DEVOLUCIÓN ANTIGUAS

// Estado global para el formulario de devolución
let currentDevolucionData = {
    colaborador: { nombre: '', cedula: '', usuario: '' },
    equipos: [],
    recibe: { nombre: '', cedula: '' },
    observaciones: ''
};

// Configura todos los eventos y la lógica para la nueva vista de devolución
/*
function setupDevolucionView() {
    // Reutilizar el formulario de equipos del acta principal
    const equipmentFormHTML = document.getElementById('equipment-form-container').innerHTML;
    document.getElementById('devolucion-equipment-form-container').innerHTML = equipmentFormHTML;

    // Pestañas
    const tabs = {
        buscar: document.getElementById('devolucion-tab-buscar'),
        manual: document.getElementById('devolucion-tab-manual')
    };
    const panels = {
        buscar: document.getElementById('devolucion-panel-buscar'),
        manual: document.getElementById('devolucion-panel-manual')
    };

    const switchTab = (activeTab) => {
        Object.keys(tabs).forEach(key => {
            const isActive = key === activeTab;
            tabs[key].classList.toggle('bg-blue-600', isActive);
            tabs[key].classList.toggle('text-white', isActive);
            tabs[key].classList.toggle('bg-gray-100', !isActive);
            tabs[key].classList.toggle('text-gray-700', !isActive);
            panels[key].classList.toggle('hidden', !isActive);
        });
    };

    tabs.buscar.addEventListener('click', () => switchTab('buscar'));
    tabs.manual.addEventListener('click', () => switchTab('manual'));
    
    // Lógica para el selector de "Recibido Por"
    const recibeRadios = document.querySelectorAll('input[name="recibe_grupo"]');
    const recibeSelectContainer = document.getElementById('devolucion-recibe-selector-container');
    const recibeSelect = document.getElementById('devolucion-recibe-select');
    const recibeManualContainer = document.getElementById('devolucion-recibe-manual-container');

    const updateRecibeSelector = () => {
        const selectedGroup = document.querySelector('input[name="recibe_grupo"]:checked').value;
        if (selectedGroup === 'manual') {
            recibeSelectContainer.classList.add('hidden');
            recibeManualContainer.classList.remove('hidden');
        } else {
            recibeSelectContainer.classList.remove('hidden');
            recibeManualContainer.classList.add('hidden');
            const source = selectedGroup === 'tecnicos' ? tecnicos : observabilidadUsers;
            populateSelect(recibeSelect, source, 'cedula', 'nombre');
        }
        generateDevolucionPreview();
    };

    recibeRadios.forEach(radio => radio.addEventListener('change', updateRecibeSelector));
    recibeSelect.addEventListener('change', generateDevolucionPreview);
    recibeManualContainer.addEventListener('input', generateDevolucionPreview);
    
    // Lógica para la búsqueda
    document.getElementById('devolucion-search-btn').addEventListener('click', async () => {
        const searchTerm = document.getElementById('devolucion-search-input').value.trim();
        if (!searchTerm) { showModal('Atención', 'Por favor, ingrese apellidos para buscar.'); return; }
        
        const dashboardData = await window.api.getDashboardData();
        const matchingUsers = dashboardData.filter(row => (row.Colaborador || '').toUpperCase().includes(searchTerm.toUpperCase()));

        if (matchingUsers.length === 0) {
            showModal('No Encontrado', 'No se encontraron colaboradores con esos apellidos.');
        } else if (matchingUsers.length === 1) {
            loadDevolucionDataFromDashboard(matchingUsers[0]);
        } else {
            showUserSelectionModal(matchingUsers, loadDevolucionDataFromDashboard);
        }
    });

    // Lógica para carga manual de usuario
    document.getElementById('devolucion-manual-btn').addEventListener('click', () => {
        currentDevolucionData.colaborador.nombre = document.getElementById('devolucion-manual-nombre').value;
        currentDevolucionData.colaborador.cedula = document.getElementById('devolucion-manual-cedula').value;
        currentDevolucionData.colaborador.usuario = document.getElementById('devolucion-manual-usuario').value;
        // Limpiar equipos si se carga un nuevo usuario manual
        currentDevolucionData.equipos = [];
        renderDevolucionEquiposList();
        generateDevolucionPreview();
    });

    // Lógica para añadir equipo manual
    const devEqFormContainer = document.getElementById('devolucion-equipment-form-container');
    const devAddBtn = devEqFormContainer.querySelector('#add-update-equipo-btn');
    devAddBtn.addEventListener('click', () => {
        const tipo = devEqFormContainer.querySelector('#eq_tipo').value;
        const serie = devEqFormContainer.querySelector('#eq_serie').value;
        if (!tipo || !serie) {
            showModal("Atención", "El Tipo y la Serie son obligatorios.");
            return;
        }
        currentDevolucionData.equipos.push({
            tipo,
            marca: devEqFormContainer.querySelector('#eq_marca').value,
            descripcion: devEqFormContainer.querySelector('#eq_desc').value,
            serie,
            estado: devEqFormContainer.querySelector('#eq_estado').value,
            id: Date.now()
        });
        renderDevolucionEquiposList();
        generateDevolucionPreview();
        devEqFormContainer.querySelector('form')?.reset(); // Asumiendo que los inputs están en un form
    });
    
    document.getElementById('devolucion-observaciones').addEventListener('input', generateDevolucionPreview);

    // Inicializar
    updateRecibeSelector();
    generateDevolucionPreview();
}
*/

//***********************************************************************************
// ✅✅ INICIO DEL BLOQUE CORREGIDO QUE DEBES PEGAR ✅✅

    function setupDevolucionView() {
        // ----- NO TOCAR: Lógica para reutilizar el formulario de equipos -----
        const equipmentFormHTML = document.getElementById('equipment-form-container').innerHTML;
        const devEqFormContainer = document.getElementById('devolucion-equipment-form-container');
        devEqFormContainer.innerHTML = equipmentFormHTML;
        // ----- FIN Lógica de reutilización -----

        // Seleccionar elementos DENTRO de la vista de devolución para evitar conflictos
        const devEqForm = {
            tipo: devEqFormContainer.querySelector('#eq_tipo'),
            tipo_manual: devEqFormContainer.querySelector('#eq_tipo_manual'),
            marca: devEqFormContainer.querySelector('#eq_marca'),
            desc: devEqFormContainer.querySelector('#eq_desc'),
            serie: devEqFormContainer.querySelector('#eq_serie'),
            estado: devEqFormContainer.querySelector('#eq_estado'),
            codigo: devEqFormContainer.querySelector('#eq_codigo'),
            btn: devEqFormContainer.querySelector('#add-update-equipo-btn')
        };

        // ----- Lógica para Pestañas (Origen de Datos) -----
        const tabs = {
            buscar: document.getElementById('devolucion-tab-buscar'),
            manual: document.getElementById('devolucion-tab-manual')
        };
        const panels = {
            buscar: document.getElementById('devolucion-panel-buscar'),
            manual: document.getElementById('devolucion-panel-manual')
        };
        const switchTab = (activeTab) => {
            Object.keys(tabs).forEach(key => {
                const isActive = key === activeTab;
                tabs[key].classList.toggle('bg-blue-600', isActive);
                tabs[key].classList.toggle('text-white', isActive);
                tabs[key].classList.toggle('bg-gray-100', !isActive);
                tabs[key].classList.toggle('text-gray-700', !isActive);
                panels[key].classList.toggle('hidden', !isActive);
            });
        };
        tabs.buscar.addEventListener('click', () => switchTab('buscar'));
        tabs.manual.addEventListener('click', () => switchTab('manual'));

        // ----- Lógica para Selector "Recibido Por" -----
        const recibeRadios = document.querySelectorAll('input[name="recibe_grupo"]');
        const recibeSelectContainer = document.getElementById('devolucion-recibe-selector-container');
        const recibeSelect = document.getElementById('devolucion-recibe-select');
        const recibeManualContainer = document.getElementById('devolucion-recibe-manual-container');
        const updateRecibeSelector = () => {
            const selectedGroup = document.querySelector('input[name="recibe_grupo"]:checked').value;
            recibeSelectContainer.classList.toggle('hidden', selectedGroup === 'manual');
            recibeManualContainer.classList.toggle('hidden', selectedGroup !== 'manual');
            if (selectedGroup !== 'manual') {
                const source = selectedGroup === 'tecnicos' ? tecnicos : observabilidadUsers;
                populateSelect(recibeSelect, source, 'cedula', 'nombre');
            }
            generateDevolucionPreview();
        };
        recibeRadios.forEach(radio => radio.addEventListener('change', updateRecibeSelector));
        recibeSelect.addEventListener('change', generateDevolucionPreview);
        recibeManualContainer.addEventListener('input', generateDevolucionPreview);

        // ----- Lógica para Búsqueda de Colaborador -----
        document.getElementById('devolucion-search-btn').addEventListener('click', async () => {
            const searchTerm = document.getElementById('devolucion-search-input').value.trim();
            if (!searchTerm) { showModal('Atención', 'Por favor, ingrese apellidos para buscar.'); return; }
            
            showLoader();
            const dashboardData = await window.api.getDashboardData();
            hideLoader();

            const matchingUsers = dashboardData.filter(row => (row.Colaborador || '').toUpperCase().includes(searchTerm.toUpperCase()));

            if (matchingUsers.length === 0) {
                showModal('No Encontrado', 'No se encontraron colaboradores con esos apellidos.');
            } else if (matchingUsers.length === 1) {
                loadDevolucionDataFromDashboard(matchingUsers[0]);
            } else {
                showUserSelectionModal(matchingUsers, loadDevolucionDataFromDashboard);
            }
        });

        // ----- Lógica para Carga Manual de Usuario -----
        document.getElementById('devolucion-manual-btn').addEventListener('click', () => {
            currentDevolucionData.colaborador.nombre = document.getElementById('devolucion-manual-nombre').value;
            currentDevolucionData.colaborador.cedula = document.getElementById('devolucion-manual-cedula').value;
            currentDevolucionData.colaborador.usuario = document.getElementById('devolucion-manual-usuario').value;
            currentDevolucionData.equipos = []; // Limpiar equipos al cargar nuevo usuario
            renderDevolucionEquiposList();
            generateDevolucionPreview();
            showModal('Éxito', 'Datos del usuario manual cargados.');
        });

        // ----- Lógica para Añadir Equipo Manualmente -----
        devEqForm.btn.textContent = "Añadir Equipo a Devolución"; // Cambiar texto del botón
        devEqForm.btn.addEventListener('click', () => {
            const tipo = devEqForm.tipo.value === 'OTRO' ? devEqForm.tipo_manual.value : devEqForm.tipo.value;
            const serie = devEqForm.serie.value;
            if (!tipo || !serie) {
                showModal("Atención", "El Tipo y la Serie son obligatorios.");
                return;
            }
            currentDevolucionData.equipos.push({
                tipo,
                marca: devEqForm.marca.value,
                descripcion: devEqForm.desc.value,
                serie,
                estado: devEqForm.estado.value,
                id: Date.now()
            });
            renderDevolucionEquiposList();
            generateDevolucionPreview();
            // Limpiar campos del formulario de equipos
            devEqForm.tipo.value = "";
            devEqForm.tipo_manual.value = "";
            devEqForm.marca.value = "";
            devEqForm.desc.value = "";
            devEqForm.serie.value = "";
            devEqForm.estado.value = "";
            devEqForm.codigo.value = "";
        });

        // ----- Lógica para Inputs "Otro" en formulario de equipos -----
        [devEqForm.tipo, devEqForm.marca, devEqForm.desc].forEach(select => {
            select.addEventListener('change', () => {
                const manualInput = devEqFormContainer.querySelector(`#${select.id}_manual`);
                if (manualInput) {
                    manualInput.classList.toggle('hidden', select.value !== 'OTRO');
                }
            });
        });

        // ----- Lógica para Observaciones -----
        document.getElementById('devolucion-observaciones').addEventListener('input', generateDevolucionPreview);

        // Inicializar la vista
        updateRecibeSelector();
        generateDevolucionPreview();
    }

// ✅✅ FIN DEL BLOQUE CORREGIDO ✅✅
//*************************************************************************************
// Carga los datos desde un resultado de búsqueda del dashboard
function loadDevolucionDataFromDashboard(userData) {
    currentDevolucionData.colaborador = {
        nombre: userData.Colaborador || 'N/A',
        cedula: userData['Cédulas'] || 'N/A',
        usuario: userData['Nombre de usuario'] || 'N/A'
    };
    
    currentDevolucionData.equipos = [];
    if (userData['SERIE PC']) currentDevolucionData.equipos.push({ tipo: 'LAPTOP/PC', marca: 'N/A', descripcion: userData['Modelo Consenso'], serie: userData['SERIE PC'], estado: 'SEMINUEVO', id: Math.random() });
    if (userData['SERIE MON']) currentDevolucionData.equipos.push({ tipo: 'MONITOR', marca: 'N/A', descripcion: userData['Tipo Monitor'], serie: userData['SERIE MON'], estado: 'SEMINUEVO', id: Math.random() });
    if (userData['Código de activo del Cargador']) currentDevolucionData.equipos.push({ tipo: 'CARGADOR', marca: 'N/A', descripcion: 'CARGADOR DE PORTÁTIL', serie: userData['Código de activo del Cargador'], estado: 'SEMINUEVO', id: Math.random() });
    
    renderDevolucionEquiposList();
    generateDevolucionPreview();
}

// Muestra la tabla de equipos agregados manualmente
function renderDevolucionEquiposList() {
    const container = document.getElementById('devolucion-equipos-list');
    if (currentDevolucionData.equipos.length === 0) {
        container.innerHTML = `<p class="text-sm text-gray-500 text-center">No hay equipos agregados.</p>`;
        return;
    }
    
    const tableRows = currentDevolucionData.equipos.map(eq => `
        <tr class="border-b">
            <td class="p-2 text-sm">${eq.tipo}</td>
            <td class="p-2 text-sm">${eq.serie}</td>
            <td class="p-2 text-center">
                <button type="button" class="text-red-500 font-bold dev-delete-equipo-btn" data-id="${eq.id}">X</button>
            </td>
        </tr>
    `).join('');
    
    container.innerHTML = `
        <table class="w-full text-left">
            <thead><tr class="bg-gray-100"><th class="p-2 text-xs">Tipo</th><th class="p-2 text-xs">Serie</th><th class="p-2 text-xs text-center">Quitar</th></tr></thead>
            <tbody>${tableRows}</tbody>
        </table>
    `;
}

// Event listener para borrar equipos de la lista manual
document.getElementById('devolucion-equipos-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('dev-delete-equipo-btn')) {
        const equipoId = Number(e.target.dataset.id);
        currentDevolucionData.equipos = currentDevolucionData.equipos.filter(eq => eq.id !== equipoId);
        renderDevolucionEquiposList();
        generateDevolucionPreview();
    }
});

/*
// LA NUEVA FUNCIÓN DE VISTA PREVIA
function generateDevolucionPreview() {
    const wrapper = document.getElementById('devolucion-content-wrapper');
    
    // 1. Obtener datos del colaborador
    const colaborador = currentDevolucionData.colaborador;

    // 2. Obtener datos de quien recibe
    const recibeGroup = document.querySelector('input[name="recibe_grupo"]:checked').value;
    let recibeData = { nombre: '', cedula: ''};
    if (recibeGroup === 'manual') {
        recibeData.nombre = document.getElementById('devolucion-recibe-manual-nombre').value;
        recibeData.cedula = document.getElementById('devolucion-recibe-manual-cedula').value;
    } else {
        const select = document.getElementById('devolucion-recibe-select');
        if(select.value) {
            const source = recibeGroup === 'tecnicos' ? tecnicos : observabilidadUsers;
            const selected = source.find(p => p.cedula === select.value);
            if (selected) recibeData = selected;
        }
    }
    
    // 3. Obtener observaciones
    currentDevolucionData.observaciones = document.getElementById('devolucion-observaciones').value;

    const hoy = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

    // 4. Generar filas de la tabla de equipos
    const equiposRowsHtml = currentDevolucionData.equipos.length > 0
        ? currentDevolucionData.equipos.map(eq => `
            <tr>
                <td style="border: 1px solid #000; padding: 4px;">${eq.tipo || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.marca || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.descripcion || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.serie || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.estado || 'SEMINUEVO'}</td>
            </tr>
        `).join('')
        : `<tr><td colspan="5" style="border: 1px solid #000; padding: 10px; text-align: center;">No hay equipos detallados.</td></tr>`;

    // 5. Construir el HTML final
    wrapper.innerHTML = `
    <div style="font-family: 'Calibri', Arial, sans-serif; font-size: 11pt; color: #000; border: 1px solid #000; padding: 5px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr><td colspan="6" style="background-color: #2F5496; color: white; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000;">DATOS</td></tr>
            <tr>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">FECHA</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center;" colspan="2">${hoy}</td>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">NOMBRE</td>
                <td style="border: 1px solid #000; padding: 4px;" colspan="2">${colaborador.nombre || 'N/A'}</td>
            </tr>
            <tr>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">USUARIO</td><td style="border: 1px solid #000; padding: 4px;">${colaborador.usuario || 'N/A'}</td>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">CÉDULA</td><td style="border: 1px solid #000; padding: 4px;" colspan="3">${colaborador.cedula || 'N/A'}</td>
            </tr>
            <tr><td colspan="6" style="background-color: #2F5496; color: white; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000;">OBSERVACIONES</td></tr>
            <tr><td colspan="6" style="height: 40px; border: 1px solid #000; padding: 4px; text-align: left; vertical-align: top;">${currentDevolucionData.observaciones || 'Se procede a realizar, la entrega del equipo que está en buenas condiciones.'}</td></tr>
            <tr><td colspan="6" style="background-color: #2F5496; color: white; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000;">DATOS DE ENTREGA</td></tr>
        </table>
        <table style="width: 100%; border-collapse: collapse; margin-top: -1px;">
             <thead><tr style="background-color: #2F5496; color: white; font-weight: bold; text-align: center;"><td style="border: 1px solid #000; padding: 4px;">TIPO</td><td style="border: 1px solid #000; padding: 4px;">MARCA</td><td style="border: 1px solid #000; padding: 4px;">DESCRIPCIÓN</td><td style="border: 1px solid #000; padding: 4px;">SERIE</td><td style="border: 1px solid #000; padding: 4px;">ESTADO</td></tr></thead>
             <tbody>${equiposRowsHtml}</tbody>
        </table>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px; border: none;">
            <tr><td colspan="6" style="text-align: center; padding: 10px; font-weight: bold;">FIRMAN LAS PARTES INTERESADAS:</td></tr>
            <tr><td style="height: 80px;" colspan="6"></td></tr>
            <tr>
                <td colspan="3" style="text-align: center; vertical-align: top;">
                    <div style="display: inline-block; width: 250px;"><div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div><div style="font-weight: bold;">RECIBE</div><div>${recibeData.nombre || 'N/A'}</div><div>CI: ${recibeData.cedula || 'N/A'}</div></div>
                </td>
                <td colspan="3" style="text-align: center; vertical-align: top;">
                    <div style="display: inline-block; width: 250px;"><div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div><div style="font-weight: bold;">ENTREGA</div><div>${colaborador.nombre || 'N/A'}</div><div>CI: ${colaborador.cedula || 'N/A'}</div></div>
                </td>
            </tr>
        </table>
    </div>`;
}
           
*/

// ✅✅ PEGA ESTA FUNCIÓN ACTUALIZADA EN LUGAR DE LA ANTIGUA ✅✅

// ✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
/*
function generateDevolucionPreview() {
    const wrapper = document.getElementById('devolucion-content-wrapper');
    
    // Obtener datos del colaborador
    const colaborador = currentDevolucionData.colaborador;

    // Obtener datos de quien recibe
    const recibeGroup = document.querySelector('input[name="recibe_grupo"]:checked').value;
    let recibeData = { nombre: '', cedula: ''};
    if (recibeGroup === 'manual') {
        recibeData.nombre = document.getElementById('devolucion-recibe-manual-nombre').value;
        recibeData.cedula = document.getElementById('devolucion-recibe-manual-cedula').value;
    } else {
        const select = document.getElementById('devolucion-recibe-select');
        if(select.value) {
            const source = recibeGroup === 'tecnicos' ? tecnicos : observabilidadUsers;
            const selected = source.find(p => p.cedula === select.value);
            if (selected) recibeData = selected;
        }
    }
    
    // Obtener observaciones
    currentDevolucionData.observaciones = document.getElementById('devolucion-observaciones').value;

    const hoy = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

    // Generar filas de la tabla de equipos
    const equiposRowsHtml = currentDevolucionData.equipos.length > 0
        ? currentDevolucionData.equipos.map(eq => `
            <tr>
                <td style="border: 1px solid #000; padding: 4px;">${eq.tipo || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.marca || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.descripcion || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.serie || 'N/A'}</td>
                <td style="border: 1px solid #000; padding: 4px;">${eq.estado || 'SEMINUEVO'}</td>
            </tr>
        `).join('')
        : `<tr><td colspan="5" style="border: 1px solid #000; padding: 10px; text-align: center;">No hay equipos detallados.</td></tr>`;

    // Construir el HTML final
    wrapper.innerHTML = `
    <div style="font-family: 'Calibri', Arial, sans-serif; font-size: 11pt; color: #000; border: 1px solid #000; padding: 15px;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
            <img src="tecnasa.png" alt="Logo Tecnasa" style="height: 40px; object-fit: contain;">
            <h2 style="font-size: 12pt; font-weight: bold; text-align: center; margin: 0; line-height: 1.2;">
                ENTREGA DE EQUIPOS A OBSERVABILIDAD 
            </h2>
            <img src="consenso.png" alt="Logo Consenso" style="height: 40px; object-fit: contain;">
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <tr><td colspan="6" style="background-color: #2F5496; color: white; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000;">DATOS</td></tr>
            <tr>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">FECHA</td>
                <td style="border: 1px solid #000; padding: 4px; text-align: center;" colspan="2">${hoy}</td>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">NOMBRE</td>
                <td style="border: 1px solid #000; padding: 4px;" colspan="2">${colaborador.nombre || 'N/A'}</td>
            </tr>
            <tr>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">USUARIO</td><td style="border: 1px solid #000; padding: 4px;">${colaborador.usuario || 'N/A'}</td>
                <td style="font-weight: bold; background-color: #2F5496; color: white; padding: 4px; border: 1px solid #000;">CÉDULA</td><td style="border: 1px solid #000; padding: 4px;" colspan="3">${colaborador.cedula || 'N/A'}</td>
            </tr>
            <tr><td colspan="6" style="background-color: #2F5496; color: white; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000;">OBSERVACIONES</td></tr>
            <tr><td colspan="6" style="height: 40px; border: 1px solid #000; padding: 4px; text-align: left; vertical-align: top;">${currentDevolucionData.observaciones || 'Se procede a realizar, la entrega del equipo que está en buenas condiciones.'}</td></tr>
            <tr><td colspan="6" style="background-color: #2F5496; color: white; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000;">DATOS DE ENTREGA</td></tr>
        </table>
        <table style="width: 100%; border-collapse: collapse; margin-top: -1px;">
             <thead><tr style="background-color: #2F5496; color: white; font-weight: bold; text-align: center;"><td style="border: 1px solid #000; padding: 4px;">TIPO</td><td style="border: 1px solid #000; padding: 4px;">MARCA</td><td style="border: 1px solid #000; padding: 4px;">DESCRIPCIÓN</td><td style="border: 1px solid #000; padding: 4px;">SERIE</td><td style="border: 1px solid #000; padding: 4px;">ESTADO</td></tr></thead>
             <tbody>${equiposRowsHtml}</tbody>
        </table>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px; border: none;">
            <tr><td colspan="6" style="text-align: center; padding: 10px; font-weight: bold;">FIRMAN LAS PARTES INTERESADAS:</td></tr>
            <tr><td style="height: 80px;" colspan="6"></td></tr>
            <tr>
                <td colspan="3" style="text-align: center; vertical-align: top;">
                    <div style="display: inline-block; width: 250px;"><div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div><div style="font-weight: bold;">RECIBE</div><div>${recibeData.nombre || 'N/A'}</div><div>CI: ${recibeData.cedula || 'N/A'}</div></div>
                </td>
                <td colspan="3" style="text-align: center; vertical-align: top;">
                    <div style="display: inline-block; width: 250px;"><div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div><div style="font-weight: bold;">ENTREGA</div><div>${colaborador.nombre || 'N/A'}</div><div>CI: ${colaborador.cedula || 'N/A'}</div></div>
                </td>
            </tr>
        </table>
    </div>`;
}
*/
// ✅✅ PEGA ESTA FUNCIÓN ACTUALIZADA EN LUGAR DE LA ANTIGUA ✅✅
            // ✅✅ PEGA ESTA FUNCIÓN ACTUALIZADA EN LUGAR DE LA ANTIGUA ✅✅
            function generateDevolucionPreview() {
                const wrapper = document.getElementById('devolucion-content-wrapper');
                
                // Esta parte no cambia, seguimos obteniendo los datos como antes.
                const colaborador = currentDevolucionData.colaborador;
                const recibeGroup = document.querySelector('input[name="recibe_grupo"]:checked').value;
                let recibeData = { nombre: '', cedula: ''};
                if (recibeGroup === 'manual') {
                    recibeData.nombre = document.getElementById('devolucion-recibe-manual-nombre').value;
                    recibeData.cedula = document.getElementById('devolucion-recibe-manual-cedula').value;
                } else {
                    const select = document.getElementById('devolucion-recibe-select');
                    if(select.value) {
                        const source = recibeGroup === 'tecnicos' ? tecnicos : observabilidadUsers;
                        const selected = source.find(p => p.cedula === select.value);
                        if (selected) recibeData = selected;
                    }
                }
                currentDevolucionData.observaciones = document.getElementById('devolucion-observaciones').value;
                const hoy = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

                const equiposRowsHtml = currentDevolucionData.equipos.length > 0
                    ? currentDevolucionData.equipos.map(eq => `
                        <tr>
                            <td style="border: 1px solid #dee2e6; padding: 6px;">${eq.tipo || 'N/A'}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px;">${eq.marca || 'N/A'}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px;">${eq.descripcion || 'N/A'}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px;">${eq.serie || 'N/A'}</td>
                            <td style="border: 1px solid #dee2e6; padding: 6px;">${eq.estado || 'USADO'}</td>
                        </tr>
                    `).join('')
                    : `<tr><td colspan="5" style="border: 1px solid #dee2e6; padding: 10px; text-align: center; color: #6c757d;">No hay equipos detallados en la devolución.</td></tr>`;

                // ✅ INICIO DE LA CORRECCIÓN: Construimos el HTML con la nueva tabla de DATOS
                wrapper.innerHTML = `
                <div style="font-family: 'Calibri', Arial, sans-serif; font-size: 11pt; color: #000;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1e40af; padding-bottom: 10px; margin-bottom: 20px;">
                        <img src="tecnasa.png" alt="Logo Tecnasa" style="height: 40px; object-fit: contain;">
                        <h2 style="font-size: 14pt; font-weight: bold; text-align: center; color: #1e40af; margin: 0;">ACTA DE DEVOLUCIÓN DE EQUIPOS</h2>
                        <img src="consenso.png" alt="Logo Consenso" style="height: 40px; object-fit: contain;">
                    </div>

                    <table style="width: 100%; border-collapse: collapse; border: 1px solid black; font-size: 9pt;">
                        <thead>
                            <tr>
                                <th colspan="6" style="background-color: #1e40af; color: white; font-weight: bold; padding: 5px; text-align: center; border: 1px solid black;">DATOS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2; width: 12%;">FECHA</td>
                                <td style="padding: 4px; border: 1px solid black; width: 18%;">${hoy}</td>
                                
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2; width: 12%; vertical-align: middle;" rowspan="2">NOMBRE</td>
                                
                                <td style="padding: 4px; border: 1px solid black; width: 25%;" rowspan="2">${colaborador.nombre || 'N/A'}</td>
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2; width: 15%;">CIUDAD</td>
                                <td style="padding: 4px; border: 1px solid black;">${colaborador.ciudad || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2;">USUARIO</td>
                                <td style="padding: 4px; border: 1px solid black;">${colaborador.usuario || 'N/A'}</td>
                                
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2;">UBICACIÓN</td>
                                <td style="padding: 4px; border: 1px solid black;">${colaborador.ubicacion || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2;">EMPRESA</td>
                                <td style="padding: 4px; border: 1px solid black;">${colaborador.empresa || 'N/A'}</td>
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2;">CÉDULA</td>
                                <td style="padding: 4px; border: 1px solid black;">${colaborador.cedula || 'N/A'}</td>
                                <td style="font-weight: bold; padding: 4px; border: 1px solid black; background-color: #f2f2f2;">DEPARTAMENTO</td>
                                <td style="padding: 4px; border: 1px solid black;">${colaborador.departamento || 'N/A'}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h3 style="background-color: #eef2ff; color: #312e81; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #c7d2fe; font-size: 11pt; margin-bottom: 0; margin-top: 20px;">EQUIPOS DEVUELTOS</h3>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #c7d2fe;">
                         <thead>
                            <tr style="background-color: #4338ca; color: white; font-weight: bold; text-align: center; font-size: 10pt;">
                                <td style="border: 1px solid #c7d2fe; padding: 6px;">TIPO</td>
                                <td style="border: 1px solid #c7d2fe; padding: 6px;">MARCA</td>
                                <td style="border: 1px solid #c7d2fe; padding: 6px;">DESCRIPCIÓN</td>
                                <td style="border: 1px solid #c7d2fe; padding: 6px;">SERIE</td>
                                <td style="border: 1px solid #c7d2fe; padding: 6px;">ESTADO</td>
                            </tr>
                         </thead>
                         <tbody>${equiposRowsHtml}</tbody>
                    </table>

                    <table style="width: 100%; border-collapse: collapse; margin-top: 60px; border: none;">
                        <tr><td colspan="2" style="text-align: center; padding: 10px; font-weight: bold; border: none;">FIRMAN LAS PARTES INTERESADAS:</td></tr>
                        <tr><td style="height: 80px; border: none;" colspan="2"></td></tr>
                        <tr>
                            <td style="text-align: center; vertical-align: top; width: 50%; border: none;">
                                <div style="display: inline-block; width: 250px;"><div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div><div style="font-weight: bold;">RECIBE</div><div>${recibeData.nombre || 'N/A'}</div><div>CI: ${recibeData.cedula || 'N/A'}</div></div>
                            </td>
                            <td style="text-align: center; vertical-align: top; width: 50%; border: none;">
                                <div style="display: inline-block; width: 250px;"><div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div><div style="font-weight: bold;">ENTREGA</div><div>${colaborador.nombre || 'N/A'}</div><div>CI: ${colaborador.cedula || 'N/A'}</div></div>
                            </td>
                        </tr>
                    </table>
                </div>`;
            }
// ✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
//---------------------------------------------------------------------------
            function updateChangeSummaryTables() {
                const retiredChecks = document.querySelectorAll('.change-retire-check:checked');
                const retiredIds = Array.from(retiredChecks).map(chk => Number(chk.dataset.id));

                const retiredItems = change_assignedEquipos.filter(eq => retiredIds.includes(eq.id));
                const maintainedItems = change_assignedEquipos.filter(eq => !retiredIds.includes(eq.id));

                changeRetiredDisplayList.innerHTML = '';
                changeMaintainedList.innerHTML = '';

                if (retiredItems.length > 0) {
                    retiredItems.forEach(eq => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                          <td class="p-2">${eq.tipo || ''}</td>
                          <td class="p-2">${eq.serie || ''}</td>
                          <td class="p-2">${eq.desc || ''}</td>
                      `;
                        changeRetiredDisplayList.appendChild(row);
                    });
                } else {
                    changeRetiredDisplayList.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-xs text-gray-400">Ningún equipo seleccionado para retirar.</td></tr>`;
                }

                if (maintainedItems.length > 0) {
                    maintainedItems.forEach(eq => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                          <td class="p-2 text-sm">${eq.tipo || ''}</td>
                          <td class="p-2 text-sm">${eq.serie || ''}</td>
                          <td class="p-2 text-sm">${eq.desc || ''}</td>
                          <td class="p-2 text-sm">${eq.codigo || 'N/A'}</td>
                      `;
                        changeMaintainedList.appendChild(row);
                    });
                } else {
                    changeMaintainedList.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-sm text-gray-400">No quedan equipos.</td></tr>`;
                }
            }

            changeAssignedList.addEventListener('change', (e) => {
                if (e.target.classList.contains('change-retire-check')) {
                    updateChangeSummaryTables();
                    updateChangePreview();
                }
            });

            // Funciones para el panel de retiro específico
            function toggleRetiroPanel() {
                const tipoActa = document.getElementById('tipo_acta').value;
                if (tipoActa === 'RETIRO DE EQUIPOS') {
                    retiroPanel.classList.remove('hidden');
                } else {
                    retiroPanel.classList.add('hidden');
                    resetRetiroPanel();
                }
            }

            function resetRetiroPanel() {
                retiroTodosRadio.checked = true;
                retiroEspecificosRadio.checked = false;
                retiroActivosList.classList.add('hidden');
                activosParaRetiro = [];
                tipoRetiro = 'todos';
                renderRetiroActivos();
            }

            function renderRetiroActivos() {
                retiroActivosBody.innerHTML = '';

                if (equipos.length === 0) {
                    retiroActivosBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No hay activos cargados</td></tr>';
                    return;
                }

                equipos.forEach(eq => {
                    const isSelected = activosParaRetiro.some(a => a.id === eq.id);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                      <td class="px-2 py-2 text-center">
                          <input type="checkbox" class="retiro-check h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded" 
                                 data-id="${eq.id}" ${isSelected ? 'checked' : ''}>
                      </td>
                      <td class="px-4 py-2">${eq.tipo || ''}</td>
                      <td class="px-4 py-2">${eq.marca || ''}</td>
                      <td class="px-4 py-2">${eq.serie || ''}</td>
                      <td class="px-4 py-2">${eq.codigo || ''}</td>
                      <td class="px-4 py-2 text-center">
                          <button type="button" class="text-orange-600 hover:text-orange-900 edit-retiro-btn" data-id="${eq.id}" ${!isSelected ? 'disabled' : ''}>
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                              </svg>
                          </button>
                      </td>
                  `;
                    retiroActivosBody.appendChild(row);
                });
            }

            function updateActivosParaRetiro() {
                const checkedBoxes = document.querySelectorAll('.retiro-check:checked');
                activosParaRetiro = [];

                checkedBoxes.forEach(checkbox => {
                    const id = Number(checkbox.dataset.id);
                    const equipo = equipos.find(eq => eq.id === id);
                    if (equipo) {
                        activosParaRetiro.push({ ...equipo });
                    }
                });

                // Habilitar/deshabilitar botones de editar
                document.querySelectorAll('.edit-retiro-btn').forEach(btn => {
                    const id = Number(btn.dataset.id);
                    const isSelected = activosParaRetiro.some(a => a.id === id);
                    btn.disabled = !isSelected;
                    btn.classList.toggle('opacity-50', !isSelected);
                });

                updatePreview();
            }

            // Event listeners para el panel de retiro
            retiroTodosRadio.addEventListener('change', () => {
                if (retiroTodosRadio.checked) {
                    tipoRetiro = 'todos';
                    retiroActivosList.classList.add('hidden');
                    activosParaRetiro = [];
                    updatePreview();
                }
            });

            retiroEspecificosRadio.addEventListener('change', () => {
                if (retiroEspecificosRadio.checked) {
                    tipoRetiro = 'especificos';
                    retiroActivosList.classList.remove('hidden');
                    renderRetiroActivos();
                    updatePreview();
                }
            });

            // Event listener para checkboxes de retiro y botones de editar
            retiroActivosBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('retiro-check')) {
                    updateActivosParaRetiro();
                }
            });

            retiroActivosBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-retiro-btn');
                if (editBtn && !editBtn.disabled) {
                    const id = Number(editBtn.dataset.id);
                    const equipoToEdit = equipos.find(eq => eq.id === id);
                    if (equipoToEdit) {
                        // Cargar el equipo en el formulario de edición
                        equipmentFormContainer.classList.remove('hidden');

                        if (tipoOptions.includes(equipoToEdit.tipo)) {
                            eqForm.tipo.value = equipoToEdit.tipo;
                            eqForm.tipo_manual.classList.add('hidden');
                        } else {
                            eqForm.tipo.value = 'OTRO';
                            eqForm.tipo_manual.value = equipoToEdit.tipo;
                            eqForm.tipo_manual.classList.remove('hidden');
                        }

                        if (marcaOptions.includes(equipoToEdit.marca)) {
                            eqForm.marca.value = equipoToEdit.marca;
                            eqForm.marca_manual.classList.add('hidden');
                        } else {
                            eqForm.marca.value = 'OTRO';
                            eqForm.marca_manual.value = equipoToEdit.marca;
                            eqForm.marca_manual.classList.remove('hidden');
                        }

                        if (descOptions.includes(equipoToEdit.desc)) {
                            eqForm.desc.value = equipoToEdit.desc;
                            eqForm.desc_manual.classList.add('hidden');
                        } else {
                            eqForm.desc.value = 'OTRO';
                            eqForm.desc_manual.value = equipoToEdit.desc;
                            eqForm.desc_manual.classList.remove('hidden');
                        }

                        eqForm.mtm.value = equipoToEdit.mtm || '';
                        eqForm.serie.value = equipoToEdit.serie || '';
                        eqForm.estado.value = equipoToEdit.estado || '';
                        eqForm.codigo.value = equipoToEdit.codigo || '';

                        editingEquipoId = id;
                        eqForm.btn.textContent = 'Actualizar Equipo';
                        eqForm.btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                        eqForm.btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    }
                }
            });

            changeExcelSearchBtn.addEventListener('click', () => {
                const searchTerm = changeExcelSearchInput.value.trim().toUpperCase();
                if (!searchTerm) { showModal('Atención', 'Por favor, ingrese una cédula o nombre para buscar.'); return; }
                if (nominaData.length === 0) { showModal('Atención', 'Por favor, cargue primero el archivo de Excel en el formulario principal.'); return; }

                const normalizedSearchTerm = normalizeCedula(searchTerm);

                const matchingUsers = nominaData.filter(user => {
                    const cedulaFromExcel = normalizeCedula(getSafeProp(user, 'Cedula'));
                    const nombre = String(getSafeProp(user, 'Colaborador') || '').trim().toUpperCase();
                    return cedulaFromExcel === normalizedSearchTerm || nombre.includes(searchTerm);
                });

                if (matchingUsers.length === 0) {
                    
                    //showModal('No Encontrado', 'Usuario no encontrado en la nómina.');
                    Swal.fire({
                        icon: 'skull-sharp',                             // Muestra el ícono de la palomita verde
                        title: '¡UPSS!',                            // El título principal
                        text: 'USUARIO NO ENCONTRADO 😢', // El texto secundario
                        timer: 2500,                                 // Se cierra automáticamente después de 2.5 segundos
                        showConfirmButton: false,                    // Oculta el botón "OK"
                        timerProgressBar: true                       // Muestra una barrita de progreso para el tiempo
                    });
                } else if (matchingUsers.length === 1) {
                    populateChangeForm(matchingUsers[0]);
                } else {
                    showUserSelectionModal(matchingUsers);
                }
            });

            function createEditableField(id, label, value) {
                return `
                  <div class="md:col-span-1">
                      <label for="change-${id}" class="block text-sm font-medium text-gray-700">${label}</label>
                      <input type="text" id="change-${id}" value="${value || ''}" class="mt-1 p-2 border rounded-md w-full bg-white">
                  </div>
              `;
            }

            function populateChangeForm(userData) {
                change_currentUserData = userData;

                document.getElementById('change-fecha').valueAsDate = new Date();

                changeContractDataContainer.innerHTML = `
                  ${createEditableField('nombre', 'Nombre', getSafeProp(userData, 'Colaborador'))}
                  ${createEditableField('cedula', 'Cédula', normalizeCedula(getSafeProp(userData, 'Cedula')))}
                  ${createEditableField('usuario', 'Usuario', getSafeProp(userData, 'Usuario'))}
                  ${createEditableField('correo', 'Correo', getSafeProp(userData, 'E-mail'))}
                  ${createEditableField('empresa', 'Empresa', getSafeProp(userData, 'Centro de costo'))}
                  ${createEditableField('departamento', 'Departamento', getSafeProp(userData, 'Cargo'))}
                  ${createEditableField('ciudad', 'Ciudad', getSafeProp(userData, 'Ciudad trabajo'))}
                  ${createEditableField('ubicacion', 'Ubicación', getSafeProp(userData, 'Area'))}
                  ${createEditableField('jefatura', 'Jefatura', getSafeProp(userData, 'Jefatura'))}
              `;
                const userAssets = activosData.filter(asset => normalizeCedula(getSafeProp(asset, 'ok cedula')) === normalizeCedula(getSafeProp(userData, 'Cedula')));

                change_assignedEquipos = userAssets.flatMap(asset => {
                    const equiposExtraidos = [];
                    const extractSerial = (value) => {
                        if (!value || typeof value !== 'string') return '';
                        if (value.toUpperCase().startsWith('CA-')) {
                            const tjIndex = value.toUpperCase().indexOf('TJ');
                            if (tjIndex !== -1) return value.substring(tjIndex + 2);
                        }
                        const parts = value.split('-');
                        return parts[parts.length - 1];
                    };

                    const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                    const tiposDeComputadora = ['PC', 'NOTEBOOK', 'LAPTOP', 'IMAC', 'MAC STUDIO', 'MACBOOK', 'MACBOOKPRO', 'WORKSTATION'];
                    /*
                    if (componente === 'PC' || componente === 'NOTEBOOK' || componente === 'LAPTOP') {
                        equiposExtraidos.push({ id: Math.random(), tipo: (componente === 'NOTEBOOK' || componente === 'LAPTOP') ? 'LAPTOP' : 'PC', marca: getSafeProp(asset, 'MARCA'), desc: getSafeProp(asset, 'Modelo Consenso'), mtm: getSafeProp(asset, 'Modelo MTM'), serie: getSafeProp(asset, 'SERIE PC'), codigo: getSafeProp(asset, 'Código de activo del equipo'), estado: 'USADO' });
                    }
                    */

                    if (tiposDeComputadora.includes(componente)) {
                        equiposExtraidos.push({ 
                            id: Math.random(), 
                            tipo: (componente === 'NOTEBOOK') ? 'LAPTOP' : componente, 
                            marca: getSafeProp(asset, 'MARCA'), 
                            desc: getSafeProp(asset, 'Modelo Consenso'), 
                            mtm: getSafeProp(asset, 'Modelo MTM'), 
                            serie: getSafeProp(asset, 'SERIE PC'), 
                            codigo: getSafeProp(asset, 'Código de activo del equipo'), 
                            estado: 'USADO' 
                        });
                    }

                    if (getSafeProp(asset, 'SERIE MONITOR')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'MONITOR', marca: 'NA', desc: getSafeProp(asset, 'Tipo Monitor'), mtm: 'NA', serie: getSafeProp(asset, 'SERIE MONITOR'), codigo: getSafeProp(asset, 'Código de activo del Monitor'), estado: 'USADO' });
                    }
                    if (getSafeProp(asset, 'Código de activo del teclado')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'TECLADO', marca: 'NA', desc: 'TECLADO', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')), codigo: getSafeProp(asset, 'Código de activo del teclado'), estado: 'USADO' });
                    }
                    if (getSafeProp(asset, 'Código de activo del Mouse')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'RATÓN', marca: 'NA', desc: 'MOUSE', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')), codigo: getSafeProp(asset, 'Código de activo del Mouse'), estado: 'USADO' });
                    }
                    if (getSafeProp(asset, 'Código de activo del Cargador')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'CARGADOR', marca: 'NA', desc: 'CARGADOR', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')), codigo: getSafeProp(asset, 'Código de activo del Cargador'), estado: 'USADO' });
                    }
                    return equiposExtraidos;
                }).filter(eq => eq.serie && eq.serie !== 'N/A');

                change_assignedCurrentPage = 1;
                change_assignedSearchTerm = '';
                changeAssignedSearchInput.value = '';
                renderChangeAssignedTable();
                updateChangePreview();
                updateChangeSummaryTables();
            }

            function renderChangeAssignedTable() {
                changeAssignedList.innerHTML = '';

                const filteredEquipos = change_assignedEquipos.filter(eq => {
                    const term = change_assignedSearchTerm.toLowerCase();
                    return (eq.tipo || '').toLowerCase().includes(term) || (eq.serie || '').toLowerCase().includes(term);
                });

                const totalPages = Math.ceil(filteredEquipos.length / CHANGE_ITEMS_PER_PAGE);
                const startIndex = (change_assignedCurrentPage - 1) * CHANGE_ITEMS_PER_PAGE;
                const endIndex = startIndex + CHANGE_ITEMS_PER_PAGE;
                const paginatedEquipos = filteredEquipos.slice(startIndex, endIndex);

                if (paginatedEquipos.length === 0) {
                    changeAssignedList.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-gray-500">No se encontraron activos.</td></tr>`;
                } else {
                    paginatedEquipos.forEach(eq => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                          <td class="p-2 text-center"><input type="checkbox" class="change-retire-check" data-id="${eq.id}"></td>
                          <td class="p-2">${eq.tipo}</td>
                          <td class="p-2">${eq.serie}</td>
                      `;
                        changeAssignedList.appendChild(row);
                    });
                }

                changePageInfo.textContent = `Página ${change_assignedCurrentPage} de ${totalPages || 1}`;
                changePrevPageBtn.disabled = change_assignedCurrentPage === 1;
                changeNextPageBtn.disabled = change_assignedCurrentPage >= totalPages;
            }

            changeAssignedSearchInput.addEventListener('input', () => {
                change_assignedSearchTerm = changeAssignedSearchInput.value;
                change_assignedCurrentPage = 1;
                renderChangeAssignedTable();
            });

            changePrevPageBtn.addEventListener('click', () => {
                if (change_assignedCurrentPage > 1) {
                    change_assignedCurrentPage--;
                    renderChangeAssignedTable();
                }
            });

            changeNextPageBtn.addEventListener('click', () => {
                const filteredEquipos = change_assignedEquipos.filter(eq => eq.tipo.toLowerCase().includes(change_assignedSearchTerm) || eq.serie.toLowerCase().includes(change_assignedSearchTerm));
                const totalPages = Math.ceil(filteredEquipos.length / CHANGE_ITEMS_PER_PAGE);
                if (change_assignedCurrentPage < totalPages) {
                    change_assignedCurrentPage++;
                    renderChangeAssignedTable();
                }
            });

            function renderChangeAddedTable() {
                changeAddedList.innerHTML = '';
                change_addedEquipos.forEach(eq => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                      <td class="p-2 text-center"><input type="radio" name="change-deliver-radio" class="change-deliver-radio" data-id="${eq.id}"></td>
                      <td class="p-2">${eq.tipo}</td>
                      <td class="p-2">${eq.serie}</td>
                      <td class="p-2 text-center"><button type="button" class="text-red-500 font-bold change-delete-added" data-id="${eq.id}">X</button></td>
                  `;
                    changeAddedList.appendChild(row);
                });
            }

            changeAddEquipoBtn.addEventListener('click', () => {
                const tipoValue = changeEqForm.tipo.value;
                const tipoFinal = tipoValue === 'OTRO' ? changeEqForm.tipo_manual.value : tipoValue;

                if (!tipoFinal || !changeEqForm.serie.value) {
                    showModal('Atención', 'El Tipo y la Serie son obligatorios para agregar un nuevo equipo.');
                    return;
                }
                change_addedEquipos.push({
                    id: Math.random(),
                    tipo: tipoFinal,
                    marca: changeEqForm.marca.value,
                    desc: changeEqForm.desc.value,
                    mtm: changeEqForm.mtm.value,
                    serie: changeEqForm.serie.value,
                    estado: changeEqForm.estado.value,
                    codigo: changeEqForm.codigo.value
                });
                renderChangeAddedTable();
                changeEqForm.tipo.value = '';
                changeEqForm.tipo_manual.value = '';
                changeEqForm.marca.value = '';
                changeEqForm.desc.value = '';
                changeEqForm.mtm.value = '';
                changeEqForm.serie.value = '';
                changeEqForm.estado.value = '';
                changeEqForm.codigo.value = '';
                changeEqForm.tipo_manual.classList.add('hidden');
            });

            changeAddedList.addEventListener('click', e => {
                if (e.target.classList.contains('change-delete-added')) {
                    const id = Number(e.target.dataset.id);
                    change_addedEquipos = change_addedEquipos.filter(eq => eq.id !== id);
                    renderChangeAddedTable();
                    updateChangePreview();
                }
            });

            async function getChangeFormData() {
                const retiredChecks = document.querySelectorAll('.change-retire-check:checked');
                const retiredIds = Array.from(retiredChecks).map(chk => Number(chk.dataset.id));
                const retiredItems = change_assignedEquipos.filter(eq => retiredIds.includes(eq.id));

                const deliverRadio = document.querySelector('.change-deliver-radio:checked');
                let deliveredItem = null;
                if (deliverRadio) {
                    const deliverId = Number(deliverRadio.dataset.id);
                    deliveredItem = change_addedEquipos.find(eq => eq.id === deliverId);
                }

                return {
                    type: 'change',
                    acta_n: document.getElementById('change-acta_n').value,
                    fecha: document.getElementById('change-fecha').value,
                    tecnico_responsable: document.getElementById('change-tecnico_responsable').value,
                    ticket: document.getElementById('change-ticket').value,
                    observaciones: document.getElementById('change-observaciones').value,

                    usuario: document.getElementById('change-usuario')?.value || '',
                    nombre: document.getElementById('change-nombre')?.value || '',
                    cedula: document.getElementById('change-cedula')?.value || '',
                    ciudad: document.getElementById('change-ciudad')?.value || '',
                    ubicacion: document.getElementById('change-ubicacion')?.value || '',
                    empresa: document.getElementById('change-empresa')?.value || '',
                    departamento: document.getElementById('change-departamento')?.value || '',
                    correo: document.getElementById('change-correo')?.value || '',
                    jefatura: document.getElementById('change-jefatura')?.value || '',

                    equiposRetirados: retiredItems,
                    equiposNuevosAgregados: change_addedEquipos,
                    equipoEntregadoId: deliveredItem ? deliveredItem.id : null,
                    equiposAsignadosOriginalmente: change_assignedEquipos,
                    fotosEntregado: change_fotosEntregado,
                    fotosRetirado: change_fotosRetirado,
                };
            }

            async function updateChangePreview() {
                if (!change_currentUserData && !document.getElementById('change-nombre')?.value) {
                    changePreviewContent.innerHTML = '<p class="text-center text-gray-500">Busque un colaborador para iniciar.</p>';
                    return;
                }

                const data = await getChangeFormData();

                const retiredItems = data.equiposRetirados;

                const retiredIds = retiredItems.map(eq => eq.id);
                const maintainedItems = data.equiposAsignadosOriginalmente.filter(eq => !retiredIds.includes(eq.id));

                let deliveredItem = null;
                if (data.equipoEntregadoId) {
                    deliveredItem = data.equiposNuevosAgregados.find(eq => eq.id === data.equipoEntregadoId);
                }

                changePreviewContent.innerHTML = await getChangePreviewHtml(data, retiredItems, deliveredItem, maintainedItems);
            }

            async function getChangePreviewHtml(data, retiredItems, deliveredItem, maintainedItems) {
                const formattedDate = data.fecha ? new Date(data.fecha + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const tecnicoSeleccionado = tecnicos.find(t => t.cedula === data.tecnico_responsable) || { nombre: '', cedula: '' };

                const retiredRows = retiredItems.map(e => `<tr><td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td><td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.estado || ''}</td><td>${e.codigo || 'NA'}</td></tr>`).join('');

                let deliveredRows = '<tr><td colspan="7" class="text-center">-- Sin equipo nuevo seleccionado para entregar --</td></tr>';
                if (deliveredItem) {
                    deliveredRows = `<tr><td>${deliveredItem.tipo || ''}</td><td>${deliveredItem.mtm || 'NA'}</td><td>${deliveredItem.marca || ''}</td><td>${deliveredItem.desc || ''}</td><td>${deliveredItem.serie || 'NA'}</td><td>${deliveredItem.estado || ''}</td><td>${deliveredItem.codigo || 'NA'}</td></tr>`;
                }

                const maintainedRows = maintainedItems.map(e => `<tr><td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td><td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.estado || ''}</td><td>${e.codigo || 'NA'}</td></tr>`).join('');

                const firmaIzquierda = { titulo: 'FIRMA CONFORME (USUARIO)', nombre: data.nombre, cedula: data.cedula };
                const firmaDerecha = { titulo: 'FIRMA CONFORME (TÉCNICO)', nombre: tecnicoSeleccionado.nombre, cedula: tecnicoSeleccionado.cedula };

                const photoItemsEntregado = (data.fotosEntregado || []).map(base64 =>
                    `<div class="photo-item"><img src="${base64}" alt="Fotografía del acta"></div>`
                ).join('');
                const photoItemsRetirado = (data.fotosRetirado || []).map(base64 =>
                    `<div class="photo-item"><img src="${base64}" alt="Fotografía del acta"></div>`
                ).join('');

                const photoGalleryHTMLEntregado = data.fotosEntregado.length > 0 ? `<h2 style="margin-top: 20px;">FOTOGRAFÍAS ACTIVOS ENTREGADOS</h2><div class="photo-gallery">${photoItemsEntregado}</div>` : '';
                const photoGalleryHTMLRetirado = data.fotosRetirado.length > 0 ? `<h2 style="margin-top: 20px;">FOTOGRAFÍAS ACTIVOS RETIRADOS</h2><div class="photo-gallery">${photoItemsRetirado}</div>` : '';


                const signatureHTML = `<table style="width: 100%; margin-top: 80px; page-break-inside: avoid; border: none !important;">
                                      <tbody>
                                          <tr>
                                              <td style="width: 50%; text-align: center; border: none !important; vertical-align: bottom; padding: 0 15px;">
                                                  <div style="height: 80px;"></div>
                                                  <div style="border-top: 1px solid black; margin-bottom: 8px;"></div>
                                                  <p style="text-align: center; margin: 0; font-size: 10pt; line-height: 1.4;">
                                                      <strong>${firmaIzquierda.titulo}</strong><br>${firmaIzquierda.nombre || 'NA'}<br>CI: ${firmaIzquierda.cedula || 'NA'}
                                                  </p>
                                              </td>
                                              <td style="width: 50%; text-align: center; border: none !important; vertical-align: bottom; padding: 0 15px;">
                                                  <div style="height: 80px;"></div>
                                                  <div style="border-top: 1px solid black; margin-bottom: 8px;"></div>
                                                  <p style="text-align: center; margin: 0; font-size: 10pt; line-height: 1.4;">
                                                      <strong>${firmaDerecha.titulo}</strong><br>${firmaDerecha.nombre || 'NA'}<br>CI: ${firmaDerecha.cedula || 'NA'}
                                                  </p>
                                              </td>
                                          </tr>
                                      </tbody>
                                   </table>`;

                return `<div>
                  <div id="acta-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid rgba(24,121,174,1); margin-bottom: 15px;">
                      <div style="width: 4cm;"></div>
                      <h1 style="font-size: 16pt; font-weight: bold; color: rgba(24,121,174,1); margin: 0; padding: 0; border: none; text-align: center; flex-grow: 1;">ACTA DE CAMBIO DE EQUIPOS</h1>
                      <img src="consenso.png" alt="Logo Consenso" style="height: 1.5cm; object-fit: contain; max-width: 4cm;">
                  </div>
                  <table class="data-table" style="border: 1px solid rgba(24,121,174,1);">
                       <thead><tr><th colspan="8" style="background-color: rgba(24,121,174,1); color: white; text-align: center; font-size: 11pt;">DATOS DEL CONTRATO</th></tr></thead>
                       <tbody>
                          <tr><td class="label">Nro. Acta:</td><td>${data.acta_n}</td><td class="label">Fecha:</td><td>${formattedDate}</td><td class="label">Generado por:</td><td colspan="3">${tecnicoSeleccionado.nombre}</td></tr>
                          <tr><td class="label">Usuario:</td><td>${data.usuario}</td><td class="label">Nombre:</td><td colspan="3">${data.nombre}</td><td class="label">Ciudad:</td><td>${data.ciudad}</td></tr>
                          <tr><td class="label">Empresa:</td><td>${data.empresa}</td><td class="label">C.I.:</td><td colspan="3">${data.cedula}</td><td class="label">Ubicación:</td><td>${data.ubicacion}</td></tr>
                           <tr><td class="label">Correo:</td><td>${data.correo}</td><td class="label">Jefe:</td><td colspan="3">${data.jefatura}</td><td class="label">Ticket:</td><td>${data.ticket}</td></tr>
                           <tr><td class="label" style="background-color: rgba(24,121,174,1); color: white;">OBSERVACIONES</td><td colspan="7">${data.observaciones}</td></tr>
                      </tbody>
                  </table>

                  <h2>EQUIPOS RETIRADOS</h2>
                  <table class="equipment-table">
                      <thead><tr><th>Tipo</th><th>MTM/SKU</th><th>Marca</th><th>Descripción</th><th>Serie</th><th>Estado</th><th>Código de activo</th></tr></thead>
                      <tbody>${retiredRows.length > 0 ? retiredRows : '<tr><td colspan="7" class="text-center">-- Sin equipos retirados --</td></tr>'}</tbody>
                  </table>

                  <h2>EQUIPO A ENTREGAR</h2>
                  <table class="equipment-table">
                      <thead><tr><th>Tipo</th><th>MTM/SKU</th><th>Marca</th><th>Descripción</th><th>Serie</th><th>Estado</th><th>Código de activo</th></tr></thead>
                      <tbody>${deliveredRows}</tbody>
                  </table>

                  <h2>Equipos que Mantiene el Usuario</h2>
                  <table class="equipment-table">
                      <thead><tr><th>Tipo</th><th>MTM/SKU</th><th>Marca</th><th>Descripción</th><th>Serie</th><th>Estado</th><th>Código de activo</th></tr></thead>
                      <tbody>${maintainedRows.length > 0 ? maintainedRows : '<tr><td colspan="7" class="text-center">-- Sin equipos --</td></tr>'}</tbody>
                  </table>

                  ${photoGalleryHTMLEntregado}
                  ${photoGalleryHTMLRetirado}
                  <div class="clausulas-container"><div class="legal-text">${legalTextHTML}</div></div>
                  ${signatureHTML}
              </div>`;
            }

            document.getElementById('change-view').addEventListener('input', updateChangePreview);

            async function renderSavedActasList(searchTerm = '') {
                const allDrafts = await window.api.getDrafts(searchTerm);
                listaActasGuardadas.innerHTML = '';

                const draftsToShow = searchTerm.trim() === '' ? allDrafts.slice(0, 4) : allDrafts;

                if (draftsToShow.length === 0) {
                    listaActasGuardadas.innerHTML = '<p class="text-sm text-gray-500">No se encontraron borradores.</p>';
                    return;
                }
                draftsToShow.forEach(draft => {
                    const draftEl = document.createElement('div');
                    draftEl.className = 'flex items-center justify-between p-2 bg-white border rounded-md';
                    draftEl.innerHTML = `
                      <div>
                          <p class="font-semibold text-gray-800">${draft.acta_n || 'SIN N°'}</p>
                          <p class="text-sm text-gray-600">${draft.nombre || 'Sin usuario'}</p>
                      </div>
                      <div class="space-x-2">
                          <button title="Cargar Borrador" class="load-btn text-blue-500 hover:text-blue-700" data-id="${draft.acta_n}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                          <button title="Eliminar Borrador" class="delete-draft-btn text-red-500 hover:red-700" data-id="${draft.acta_n}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                      </div>`;
                    listaActasGuardadas.appendChild(draftEl);
                });
            }

            async function renderSavedActasDashboard(searchTerm = '') {
                const drafts = await window.api.getDrafts(searchTerm);
                const tableBody = document.querySelector('#saved-actas-table tbody');
                tableBody.innerHTML = '';

                if (drafts.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8">No se encontraron borradores.</td></tr>`;
                    return;
                }

                drafts.forEach(draft => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    const formattedDate = draft.fecha ? new Date(draft.fecha + 'T00:00:00').toLocaleDateString('es-ES') : 'N/A';
                    const tipo = (draft.type === 'change') ? 'Cambio' : (draft.tipo_acta || 'Estándar');

                    row.innerHTML = `
                      <td class="px-6 py-4 font-medium text-gray-900">${draft.acta_n || 'SIN N°'}</td>
                      <td class="px-6 py-4">${tipo}</td>
                      <td class="px-6 py-4">${draft.nombre || 'Sin colaborador'}</td>
                      <td class="px-6 py-4">${formattedDate}</td>
                      <td class="px-6 py-4 text-center">
                          <button title="Editar Borrador" class="edit-saved-draft-btn text-indigo-600 hover:text-indigo-900 font-semibold py-1 px-3" data-id="${draft.acta_n}">Editar</button>
                          <button title="Eliminar Borrador" class="delete-saved-draft-btn text-red-600 hover:text-red-900 font-semibold py-1 px-3 ml-4" data-id="${draft.acta_n}">Eliminar</button>
                      </td>
                  `;
                    tableBody.appendChild(row);
                });
            }

            async function renderFinalizedActasDashboard(searchTerm = '') {
                const finalizedActas = await window.api.getFinalizedActas(searchTerm);
                const tableBody = document.querySelector('#finalized-actas-table tbody');
                tableBody.innerHTML = '';

                if (finalizedActas.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8">No se encontraron actas finalizadas.</td></tr>`;
                    return;
                }

                finalizedActas.forEach(acta => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    const formattedDate = acta.fecha ? new Date(acta.fecha + 'T00:00:00').toLocaleDateString('es-ES') : 'N/A';

                    row.innerHTML = `
                      <td class="px-6 py-4 font-medium text-gray-900">${acta.acta_n || 'SIN N°'}</td>
                      <td class="px-6 py-4">${acta.tipo_acta || 'N/A'}</td>
                      <td class="px-6 py-4">${acta.nombre || 'Sin colaborador'}</td>
                      <td class="px-6 py-4">${formattedDate}</td>
                      <td class="px-6 py-4 text-center">
                          <button title="Ver PDF" class="view-pdf-btn text-blue-600 hover:text-blue-900 font-semibold py-1 px-3" data-path="${acta.pdf_path || ''}">Ver PDF</button>
                          <button title="Editar Acta" class="edit-finalized-btn text-indigo-600 hover:text-indigo-900 font-semibold py-1 px-3 ml-4" data-id="${acta.acta_n}">Editar</button>
                      </td>
                  `;
                    tableBody.appendChild(row);
                });
            }

            async function handlePreguardar() {
                const actaData = await getFormData();
                if (!actaData.acta_n) {
                    showErrorModal('Atención', 'Por favor, ingrese un N° ACTA para poder guardar el borrador.');
                    return;
                }
                const result = await window.api.saveDraft({ acta: actaData, equipos: equipos });
                if (result.success) {
                    //showModal('Éxito', `Borrador ${actaData.acta_n} guardado correctamente.`);
                    showSuccessToast(`Borrador ${actaData.acta_n} guardado correctamente.`);
                    renderSavedActasList();
                } else {
                    //showModal('Error', `No se pudo guardar el borrador: ${result.message}`);
                    showErrorModal('Error al Guardar', `No se pudo guardar el borrador: ${result.message}`);
                }
            }

            async function populateChangeViewWithDraft(draftData) {
                // Limpiar formulario de cambio
                document.getElementById('change-acta_n').value = draftData.acta_n || '';
                document.getElementById('change-fecha').value = draftData.fecha || '';
                document.getElementById('change-tecnico_responsable').value = draftData.tecnico_responsable || '';
                document.getElementById('change-ticket').value = draftData.ticket || '';
                document.getElementById('change-observaciones').value = draftData.observaciones || '';

                // Recrear campos editables
                changeContractDataContainer.innerHTML = `
                   ${createEditableField('nombre', 'Nombre', draftData.nombre)}
                   ${createEditableField('cedula', 'Cédula', draftData.cedula)}
                   ${createEditableField('usuario', 'Usuario', draftData.usuario)}
                   ${createEditableField('correo', 'Correo', draftData.correo)}
                   ${createEditableField('empresa', 'Empresa', draftData.empresa)}
                   ${createEditableField('departamento', 'Departamento', draftData.departamento)}
                   ${createEditableField('ciudad', 'Ciudad', draftData.ciudad)}
                   ${createEditableField('ubicacion', 'Ubicación', draftData.ubicacion)}
                   ${createEditableField('jefatura', 'Jefatura', draftData.jefatura)}
               `;

                // Restaurar datos de equipos
                change_assignedEquipos = draftData.equiposAsignadosOriginalmente || [];
                change_addedEquipos = draftData.equiposNuevosAgregados || [];
                change_fotosEntregado = draftData.fotosEntregado || [];
                change_fotosRetirado = draftData.fotosRetirado || [];

                renderChangeAssignedTable();
                renderChangeAddedTable();
                updateChangePreview();
                updateChangeSummaryTables();
            }
// ✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
/*
            async function loadDraft(acta_n) {
                try {
                    const result = await window.api.loadDraft(acta_n);
                    if (!result || !result.success) {
                        showModal('Error', `No se pudo cargar el borrador: ${result ? result.message : 'Respuesta inválida del backend.'}`);
                        return false;
                    }

                    if (result.acta.type === 'change') {
                        await populateChangeViewWithDraft(result.acta);
                        switchView('change-view');
                        showModal('Éxito', `Borrador de Cambio '${acta_n}' cargado.`);
                        return true;
                    }

                    clearFormFields(false);

                    const acta = result.acta;

                    allFormInputIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && acta[id] !== undefined && acta[id] !== null) {
                            el.value = acta[id];
                        }
                    });

                    if (acta.correo && acta.correo.includes('@')) {
                        const [user, domain] = acta.correo.split('@');
                        correoUsuarioInput.value = user || '';

                        const isStandardDomain = Array.from(correoDominioSelect.options).some(opt => opt.value === domain);

                        if (isStandardDomain) {
                            correoDominioSelect.value = domain;
                        } else {
                            correoDominioSelect.value = 'otro';
                            correoDominioManual.value = domain || '';
                        }

                        const isOtro = correoDominioSelect.value === 'otro';
                        correoDominioManual.classList.toggle('hidden', !isOtro);
                        correoDominioSelect.classList.toggle('rounded-r-md', isOtro);

                    } else {
                        correoUsuarioInput.value = '';
                        correoDominioSelect.value = domainOptions[0];
                        correoDominioManual.classList.add('hidden');
                        correoDominioSelect.classList.remove('rounded-r-md');
                    }

                    firmarJefaturaCheck.checked = !!acta.firmar_jefatura;
                    jefaturaFirmaContainer.classList.toggle('hidden', !firmarJefaturaCheck.checked);

                    salidaPersonalCheck.checked = (acta.observaciones || '').includes('SALIDA DE PERSONAL');

                    equipos = result.equipos || [];
                    equipos.forEach(eq => {
                        eq.dano = !!eq.dano;
                        eq.faltante = !!eq.faltante;
                        // Restaurar idPaquete correctamente
                        if (acta.equipos) {
                            const actaEquipo = acta.equipos.find(ae => ae.id === eq.id);
                            if (actaEquipo) {
                                eq.idPaquete = actaEquipo.idPaquete;
                            }
                        }
                    });

                    // Cargar información de retiro específico
                    if (acta.tipoRetiro) {
                        tipoRetiro = acta.tipoRetiro;
                        if (acta.tipoRetiro === 'especificos') {
                            retiroEspecificosRadio.checked = true;
                            retiroTodosRadio.checked = false;
                            activosParaRetiro = acta.activosParaRetiro || [];
                            retiroActivosList.classList.remove('hidden');
                        } else {
                            retiroTodosRadio.checked = true;
                            retiroEspecificosRadio.checked = false;
                            activosParaRetiro = [];
                            retiroActivosList.classList.add('hidden');
                        }
                    }

                    // Cargar información de tipo de entrega
                    if (acta.tipoEntrega) {
                        tipoEntrega = acta.tipoEntrega;
                        if (acta.tipoEntrega === 'activos') {
                            entregaActivosRadio.checked = true;
                            entregaCompletoRadio.checked = false;
                            equiposEntregados = acta.equiposEntregados || [];
                            activosMantiene = acta.activosMantiene || [];
                            equiposEntregadosSection.classList.remove('hidden');
                            activosMantienesSection.classList.remove('hidden');
                            renderEquiposEntregados();
                            renderActivosMantiene();
                        } else {
                            entregaCompletoRadio.checked = true;
                            entregaActivosRadio.checked = false;
                            equiposEntregadosSection.classList.add('hidden');
                            activosMantienesSection.classList.add('hidden');
                        }
                    }

                    fotosParaActa = (acta.fotos || []).map(b64 => ({ type: 'base64', data: b64, id: Math.random() }));

                    renderEquiposList();
                    renderFotosUnificadas();
                    toggleRetiroPanel(); // Mostrar panel si es retiro
                    toggleEntregaPanel(); // Mostrar panel si es entrega
                    updatePreview();

                    return true;

                } catch (error) {
                    console.error("Error al cargar borrador:", error);
                    showModal('Error', 'Ocurrió un error crítico al intentar cargar el borrador. Revise la consola para más detalles.');
                    return false;
                }
            }
*/
            // ✅ VERSIÓN MEJORADA DE loadDraft
            async function loadDraft(acta_n) {
                try {
                    const result = await window.api.loadDraft(acta_n);
                    if (!result || !result.success) {
                        showErrorModal('Error al Cargar', `No se pudo cargar el acta: ${result ? result.message : 'Respuesta inválida.'}`);
                        return null; // Devuelve null si falla
                    }

                    clearFormFields(false);
                    const acta = result.acta;

                    // Lógica para llenar el formulario principal
                    allFormInputIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && acta[id] !== undefined && acta[id] !== null) {
                            if (el.type === 'checkbox') {
                                el.checked = !!acta[id];
                            } else {
                                el.value = acta[id];
                            }
                        }
                    });

                    if (acta.correo && acta.correo.includes('@')) {
                        const [user, domain] = acta.correo.split('@');
                        correoUsuarioInput.value = user || '';
                        const isStandardDomain = Array.from(correoDominioSelect.options).some(opt => opt.value === domain);
                        if (isStandardDomain) {
                            correoDominioSelect.value = domain;
                        } else {
                            correoDominioSelect.value = 'otro';
                            correoDominioManual.value = domain || '';
                        }
                        correoDominioSelect.dispatchEvent(new Event('change'));
                    }
                    
                    equipos = result.equipos || [];
                    renderEquiposList();
                    updatePreview();
                    
                    return result; // ¡Importante! Devuelve el objeto completo con los datos

                } catch (error) {
                    showErrorModal('Error Crítico', 'Ocurrió un error al intentar cargar el acta.');
                    return null;
                }
            }
// ✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅
            const toBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });

            function renderFotosUnificadas() {
                const previewContainer = document.getElementById('fotos-unificadas-preview');
                previewContainer.innerHTML = '';

                if (fotosParaActa.length === 0) {
                    previewContainer.innerHTML = '<p class="text-sm text-gray-500 col-span-full text-center">No hay fotos cargadas.</p>';
                    return;
                }

                fotosParaActa.forEach(item => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-item';

                    const img = document.createElement('img');

                    if (item.type === 'base64') {
                        img.src = item.data;
                    } else {
                        img.src = URL.createObjectURL(item.data);
                    }
                    img.alt = "Fotografía del acta";

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete-photo-btn';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Eliminar foto';
                    deleteBtn.dataset.id = item.id;

                    photoDiv.appendChild(img);
                    photoDiv.appendChild(deleteBtn);
                    previewContainer.appendChild(photoDiv);
                });
            }

            document.getElementById('fotos-unificadas-preview').addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-photo-btn')) {
                    const photoId = Number(e.target.dataset.id);
                    fotosParaActa = fotosParaActa.filter(p => p.id !== photoId);
                    renderFotosUnificadas();
                    updatePreview();
                }
            });

            document.getElementById('fotos-input').addEventListener('change', (e) => {
                const newFiles = Array.from(e.target.files);
                newFiles.forEach(file => {
                    fotosParaActa.push({ type: 'file', data: file, id: Math.random() });
                });

                e.target.value = '';

                renderFotosUnificadas();
                updatePreview();
            });

            function handleDeleteOrLoad(e) {
                const loadBtn = e.target.closest('.load-btn');
                const deleteBtn = e.target.closest('.delete-draft-btn');
                if (loadBtn) {
                    loadDraft(loadBtn.dataset.id);
                }
                if (deleteBtn) {
                    const draftId = deleteBtn.dataset.id;
                    showModal('Confirmar Eliminación', `¿Seguro que quieres eliminar el borrador ${draftId}?`, [
                        { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                        {
                            text: 'Eliminar', class: 'bg-red-600 hover:bg-red-700', action: async () => {
                                await window.api.deleteDraft(draftId);
                                renderSavedActasList();
                                if (document.getElementById('saved-actas-view').classList.contains('active')) {
                                    renderSavedActasDashboard();
                                }
                                hideModal();
                            }
                        }
                    ]);
                }
            }

            listaActasGuardadas.addEventListener('click', handleDeleteOrLoad);
//-----------------------------------------------------------------

//----------------------------------------------------------------------

//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
/*
            function showModal(title, message, buttons = [{ text: 'OK', class: 'bg-blue-500 hover:bg-blue-600', action: hideModal }], type = 'default') {
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                modalButtons.innerHTML = '';

                if (type === 'progress') {
                    modalProgressContainer.classList.remove('hidden');
                    modalMessage.classList.add('hidden');
                    modalButtons.classList.add('hidden');
                } else {
                    modalProgressContainer.classList.add('hidden');
                    modalMessage.classList.remove('hidden');
                    modalButtons.classList.remove('hidden');
                    buttons.forEach(btnInfo => {
                        const button = document.createElement('button');
                        button.textContent = btnInfo.text;
                        button.className = `text-white font-bold py-2 px-4 rounded-md ${btnInfo.class}`;
                        button.onclick = btnInfo.action;
                        modalButtons.appendChild(button);
                    });
                }

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            }
 */
            // ✅✅ INICIO DE LA SECCIÓN DE NOTIFICACIONES MODERNAS ✅✅
        
        // Función para errores generales
        function showErrorModal(title, message) {
            Swal.fire({
                title: `🚫 ${title}`,
                html: message,
                icon: 'error',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#e74c3c',
                showClass: {
                    popup: 'animate__animated animate__shakeX'
                }
            });
        }

        // Función para notificaciones rápidas de éxito (Toasts)
        function showSuccessToast(title) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
            Toast.fire({
                icon: 'success',
                title: title
            });
        }

        // Función para mostrar un modal de "cargando"
        function showLoadingModal(title, message) {
            Swal.fire({
                title: `⏳ ${title}`,
                html: `<div style="text-align: center; padding: 20px;"><div style="margin-bottom: 25px;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div></div><p style="color: #7f8c8d;">${message}</p></div><style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>`,
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                showClass: {
                    popup: 'animate__animated animate__zoomIn'
                }
            });
        }
        
        // Función para cerrar cualquier modal de SweetAlert
        function hideLoadingModal() {
            Swal.close();
        }
        function credencialesIncorrectas() {
            Swal.fire({
                title: '🚫 Acceso Denegado',
                html: `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">🔐</div>
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">Credenciales Incorrectas</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">El usuario o la contraseña son incorrectos.</p>
                        <div style="background: #fee; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 5px;">
                            <p style="margin: 0; color: #c0392b; font-size: 14px;">
                                ⚠️ Por favor, inténtalo de nuevo.
                            </p>
                        </div>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: 'Intentar de Nuevo',
                confirmButtonColor: '#e74c3c',
                backdrop: 'rgba(231,76,60,0.1)',
                showClass: {
                    popup: 'animate__animated animate__shakeX'
                }
            });
        }

        // Función para pedir confirmación
        function showConfirmModal(title, message, confirmButtonText, onConfirm) {
            Swal.fire({
                title: `🗑️ ${title}`,
                html: `<p style="padding: 20px; color: #555;">${message}</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: confirmButtonText,
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#6c757d',
                focusCancel: true,
                showClass: {
                    popup: 'animate__animated animate__headShake'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    onConfirm(); // Ejecuta la función que le pasamos si el usuario confirma
                }
            });
        }

        // Función de éxito más detallada (inspirada en tu ejemplo 'archivoSubido')
        function showDetailedSuccessModal(title, user, source, resultsCount) {
             Swal.fire({
                title: `<strong>${title}</strong>`,
                icon: 'success',
                html: `
                    <div class="text-left space-y-3 p-4">
                        <div class="flex items-center"><span class="font-bold w-28">👤 Usuario:</span><span>${user}</span></div>
                        <div class="flex items-center"><span class="font-bold w-28">📊 Fuente:</span><span>${source}</span></div>
                        <div class="flex items-center"><span class="font-bold w-28">📈 Resultados:</span><span class="font-semibold text-green-600">${resultsCount} activos encontrados</span></div>
                        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center text-green-800">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span>Procesamiento completado sin errores</span>
                        </div>
                    </div>
                `,
                showConfirmButton: false,    // Ocultamos el botón "Continuar"
                timer: 3000,                 // La alerta se cerrará en 3000 milisegundos (3 segundos)
                timerProgressBar: true 
            });
        }
        
        // ✅✅ FIN DE LA SECCIÓN DE NOTIFICACIONES ✅✅

 //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            function updateModalProgress(percentage, text) {
                modalProgressBar.style.width = `${percentage}%`;
                modalProgressBar.textContent = `${percentage}%`;
                modalProgressText.textContent = text;
            }
            //------------------------------------------------------------

            function showSuccessModal(title, user, source, resultsCount) {
                Swal.fire({
                    title: `<strong>${title}</strong>`,
                    icon: 'success',
                    html: `
                        <div class="text-left space-y-3 p-4">
                            <div class="flex items-center">
                                <span class="font-bold w-28">👤 Usuario:</span>
                                <span>${user}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold w-28">📊 Fuente:</span>
                                <span>${source}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold w-28">📈 Resultados:</span>
                                <span class="font-semibold text-green-600">${resultsCount} activos encontrados</span>
                            </div>
                            <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center text-green-800">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                <span>Procesamiento completado sin errores</span>
                            </div>
                        </div>
                    `,
                    showConfirmButton: true,
                    confirmButtonText: 'Continuar',
                    confirmButtonColor: '#28a745',
                    timer: 3000,
                    timerProgressBar: true
                });
            }

            //------------------------------------------------------------
            function extractEquiposFromAssets(assets) {
                const equiposExtraidos = [];
                if (!assets || assets.length === 0) {
                    return equiposExtraidos;
                }

                const extractSerial = (value) => {
                    if (!value || typeof value !== 'string') return '';
                    if (value.toUpperCase().startsWith('CA-')) {
                        const tjIndex = value.toUpperCase().indexOf('TJ');
                        if (tjIndex !== -1) return value.substring(tjIndex + 2);
                    }
                    const parts = value.split('-');
                    return parts[parts.length - 1];
                };

                assets.forEach(asset => {
                    const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                    if (componente === 'PC' || componente === 'NOTEBOOK' || componente === 'LAPTOP') {
                        equiposExtraidos.push({ id: Math.random(), tipo: (componente === 'NOTEBOOK' || componente === 'LAPTOP') ? 'LAPTOP' : 'PC', marca: getSafeProp(asset, 'MARCA'), desc: getSafeProp(asset, 'Modelo Consenso'), mtm: getSafeProp(asset, 'Modelo MTM'), serie: getSafeProp(asset, 'SERIE PC'), codigo: getSafeProp(asset, 'Código de activo del equipo'), estado: '', dano: false, faltante: false });
                    }
                    if (getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'MONITOR', marca: 'NA', desc: getSafeProp(asset, 'Tipo Monitor'), mtm: 'NA', serie: getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR'), codigo: getSafeProp(asset, 'Código de activo del Monitor'), estado: '', dano: false, faltante: false });
                    }
                    if (getSafeProp(asset, 'Código de activo del teclado')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'TECLADO', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')), codigo: getSafeProp(asset, 'Código de activo del teclado'), estado: '', dano: false, faltante: false });
                    }
                    if (getSafeProp(asset, 'Código de activo del Mouse')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'RATÓN', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')), codigo: getSafeProp(asset, 'Código de activo del Mouse'), estado: '', dano: false, faltante: false });
                    }
                    if (getSafeProp(asset, 'Código de activo del Cargador')) {
                        equiposExtraidos.push({ id: Math.random(), tipo: 'CARGADOR', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')), codigo: getSafeProp(asset, 'Código de activo del Cargador'), estado: '', dano: false, faltante: false });
                    }
                });

                return equiposExtraidos;
}

            //------------------------------------------------------------

            function hideModal() {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-container').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            function getSafeProp(obj, key) {
                if (!obj || typeof obj !== 'object') return undefined;
                const normalizedKey = key.trim().toUpperCase();
                for (const prop in obj) {
                    if (prop.trim().toUpperCase() === normalizedKey) return obj[prop];
                }
                return undefined;
            }

            function populateSelect(selectElement, options, valueKey = null, textKey = null) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                const defaultOpt = document.createElement('option');
                defaultOpt.value = "";
                defaultOpt.textContent = "-- Seleccione --";
                selectElement.appendChild(defaultOpt);
                options.forEach(option => {
                    const opt = document.createElement('option');
                    if (typeof option === 'object') {
                        opt.value = option[valueKey];
                        opt.textContent = option[textKey];
                    } else {
                        opt.value = option;
                        opt.textContent = option;
                    }
                    selectElement.appendChild(opt);
                });
            }
//------------------------------
/*
            function handleFile(file) {
                if (!file) return;
                showLoader();
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        const nominaSheetName = workbook.SheetNames.find(name => name.trim().toUpperCase().includes('NOMINA'));
                        const activosSheetName = workbook.SheetNames.find(name => name.trim().toUpperCase().includes('FACTURACION'));

                        if (!nominaSheetName || !activosSheetName) {
                            hideLoader();
                            showModal('Error de Archivo', "El archivo Excel debe contener las hojas 'NOMINA' y 'FACTURACION'.");
                            return;
                        }

                        nominaData = XLSX.utils.sheet_to_json(workbook.Sheets[nominaSheetName]);
                        activosData = XLSX.utils.sheet_to_json(workbook.Sheets[activosSheetName]);
                        hideLoader();
                        //showModal('Éxito', 'Archivo de Excel cargado y procesado correctamente.');
                        Swal.fire({
                            icon: 'success',                             // Muestra el ícono de la palomita verde
                            title: '¡Éxito!',                            // El título principal
                            text: 'Archivo de Excel cargado y procesado.', // El texto secundario
                            timer: 2500,                                 // Se cierra automáticamente después de 2.5 segundos
                            showConfirmButton: false,                    // Oculta el botón "OK"
                            timerProgressBar: true                       // Muestra una barrita de progreso para el tiempo
                        });

                    } catch (error) {
                        hideLoader();
                        //showModal('Error', 'Hubo un problema al procesar el archivo. Verifique que sea un .xlsx válido.');.
                        
                        console.error("Error reading file with FileReader:", error);
                    }
                };
                reader.onerror = function () { hideLoader(); showModal('Error', 'No se pudo leer el archivo.'); }
                reader.readAsArrayBuffer(file);
            }
*/
            async function handleFile(file) {
                if (!file) return;
                
                showLoader();
                // Deshabilitamos los botones para que no puedas buscar todavía
                document.getElementById('excel-search-btn').disabled = true;
                document.getElementById('ad-search-btn').disabled = true;

                try {
                    // Usamos una "Promesa" para forzar al programa a esperar
                    const data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(new Uint8Array(e.target.result));
                        reader.onerror = error => reject(error);
                        reader.readAsArrayBuffer(file);
                    });

                    const workbook = XLSX.read(data, { type: 'array' });

                    const nominaSheetName = workbook.SheetNames.find(name => name.trim().toUpperCase().includes('NOMINA'));
                    const activosSheetName = workbook.SheetNames.find(name => name.trim().toUpperCase().includes('FACTURACION'));

                    if (!nominaSheetName || !activosSheetName) {
                        throw new Error("El archivo Excel debe contener las hojas 'NOMINA' y 'FACTURACION'.");
                    }

                    nominaData = XLSX.utils.sheet_to_json(workbook.Sheets[nominaSheetName]);
                    activosData = XLSX.utils.sheet_to_json(workbook.Sheets[activosSheetName]);
                    
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: 'Archivo de Excel cargado y procesado.',
                        timer: 2500,
                        showConfirmButton: false,
                        timerProgressBar: true
                    });

                } catch (error) {
                    showModal('Error', 'Hubo un problema al procesar el archivo: ' + error.message);
                } finally {
                    hideLoader();
                    // Cuando todo termina (con éxito o error), volvemos a habilitar los botones
                    document.getElementById('excel-search-btn').disabled = false;
                    document.getElementById('ad-search-btn').disabled = false;
                }
            }
            //----------------------------------------------
            excelFileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

            function normalizeCedula(cedula) {
                if (cedula === null || cedula === undefined) return '';
                let cedulaStr = String(cedula).trim();
                if (/^\d{9}$/.test(cedulaStr)) {
                    return '0' + cedulaStr;
                }
                return cedulaStr;
            }

//***********************************************************************************************************************************************

            /**
             * Normaliza un número de cédula para que siempre tenga 10 dígitos.
             * Especialmente útil para corregir cédulas importadas de Excel, que elimina el cero inicial.
             * @param {string | number} cedula La cédula a normalizar.
             * @returns {string} La cédula normalizada como una cadena de 10 dígitos.
             */
            function normalizeCedula(cedula) {
                // 1. Si la entrada es nula o indefinida, devolvemos una cadena vacía para evitar errores.
                if (cedula === null || cedula === undefined) {
                    return '';
                }

                // 2. Convertimos la entrada a una cadena de texto y eliminamos espacios en blanco.
                // Esto funciona tanto si Excel envía un número (123456789) como un texto (" 123456789 ").
                let cedulaStr = String(cedula).trim();

                // 3. ¡LA LÓGICA CLAVE! Usamos una expresión regular para comprobar si la cadena
                //    contiene exactamente 9 dígitos.
                if (/^\d{9}$/.test(cedulaStr)) {
                    // Si tiene 9 dígitos (porque Excel eliminó el '0'), se lo añadimos al principio.
                    console.log(`Cédula de Excel corregida: ${cedulaStr} -> 0${cedulaStr}`); // Mensaje útil para depuración
                    return '0' + cedulaStr;
                }

                // 4. Si ya tenía 10 dígitos o un formato diferente, la devolvemos como está.
                return cedulaStr;
            }

//***********************************************************************************************************************************************

            function populateFormWithAssetData(assetData) {
                if (!assetData) return;
                clearFormFields(false);

                const cedulaUsuario = normalizeCedula(getSafeProp(assetData, 'Cédulas') || getSafeProp(assetData, 'ok cedula'));

                document.getElementById('nombre').value = getSafeProp(assetData, 'Colaborador') || '';
                document.getElementById('cedula').value = cedulaUsuario;
                document.getElementById('usuario').value = getSafeProp(assetData, 'Nombre de usuario') || '';
                document.getElementById('hostname').value = getSafeProp(assetData, 'Hostname') || '';
                document.getElementById('empresa').value = getSafeProp(assetData, 'OK EMPRESA') || getSafeProp(assetData, 'Centro de costo') || '';
                document.getElementById('departamento').value = getSafeProp(assetData, 'OK DEPARTAMENTO') || getSafeProp(assetData, 'Cargo') || '';

                const todosLosActivosDelUsuario = activosData.filter(asset =>
                    (normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula'))) === cedulaUsuario
                );

                equipos = [];
                const extractSerial = (value) => {
                    if (!value || typeof value !== 'string') return '';
                    if (value.toUpperCase().startsWith('CA-')) {
                        const tjIndex = value.toUpperCase().indexOf('TJ');
                        if (tjIndex !== -1) return value.substring(tjIndex + 2);
                    }
                    const parts = value.split('-');
                    return parts[parts.length - 1];
                };

                todosLosActivosDelUsuario.forEach(asset => {
                    const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                     const tiposDeComputadora = ['PC', 'NOTEBOOK', 'LAPTOP', 'IMAC', 'MAC STUDIO', 'MACBOOK', 'MACBOOKPRO', 'WORKSTATION'];
                    /*if (componente === 'PC' || componente === 'NOTEBOOK' || componente === 'LAPTOP') {
                        equipos.push({ id: Math.random(), tipo: (componente === 'NOTEBOOK' || componente === 'LAPTOP') ? 'LAPTOP' : 'PC', marca: getSafeProp(asset, 'MARCA'), desc: getSafeProp(asset, 'Modelo Consenso'), mtm: getSafeProp(asset, 'Modelo MTM'), serie: getSafeProp(asset, 'SERIE PC'), codigo: getSafeProp(asset, 'Código de activo del equipo'), estado: '', dano: false, faltante: false });
                    }*/
                    if (tiposDeComputadora.includes(componente)) {
                        equipos.push({
                            id: Math.random(),
                            // Usamos el mismo nombre del componente, solo normalizamos 'NOTEBOOK' a 'LAPTOP'
                            tipo: (componente === 'NOTEBOOK') ? 'LAPTOP' : componente,
                            marca: getSafeProp(asset, 'MARCA'),
                            desc: getSafeProp(asset, 'Modelo Consenso'),
                            mtm: getSafeProp(asset, 'Modelo MTM'),
                            serie: getSafeProp(asset, 'SERIE PC'),
                            codigo: getSafeProp(asset, 'Código de activo del equipo'),
                            estado: '',
                            dano: false,
                            faltante: false
                        });
                    }


                    if (getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR')) {
                        equipos.push({ id: Math.random(), tipo: 'MONITOR', marca: 'NA', desc: getSafeProp(asset, 'Tipo Monitor'), mtm: 'NA', serie: getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR'), codigo: getSafeProp(asset, 'Código de activo del Monitor'), estado: '', dano: false, faltante: false });
                    }
                    if (getSafeProp(asset, 'Código de activo del teclado')) {
                        equipos.push({ id: Math.random(), tipo: 'TECLADO', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')), codigo: getSafeProp(asset, 'Código de activo del teclado'), estado: '', dano: false, faltante: false });
                    }
                    if (getSafeProp(asset, 'Código de activo del Mouse')) {
                        equipos.push({ id: Math.random(), tipo: 'RATÓN', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')), codigo: getSafeProp(asset, 'Código de activo del Mouse'), estado: '', dano: false, faltante: false });
                    }
                    if (getSafeProp(asset, 'Código de activo del Cargador')) {
                        equipos.push({ id: Math.random(), tipo: 'CARGADOR', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')), codigo: getSafeProp(asset, 'Código de activo del Cargador'), estado: '', dano: false, faltante: false });
                    }
                });

                renderEquiposList();
                updatePreview();
                showModal('Éxito', `Usuario ${getSafeProp(assetData, 'Colaborador')} encontrado en el registro general de activos.`);
            }
//************************************
/*
            function populateFormWithUserData(userData) {
                if (!userData) return;
                clearFormFields(false);
                const cedulaFromNomina = getSafeProp(userData, 'Cedula');
                const normalizedCedula = normalizeCedula(cedulaFromNomina);

                document.getElementById('nombre').value = getSafeProp(userData, 'Colaborador') || '';
                document.getElementById('cedula').value = normalizedCedula;
                document.getElementById('departamento').value = getSafeProp(userData, 'Cargo') || '';
                const userLogin = getSafeProp(userData, 'Usuario') || '';
                correoUsuarioInput.value = userLogin;
                const userEmail = getSafeProp(userData, 'E-mail') || '';
                if (userEmail.includes('@')) {
                    const [user, domain] = userEmail.split('@');
                    correoUsuarioInput.value = user;
                    if (domainOptions.includes(domain)) {
                        correoDominioSelect.value = domain;
                    } else {
                        correoDominioSelect.value = 'otro';
                        correoDominioManual.value = domain;
                    }
                    correoDominioSelect.dispatchEvent(new Event('change'));
                }
                document.getElementById('zona').value = getSafeProp(userData, 'Zona') || '';
                document.getElementById('jefatura').value = getSafeProp(userData, 'Jefatura') || '';
                document.getElementById('usuario').value = userLogin;
                document.getElementById('ciudad').value = getSafeProp(userData, 'Ciudad trabajo') || '';
                document.getElementById('empresa').value = getSafeProp(userData, 'Centro de costo') || '';
                document.getElementById('ubicacion').value = getSafeProp(userData, 'Area') || '';

                const userAssets = activosData.filter(asset => {
                    const cedulaFromActivos = normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula'));
                    return cedulaFromActivos === normalizedCedula;
                });

                equipos = [];
                const extractSerial = (value) => {
                    if (!value || typeof value !== 'string') return '';
                    if (value.toUpperCase().startsWith('CA-')) {
                        const tjIndex = value.toUpperCase().indexOf('TJ');
                        if (tjIndex !== -1) return value.substring(tjIndex + 2);
                    }
                    const parts = value.split('-');
                    return parts[parts.length - 1];
                };
                userAssets.forEach(asset => {
                    let seriePaqueteActual = null; 
                    const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                    const tiposDeComputadora = ['PC', 'NOTEBOOK', 'LAPTOP', 'IMAC', 'MAC STUDIO', 'MACBOOK', 'MACBOOKPRO', 'WORKSTATION'];
                    /*
                    if (componente === 'PC' || componente === 'NOTEBOOK' || componente === 'LAPTOP') {
                        equipos.push({ id: Math.random(), tipo: (componente === 'NOTEBOOK' || componente === 'LAPTOP') ? 'LAPTOP' : 'PC', marca: getSafeProp(asset, 'MARCA'), desc: getSafeProp(asset, 'Modelo Consenso'), mtm: getSafeProp(asset, 'Modelo MTM'), serie: getSafeProp(asset, 'SERIE PC'), codigo: getSafeProp(asset, 'Código de activo del equipo'), estado: '', dano: false, faltante: false });
                    }
                    if (tiposDeComputadora.includes(componente)) {
                        seriePaqueteActual = getSafeProp(asset, 'SERIE PC');
                        equipos.push({ 
                            id: Math.random(), 
                            tipo: (componente === 'NOTEBOOK') ? 'LAPTOP' : componente, 
                            marca: getSafeProp(asset, 'MARCA'), 
                            desc: getSafeProp(asset, 'Modelo Consenso'), 
                            mtm: getSafeProp(asset, 'Modelo MTM'), 
                            serie: seriePaqueteActual, 
                            codigo: getSafeProp(asset, 'Código de activo del equipo'), 
                            estado: '', 
                            dano: false, 
                            faltante: false 
                        });
                    }

                    if (getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR')) {
                        equipos.push({ id: Math.random(), tipo: 'MONITOR', marca: 'NA', desc: getSafeProp(asset, 'Tipo Monitor'), mtm: 'NA', serie: getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR'), codigo: getSafeProp(asset, 'Código de activo del Monitor'), estado: '', dano: false, faltante: false, idPaquete: seriePaqueteActual });
                    }
                    if (getSafeProp(asset, 'Código de activo del teclado')) {
                        equipos.push({ id: Math.random(), tipo: 'TECLADO', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')), codigo: getSafeProp(asset, 'Código de activo del teclado'), estado: '', dano: false, faltante: false, idPaquete: seriePaqueteActual });
                    }
                    if (getSafeProp(asset, 'Código de activo del Mouse')) {
                        equipos.push({ id: Math.random(), tipo: 'RATÓN', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')), codigo: getSafeProp(asset, 'Código de activo del Mouse'), estado: '', dano: false, faltante: false,idPaquete: seriePaqueteActual });
                    }
                    if (getSafeProp(asset, 'Código de activo del Cargador')) {
                        equipos.push({ id: Math.random(), tipo: 'CARGADOR', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')), codigo: getSafeProp(asset, 'Código de activo del Cargador'), estado: '', dano: false, faltante: false, idPaquete: seriePaqueteActual });
                    }
                });

                if (equipos.length === 0) { showModal('Información', 'Usuario encontrado, pero no se encontraron activos asignados en el archivo de facturación.'); }
                renderEquiposList();
                updatePreview();
            }
*/
            //************************************************************
//---------------------------------------------------------------------------------------------
            /**
             * Función todo-en-uno:
             * 1. Rellena el formulario con datos de AD o Excel.
             * 2. Busca los activos correspondientes en el archivo de facturación.
             * 3. Muestra los resultados en la interfaz.
             * @param {object} userData El objeto con los datos del usuario.
             * @param {boolean} fromAD Un indicador que es `true` si los datos vienen de AD.
             */
//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&

            // ✅ ESTA ES LA NUEVA FUNCIÓN REUTILIZABLE
            async function performAdSearch(searchTerm) {
                showLoadingModal('Buscando en Directorio Activo', 'Por favor, espere...');

                try {
                    const result = await window.api.searchAdReal({ searchTerm });

                    if (result.success) {
                        hideLoadingModal();
                        populateFormWithUserData(result.user, true);
                        showDetailedSuccessModal('¡Datos Cargados!', result.user.cn, 'Active Directory (AD)', equipos.length);
                    } else if (result.reason === 'INVALID_CREDENTIALS') {
                        hideLoadingModal();
                        credencialesIncorrectas();
                        adCredentialsPanel.classList.remove('hidden');
                        adPasswordInput.value = '';
                        adPasswordInput.focus();
                    } else if (result.reason === 'NEEDS_CREDENTIALS') {
                        hideLoadingModal();
                        adCredentialsPanel.classList.remove('hidden');
                        adUsernameInput.focus();
                    } else {
                        hideLoadingModal();
                        // Si AD tampoco lo encuentra, ahora sí mostramos el error final.
                        showErrorModal('Búsqueda sin Éxito', `El usuario no fue encontrado ni en el Excel ni en el Directorio Activo.`);
                    }
                } catch (error) {
                    hideLoadingModal();
                    showErrorModal('Error Crítico', 'Error en la comunicación con el Directorio Activo: ' + error.message);
                }
            }
//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
            function populateFormWithUserData(userData, fromAD = false) {
                if (!userData) return;

                // --- PASO 1: Limpiar el formulario y rellenar los datos personales (lógica "bilingüe") ---
                clearFormFields(false);

                if (fromAD) {
                    // --- Bloque para leer datos del Directorio Activo ---
                    document.getElementById('nombre').value = userData.cn || '';
                    document.getElementById('cedula').value = normalizeCedula(userData.description) || '';
                    document.getElementById('departamento').value = userData.department || '';
                    document.getElementById('usuario').value = userData.sAMAccountName || '';
                    document.getElementById('ciudad').value = userData.l || '';
                    document.getElementById('empresa').value = userData.company || '';
                    const userEmail = userData.mail || '';
                    if (userEmail.includes('@')) {
                        const [user, domain] = userEmail.split('@');
                        correoUsuarioInput.value = user;
                        if (domainOptions.includes(domain)) {
                            correoDominioSelect.value = domain;
                        } else {
                            correoDominioSelect.value = 'otro';
                            correoDominioManual.value = domain;
                        }
                        correoDominioSelect.dispatchEvent(new Event('change'));
                    }
                } else {
                    // --- Bloque para leer datos del archivo Excel ---
                    const cedulaFromExcel = getSafeProp(userData, 'Cedula') || getSafeProp(userData, 'Cédulas') || getSafeProp(userData, 'ok cedula');
                    document.getElementById('nombre').value = getSafeProp(userData, 'Colaborador') || '';
                    document.getElementById('cedula').value = normalizeCedula(cedulaFromExcel);
                    document.getElementById('departamento').value = getSafeProp(userData, 'Cargo') || '';
                    document.getElementById('usuario').value = getSafeProp(userData, 'Usuario') || '';
                    document.getElementById('ciudad').value = getSafeProp(userData, 'Ciudad trabajo') || '';
                    document.getElementById('empresa').value = getSafeProp(userData, 'Centro de costo') || '';
                    document.getElementById('jefatura').value = getSafeProp(userData, 'Jefatura') || '';
                    document.getElementById('zona').value = getSafeProp(userData, 'Zona') || '';
                    const userEmail = getSafeProp(userData, 'E-mail') || '';
                    if (userEmail.includes('@')) {
                        const [user, domain] = userEmail.split('@');
                        correoUsuarioInput.value = user;
                        if (domainOptions.includes(domain)) {
                            correoDominioSelect.value = domain;
                        } else {
                            correoDominioSelect.value = 'otro';
                            correoDominioManual.value = domain;
                        }
                        correoDominioSelect.dispatchEvent(new Event('change'));
                    }
                }

                // --- PASO 2: Buscar y cargar los activos correspondientes ---
                
                // Obtenemos la cédula que acabamos de poner en el campo del formulario.
                // Esto asegura que siempre usamos el valor correcto y normalizado.
                const cedulaParaBuscar = document.getElementById('cedula').value;

                // Filtramos la lista de activos del Excel.
                const userAssets = activosData.filter(asset => {
                    const cedulaFromActivos = normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula'));
                    return cedulaFromActivos === cedulaParaBuscar;
                });

                // Vaciamos la lista de equipos y la volvemos a llenar.
                equipos = [];
                const extractSerial = (value) => {
                    if (!value || typeof value !== 'string') return '';
                    if (value.toUpperCase().startsWith('CA-')) {
                        const tjIndex = value.toUpperCase().indexOf('TJ');
                        if (tjIndex !== -1) return value.substring(tjIndex + 2);
                    }
                    const parts = value.split('-');
                    return parts[parts.length - 1];
                };
                userAssets.forEach(asset => {
                    let seriePaqueteActual = null;
                    const componente = (getSafeProp(asset, 'Componentes') || '').toUpperCase();
                    const tiposDeComputadora = ['PC', 'NOTEBOOK', 'LAPTOP', 'IMAC', 'MAC STUDIO', 'MACBOOK', 'MACBOOKPRO', 'WORKSTATION'];

                    if (tiposDeComputadora.includes(componente)) {
                        seriePaqueteActual = getSafeProp(asset, 'SERIE PC');
                        equipos.push({
                            id: Math.random(),
                            tipo: (componente === 'NOTEBOOK') ? 'LAPTOP' : componente,
                            marca: getSafeProp(asset, 'MARCA'),
                            desc: getSafeProp(asset, 'Modelo Consenso'),
                            mtm: getSafeProp(asset, 'Modelo MTM'),
                            serie: seriePaqueteActual,
                            codigo: getSafeProp(asset, 'Código de activo del equipo'),
                            estado: '',
                            dano: false,
                            faltante: false
                        });
                    }
                    if (getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR')) {
                        equipos.push({ id: Math.random(), tipo: 'MONITOR', marca: 'NA', desc: getSafeProp(asset, 'Tipo Monitor'), mtm: 'NA', serie: getSafeProp(asset, 'SERIE MON') || getSafeProp(asset, 'SERIE MONITOR'), codigo: getSafeProp(asset, 'Código de activo del Monitor'), estado: '', dano: false, faltante: false, idPaquete: seriePaqueteActual });
                    }
                    if (getSafeProp(asset, 'Código de activo del teclado')) {
                        equipos.push({ id: Math.random(), tipo: 'TECLADO', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del teclado')), codigo: getSafeProp(asset, 'Código de activo del teclado'), estado: '', dano: false, faltante: false, idPaquete: seriePaqueteActual });
                    }
                    if (getSafeProp(asset, 'Código de activo del Mouse')) {
                        equipos.push({ id: Math.random(), tipo: 'RATÓN', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Mouse')), codigo: getSafeProp(asset, 'Código de activo del Mouse'), estado: '', dano: false, faltante: false, idPaquete: seriePaqueteActual });
                    }
                    if (getSafeProp(asset, 'Código de activo del Cargador')) {
                        equipos.push({ id: Math.random(), tipo: 'CARGADOR', marca: 'NA', desc: '', mtm: 'NA', serie: extractSerial(getSafeProp(asset, 'Código de activo del Cargador')), codigo: getSafeProp(asset, 'Código de activo del Cargador'), estado: '', dano: false, faltante: false, idPaquete: seriePaqueteActual });
                    }
                });

                // --- PASO 3: Renderizar los resultados en la UI ---

                // Si después de todo el proceso, la lista de equipos está vacía, se lo informamos al usuario.
                if (equipos.length === 0) {
                    showModal('Información', 'Usuario encontrado, pero no se encontraron activos asignados en el archivo de facturación.');
                }

                // Dibujamos la tabla de equipos y actualizamos la vista previa del acta.
                renderEquiposList();
                updatePreview();
            }
//--------------------------------------------------------------------------------------------

/*
            function searchExcel() {
                const searchTerm = excelSearchInput.value.trim().toUpperCase();
                if (!searchTerm) {
                    showModal('Atención', 'Por favor, ingrese una cédula o nombre para buscar.');
                    return;
                }
                if (nominaData.length === 0 && activosData.length === 0) {
                    showModal('Atención', 'Por favor, cargue primero el archivo de Excel.');
                    return;
                }

                const normalizedSearchTerm = normalizeCedula(searchTerm);

                let matchingUsersInNomina = nominaData.filter(user => {
                    const cedulaFromExcel = normalizeCedula(getSafeProp(user, 'Cedula'));
                    const nombre = String(getSafeProp(user, 'Colaborador') || '').trim().toUpperCase();
                    return cedulaFromExcel === normalizedSearchTerm || nombre.includes(searchTerm);
                });

                if (matchingUsersInNomina.length === 1) {
                    populateFormWithUserData(matchingUsersInNomina[0]);
                    return;
                }
                if (matchingUsersInNomina.length > 1) {
                    showUserSelectionModal(matchingUsersInNomina);
                    return;
                }

                //showModal('Búsqueda Extendida', 'No se encontró en la nómina. Buscando en el registro general de activos...');
                Swal.fire({
                icon: 'error',                             // Muestra el ícono de la palomita verde
                title: '¡Uh-Oh...!',                            // El título principal
                text: 'El usuario no se encontró en la nómina.', // El texto secundario
                timer: 2500,                                 // Se cierra automáticamente después de 2.5 segundos
                showConfirmButton: false,                    // Oculta el botón "OK"
                timerProgressBar: true                       // Muestra una barrita de progreso para el tiempo
            });

                setTimeout(() => {
                    let matchingAssets = activosData.filter(asset => {
                        const nombre = String(getSafeProp(asset, 'Colaborador') || '').trim().toUpperCase();
                        const cedulaFromAsset = normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula'));
                        return nombre.includes(searchTerm) || (cedulaFromAsset && cedulaFromAsset === normalizedSearchTerm);
                    });

                    if (matchingAssets.length === 0) {
                        hideModal();
                        showModal('No Encontrado', 'El usuario no fue encontrado ni en la nómina ni en el registro general de activos.');
                        return;
                    }

                    const uniqueUsersMap = new Map();
                    matchingAssets.forEach(asset => {
                        const cedula = normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula'));
                        const nombre = String(getSafeProp(asset, 'Colaborador') || '').trim().toUpperCase();
                        const key = cedula || nombre;
                        if (key && !uniqueUsersMap.has(key)) {
                            uniqueUsersMap.set(key, asset);
                        }
                    });
                    const uniqueMatchingUsers = Array.from(uniqueUsersMap.values());

                    hideModal();
                    if (uniqueMatchingUsers.length === 1) {
                        //populateFormWithAssetData(uniqueMatchingUsers[0]);
                        populateFormWithUserData(uniqueMatchingUsers[0]);
                    } else {
                        showUserSelectionModal(uniqueMatchingUsers);
                    }
                }, 500);
            }
*/
//==========================================================================================
            // ✅ ESTA ES LA VERSIÓN FINAL DE TU BÚSQUEDA EN EXCEL
            function searchExcel() {
                const searchTerm = excelSearchInput.value.trim().toUpperCase();
                if (!searchTerm) {
                    showErrorModal('Atención', 'Por favor, ingrese una cédula o nombre para buscar.');
                    return;
                }
                if (nominaData.length === 0 && activosData.length === 0) {
                    showErrorModal('Atención', 'Por favor, cargue primero el archivo de Excel.');
                    return;
                }

                const normalizedSearchTerm = normalizeCedula(searchTerm);

                // 1. Busca primero en la "NÓMINA"
                let matchingUsersInNomina = nominaData.filter(user => {
                    const cedulaFromExcel = normalizeCedula(getSafeProp(user, 'Cedula'));
                    const nombre = String(getSafeProp(user, 'Colaborador') || '').trim().toUpperCase();
                    return cedulaFromExcel === normalizedSearchTerm || nombre.includes(searchTerm);
                });

                // Si encuentra 1 o más, los muestra y la función termina.
                if (matchingUsersInNomina.length === 1) {
                    populateFormWithUserData(matchingUsersInNomina[0], false);
                    showDetailedSuccessModal('¡Datos Cargados!', matchingUsersInNomina[0].Colaborador, 'Nómina Excel', equipos.length);
                    return;
                }
                if (matchingUsersInNomina.length > 1) {
                    showUserSelectionModal(matchingUsersInNomina);
                    return;
                }

                // 2. Si NO encontró a nadie en la nómina...
                if (matchingUsersInNomina.length === 0) {
                    console.log('No se encontró en Nómina. Pasando a buscar en Directorio Activo...');
                    // ...llama a la función de búsqueda en AD que creamos antes.
                    performAdSearch(excelSearchInput.value.trim());
                }
            }
//******************************************************************
/*
            function showUserSelectionModal(users) {
                const userListContainer = document.getElementById('user-list-container');
                userListContainer.innerHTML = '';
                const newUserListContainer = userListContainer.cloneNode(false);
                userListContainer.parentNode.replaceChild(newUserListContainer, userListContainer);

                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'p-3 border rounded-md hover:bg-blue-100 cursor-pointer';

                    const cedulaRaw = getSafeProp(user, 'Cedula') || getSafeProp(user, 'Cédulas') || getSafeProp(user, 'ok cedula');
                    const cargo = getSafeProp(user, 'Cargo') || getSafeProp(user, 'OK DEPARTAMENTO') || 'N/A';
                    const nombre = getSafeProp(user, 'Colaborador') || 'Sin Nombre';

                    const normalizedCedula = normalizeCedula(cedulaRaw);
                    userDiv.dataset.cedula = normalizedCedula;
                    userDiv.userData = user;

                    userDiv.innerHTML = `
                      <p class="font-semibold text-gray-800">${nombre}</p>
                      <p class="text-sm text-gray-600">Cédula: ${normalizedCedula} | Cargo: ${cargo}</p>
                  `;

                    newUserListContainer.appendChild(userDiv);
                });

                newUserListContainer.addEventListener('click', (e) => {
                    const selectedUserDiv = e.target.closest('div[data-cedula]');
                    if (selectedUserDiv && selectedUserDiv.userData) {
                        const selectedUser = selectedUserDiv.userData;

                        if (getSafeProp(selectedUser, 'E-mail')) {
                            populateFormWithUserData(selectedUser);
                        } else {
                            populateFormWithAssetData(selectedUser);
                        }
                        hideUserSelectionModal();
                    }
                });

                const modal = document.getElementById('user-selection-modal');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            }
*/
            function showUserSelectionModal(users) {
                const userListContainer = document.getElementById('user-list-container');
                userListContainer.innerHTML = ''; // Limpiamos la lista

                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'p-3 border rounded-md hover:bg-blue-100 cursor-pointer';

                    const cedulaRaw = getSafeProp(user, 'Cedula') || getSafeProp(user, 'Cédulas') || getSafeProp(user, 'ok cedula');
                    const cargo = getSafeProp(user, 'Cargo') || getSafeProp(user, 'OK DEPARTAMENTO') || 'N/A';
                    const nombre = getSafeProp(user, 'Colaborador') || 'Sin Nombre';
                    const normalizedCedula = normalizeCedula(cedulaRaw);

                    userDiv.innerHTML = `
                    <p class="font-semibold text-gray-800">${nombre}</p>
                    <p class="text-sm text-gray-600">Cédula: ${normalizedCedula} | Cargo: ${cargo}</p>
                    `;

                    // --- INICIO DE LA CORRECCIÓN ---
                    // Asignamos el evento de clic DIRECTAMENTE al div del usuario
                    userDiv.addEventListener('click', () => {
                        // Verificamos si el 'user' viene de la nómina (tiene e-mail) o de facturación
                        if (getSafeProp(user, 'E-mail')) {
                            populateFormWithUserData(user);
                        } else {
                            // Si viene de facturación, también usamos la misma función para consistencia
                            populateFormWithUserData(user);
                        }
                        hideUserSelectionModal();
                    });
                    // --- FIN DE LA CORRECCIÓN ---

                    userListContainer.appendChild(userDiv);
                });

                // Mostramos el modal (esta parte no cambia)
                const modal = document.getElementById('user-selection-modal');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            }
//*****************************************************************************
            function hideUserSelectionModal() {
                const modal = document.getElementById('user-selection-modal');
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-container').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            excelSearchBtn.addEventListener('click', searchExcel);

            function clearFormFields(showMessage = true) {
                form.reset();
                equipos = [];
                document.getElementById('tipo_acta').value = 'REGULARIZACION DE EQUIPOS';
                document.getElementById('fecha').valueAsDate = new Date();
                equiposEntregados = [];
                activosMantiene = [];
                fotosParaActa = [];
                activosParaRetiro = [];
                tipoRetiro = 'todos';
                tipoEntrega = 'completo';
                excelSearchInput.value = '';
                adSearchInput.value = '';
                firmarJefaturaCheck.checked = false;
                jefaturaFirmaContainer.classList.add('hidden');
                salidaPersonalCheck.checked = false;
                resetRetiroPanel();
                resetEntregaPanel();
                renderEquiposList();
                renderEquiposEntregados();
                renderActivosMantiene();
                renderFotosUnificadas();
                updatePreview();
                if (showMessage) {
                    showModal('Información', 'Todos los campos del formulario han sido limpiados.');
                }
            }

            clearBtn.addEventListener('click', () => {
                /*
                showModal('Confirmar Limpieza', '¿Estás seguro de que quieres borrar todos los datos del formulario?', [
                    { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                    {
                        text: 'Sí, Limpiar', class: 'bg-red-600 hover:bg-red-700', action: () => {
                            hideModal();
                            clearFormFields(true);
                        }
                    }
                ]);
                */
               showConfirmModal(
                    'Confirmar Limpieza',
                    '¿Estás seguro de que quieres borrar todos los datos del formulario?',
                    'Sí, Limpiar',
                    () => {
                        clearFormFields(false); // false para no mostrar la alerta vieja
                        showSuccessToast('Formulario limpiado con éxito.');
                    }
                );
            });

            toggleManualFormBtn.addEventListener('click', () => { equipmentFormContainer.classList.toggle('hidden'); });

            function resetEquipmentForm() {
                Object.keys(eqForm).forEach(key => {
                    if (eqForm[key].tagName === 'INPUT' || eqForm[key].tagName === 'SELECT') {
                        eqForm[key].value = "";
                    }
                });
                eqForm.tipo_manual.classList.add('hidden');
                eqForm.marca_manual.classList.add('hidden');
                eqForm.desc_manual.classList.add('hidden');
                editingEquipoId = null;
                eqForm.btn.textContent = 'Agregar Equipo';
                eqForm.btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                eqForm.btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }

            function renderEquiposList() {
                listaEquiposBody.innerHTML = '';
                const tableHead = document.querySelector('#lista-equipos-body').parentNode.querySelector('thead tr');

                if (!tableHead.querySelector('.th-paquete')) {
                    const th = document.createElement('th');
                    th.className = 'th-paquete px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    th.innerText = 'Asignar a Paquete';
                    tableHead.insertBefore(th, tableHead.children[3]);
                }

               // const paquetes = equipos.filter(e => ['PC', 'LAPTOP'].includes((e.tipo || '').toUpperCase()));
               const tiposDeComputadora = ['PC', 'NOTEBOOK', 'LAPTOP', 'IMAC', 'MAC STUDIO', 'MACBOOK', 'MACBOOKPRO', 'WORKSTATION'];

                
                const paquetes = equipos.filter(e => tiposDeComputadora.includes((e.tipo || '').toUpperCase()));

                const equiposAMostrar = tipoEntrega === 'activos' ? equiposEntregados : equipos;

                equiposAMostrar.forEach(eq => {
                    const row = document.createElement('tr');
                    let paqueteSelectHTML = '';
/*
                    if (!['PC', 'LAPTOP'].includes((eq.tipo || '').toUpperCase())) {
                        let options = '<option value="">-- Sin Asignar --</option>';
                        paquetes.forEach(p => {
                            const isSelected = eq.idPaquete === p.serie ? 'selected' : '';
                            options += `<option value="${p.serie}" ${isSelected}>Paquete ${p.serie}</option>`;
                        });
                        paqueteSelectHTML = `<select class="paquete-select p-1 border rounded-md text-xs w-full" data-id="${eq.id}">${options}</select>`;
                    }
*/
                    if (!tiposDeComputadora.includes((eq.tipo || '').toUpperCase())) {
                        let options = '<option value="">-- Sin Asignar --</option>';
                        paquetes.forEach(p => {
                            const isSelected = eq.idPaquete === p.serie ? 'selected' : '';
                            options += `<option value="${p.serie}" ${isSelected}>Paquete ${p.serie}</option>`;
                        });
                        paqueteSelectHTML = `<select class="paquete-select p-1 border rounded-md text-xs w-full" data-id="${eq.id}">${options}</select>`;
                    }
        
                    row.innerHTML = `
                      <td class="px-4 py-2 whitespace-nowrap">${eq.tipo || ''}</td>
                      <td class="px-4 py-2 whitespace-nowrap">${eq.marca || ''}</td>
                      <td class="px-4 py-2 whitespace-nowrap">${eq.serie || ''}</td>
                      <td class="px-4 py-2 whitespace-nowrap">${paqueteSelectHTML}</td>
                      <td class="px-2 py-2 whitespace-nowrap text-center"><input type="checkbox" class="dano-check h-4 w-4 text-indigo-600 border-gray-300 rounded" data-id="${eq.id}" ${eq.dano ? 'checked' : ''}></td>
                      <td class="px-2 py-2 whitespace-nowrap text-center"><input type="checkbox" class="faltante-check h-4 w-4 text-red-600 border-gray-300 rounded" data-id="${eq.id}" ${eq.faltante ? 'checked' : ''}></td>
                      <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                          <button type="button" class="text-indigo-600 hover:text-indigo-900 edit-btn" data-id="${eq.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                          <button type="button" class="text-red-600 hover:text-red-900 ml-4 delete-btn" data-id="${eq.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                      </td>`;
                    listaEquiposBody.appendChild(row);
                });

                // Actualizar el panel de retiro si está visible
                if (!retiroPanel.classList.contains('hidden') && tipoRetiro === 'especificos') {
                    renderRetiroActivos();
                }

                updatePreview();
            }
//-----------
            function handleAddOrUpdate() {
                const tipoValue = eqForm.tipo.value;
                const tipoFinal = tipoValue === 'OTRO' ? eqForm.tipo_manual.value : tipoValue;

                const marcaValue = eqForm.marca.value;
                const marcaFinal = marcaValue === 'OTRO' ? eqForm.marca_manual.value : marcaValue;

                const descValue = eqForm.desc.value;
                const descFinal = descValue === 'OTRO' ? eqForm.desc_manual.value : descValue;

                if (!tipoFinal || !eqForm.serie.value) {
                    //showModal('Datos Incompletos', 'Por favor, complete al menos el Tipo y la Serie del equipo.');
                    Swal.fire({
                            icon: 'error',                             // Muestra el ícono de la palomita verde
                            title: '¡UPSS!',                            // El título principal
                            text: 'Datos Incompletos',                      // El texto secundario
                            text: `📠📲Por favor, complete al menos el Tipo y la Serie del equipo.🔏🔒`, // El texto secundario
                            timer: 2000,                                 // Se cierra automáticamente después de 2.5 segundos
                            showConfirmButton: false,                    // Oculta el botón "OK"
                            timerProgressBar: true                       // Muestra una barrita de progreso para el tiempo
                        });
                    return;
                }
                const equipoData = {
                    id: editingEquipoId || Date.now(),
                    tipo: tipoFinal,
                    marca: marcaFinal,
                    desc: descFinal,
                    mtm: eqForm.mtm.value,
                    serie: eqForm.serie.value,
                    estado: eqForm.estado.value,
                    codigo: eqForm.codigo.value,
                    dano: false,
                    faltante: false,
                    idPaquete: null
                };

                if (tipoEntrega === 'activos') {
                    // En modo de entrega de activos específicos, agregar a equiposEntregados
                    if (editingEquipoId) {
                        const existingEquipo = equiposEntregados.find(eq => eq.id === editingEquipoId);
                        if (existingEquipo) {
                            equipoData.dano = existingEquipo.dano;
                            equipoData.faltante = existingEquipo.faltante;
                            equipoData.idPaquete = existingEquipo.idPaquete;
                            equiposEntregados = equiposEntregados.map(eq => eq.id === editingEquipoId ? equipoData : eq);
                        }
                    } else {
                        equiposEntregados.push(equipoData);
                    }
                    renderEquiposEntregados();
                } else {
                    // Modo normal
                    if (editingEquipoId) {
                        const existingEquipo = equipos.find(eq => eq.id === editingEquipoId);
                        equipoData.dano = existingEquipo.dano;
                        equipoData.faltante = existingEquipo.faltante;
                        equipoData.idPaquete = existingEquipo.idPaquete;
                        equipos = equipos.map(eq => eq.id === editingEquipoId ? equipoData : eq);

                        // Actualizar también en activosParaRetiro si el equipo está seleccionado para retiro
                        if (activosParaRetiro.some(ar => ar.id === editingEquipoId)) {
                            activosParaRetiro = activosParaRetiro.map(ar => ar.id === editingEquipoId ? equipoData : ar);
                        }
                    } else {
                        equipos.push(equipoData);
                    }
                    renderEquiposList();
                }

                resetEquipmentForm();
            }

            listaEquiposBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
/*
                if (editBtn) {
                    const id = Number(editBtn.dataset.id);
                    const equiposArray = tipoEntrega === 'activos' ? equiposEntregados : equipos;
                    const equipoToEdit = equiposArray.find(eq => eq.id === id);
                    if (equipoToEdit) {
                        equipmentFormContainer.classList.remove('hidden');

                        if (tipoOptions.includes(equipoToEdit.tipo)) {
                            eqForm.tipo.value = equipoToEdit.tipo;
                            eqForm.tipo_manual.classList.add('hidden');
                        } else {
                            eqForm.tipo.value = 'OTRO';
                            eqForm.tipo_manual.value = equipoToEdit.tipo;
                            eqForm.tipo_manual.classList.remove('hidden');
                        }

                        if (marcaOptions.includes(equipoToEdit.marca)) {
                            eqForm.marca.value = equipoToEdit.marca;
                            eqForm.marca_manual.classList.add('hidden');
                        } else {
                            eqForm.marca.value = 'OTRO';
                            eqForm.marca_manual.value = equipoToEdit.marca;
                            eqForm.marca_manual.classList.remove('hidden');
                        }

                        if (descOptions.includes(equipoToEdit.desc)) {
                            eqForm.desc.value = equipoToEdit.desc;
                            eqForm.desc_manual.classList.add('hidden');
                        } else {
                            eqForm.desc.value = 'OTRO';
                            eqForm.desc_manual.value = equipoToEdit.desc;
                            eqForm.desc_manual.classList.remove('hidden');
                        }

                        eqForm.mtm.value = equipoToEdit.mtm || '';
                        eqForm.serie.value = equipoToEdit.serie || '';
                        eqForm.estado.value = equipoToEdit.estado || '';
                        eqForm.codigo.value = equipoToEdit.codigo || '';

                        editingEquipoId = id;
                        eqForm.btn.textContent = 'Actualizar Equipo';
                        eqForm.btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                        eqForm.btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    }
                }
*/

                if (editBtn) {
                    const id = Number(editBtn.dataset.id);
                    const equiposArray = tipoEntrega === 'activos' ? equiposEntregados : equipos;
                    const equipoToEdit = equiposArray.find(eq => eq.id === id);

                    if (equipoToEdit) {
                        equipmentFormContainer.classList.remove('hidden');

                        // LIMPIAR Y OCULTAR TODOS LOS INPUTS MANUALES PRIMERO
                        eqForm.tipo_manual.classList.add('hidden');
                        eqForm.marca_manual.classList.add('hidden');
                        eqForm.desc_manual.classList.add('hidden');
                        eqForm.tipo_manual.value = '';
                        eqForm.marca_manual.value = '';
                        eqForm.desc_manual.value = '';

                        // CONFIGURAR TIPO
                        if (tipoOptions.includes(equipoToEdit.tipo)) {
                            // Si el tipo está en las opciones, seleccionarlo directamente
                            eqForm.tipo.value = equipoToEdit.tipo;
                        } else {
                            // Si no está en las opciones, usar "OTRO" y mostrar input manual
                            eqForm.tipo.value = 'OTRO';
                            eqForm.tipo_manual.value = equipoToEdit.tipo || '';
                            eqForm.tipo_manual.classList.remove('hidden');
                        }

                        // CONFIGURAR MARCA
                        if (marcaOptions.includes(equipoToEdit.marca)) {
                            // Si la marca está en las opciones, seleccionarla directamente
                            eqForm.marca.value = equipoToEdit.marca;
                        } else {
                            // Si no está en las opciones, usar "OTRO" y mostrar input manual
                            eqForm.marca.value = 'OTRO';
                            eqForm.marca_manual.value = equipoToEdit.marca || '';
                            eqForm.marca_manual.classList.remove('hidden');
                        }

                        // CONFIGURAR DESCRIPCIÓN
                        if (descOptions.includes(equipoToEdit.desc)) {
                            // Si la descripción está en las opciones, seleccionarla directamente
                            eqForm.desc.value = equipoToEdit.desc;
                        } else {
                            // Si no está en las opciones, usar "OTRO" y mostrar input manual
                            eqForm.desc.value = 'OTRO';
                            eqForm.desc_manual.value = equipoToEdit.desc || '';
                            eqForm.desc_manual.classList.remove('hidden');
                        }

                        // LLENAR LOS DEMÁS CAMPOS NORMALMENTE
                        eqForm.mtm.value = equipoToEdit.mtm || '';
                        eqForm.serie.value = equipoToEdit.serie || '';
                        eqForm.estado.value = equipoToEdit.estado || '';
                        eqForm.codigo.value = equipoToEdit.codigo || '';

                        // CONFIGURAR EL BOTÓN PARA MODO EDICIÓN
                        editingEquipoId = id;
                        eqForm.btn.textContent = 'Actualizar Equipo';
                        eqForm.btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                        eqForm.btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    }
                }
                if (deleteBtn) {
                    showModal('Confirmar Eliminación', '¿Seguro que quieres eliminar este equipo?', [
                        { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                        {
                            text: 'Eliminar', class: 'bg-red-600 hover:bg-red-700', action: () => {
                                const id = Number(deleteBtn.dataset.id);
                                if (tipoEntrega === 'activos') {
                                    equiposEntregados = equiposEntregados.filter(eq => eq.id !== id);
                                    renderEquiposEntregados();
                                } else {
                                    equipos = equipos.filter(eq => eq.id !== id);
                                    renderEquiposList();
                                }
                                hideModal();
                            }
                        }
                    ]);
                }
            });

            listaEquiposBody.addEventListener('change', (e) => {
                const id = Number(e.target.dataset.id);
                const equiposArray = tipoEntrega === 'activos' ? equiposEntregados : equipos;
                const equipo = equiposArray.find(eq => eq.id === id);
                if (!equipo) return;

                if (e.target.classList.contains('dano-check')) { equipo.dano = e.target.checked; }
                if (e.target.classList.contains('faltante-check')) { equipo.faltante = e.target.checked; }

                if (e.target.classList.contains('paquete-select')) {
                    equipo.idPaquete = e.target.value || null;
                }

                updatePreview();
            });

            // Event listeners para equipos entregados
            equiposEntregadosBody.addEventListener('change', (e) => {
                const id = Number(e.target.dataset.id);
                const equipo = equiposEntregados.find(eq => eq.id === id);
                if (!equipo) return;

                if (e.target.classList.contains('dano-check')) { equipo.dano = e.target.checked; }
                if (e.target.classList.contains('faltante-check')) { equipo.faltante = e.target.checked; }

                updatePreview();
            });

            equiposEntregadosBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');

                if (editBtn) {
                    const id = Number(editBtn.dataset.id);
                    const equipoToEdit = equiposEntregados.find(eq => eq.id === id);
                    if (equipoToEdit) {
                        // Cargar equipo en formulario de edición (mismo código que antes)
                        equipmentFormContainer.classList.remove('hidden');
                        // ... resto del código de edición
                        editingEquipoId = id;
                        eqForm.btn.textContent = 'Actualizar Equipo';
                    }
                }

                if (deleteBtn) {
                    const id = Number(deleteBtn.dataset.id);
                    equiposEntregados = equiposEntregados.filter(eq => eq.id !== id);
                    renderEquiposEntregados();
                }
            });

            const updateCodigoActivo = () => {
                const tipo = eqForm.tipo.value.toUpperCase();
                const serie = eqForm.serie.value.toUpperCase();
                let prefix = '';
                switch (tipo) {
                    case 'PC': prefix = 'PC-I5-'; break;
                    case 'LAPTOP L14': prefix = 'LA-L14-'; break;
                    case 'LAPTOP P16V': prefix = 'ESP-LA-i7-'; break;
                    case 'LAPTOP YOGA': prefix = 'LA-GE-'; break;
                    case 'MONITOR': prefix = 'MO-22-'; break;
                    case 'CARGADOR': prefix = 'CA-AL-'; break;
                    case 'TECLADO': prefix = 'TE-AL-'; break;
                    case 'RATÓN': prefix = 'MS-AL-'; break;
                }
                eqForm.codigo.value = (prefix && serie) ? prefix + serie : 'N/A';
            };
            const updateChangeCodigoActivo = () => {
                const tipo = changeEqForm.tipo.value.toUpperCase();
                const serie = changeEqForm.serie.value.toUpperCase();
                let prefix = '';
                switch (tipo) {
                    case 'LAPTOP': prefix = 'LA-L14-'; break;
                    case 'LAPTOP L14': prefix = 'LA-L14-'; break;
                    case 'LAPTOP P16V': prefix = 'ESP-LA-i7-'; break;
                    case 'LAPTOP YOGA': prefix = 'LA-GE-'; break;
                    case 'MONITOR': prefix = 'MO-22-'; break;
                    case 'CARGADOR': prefix = 'CA-AL-'; break;
                    case 'TECLADO': prefix = 'TE-AL-'; break;
                    case 'RATÓN': prefix = 'MS-AL-'; break;
                }
                changeEqForm.codigo.value = (prefix && serie) ? prefix + serie : 'NA';
            };

            eqForm.tipo.addEventListener('change', updateCodigoActivo);
            eqForm.serie.addEventListener('input', updateCodigoActivo);

            function getFullEmail() {
                const user = correoUsuarioInput.value;
                let domain = correoDominioSelect.value;
                if (domain === 'otro') {
                    domain = correoDominioManual.value.replace('@', '');
                }
                if (user && domain) {
                    return `${user}@${domain}`;
                }
                return '';
            }

            async function getFormData() {
                const data = {};
                allFormInputIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) data[id] = el.value;
                });
                data.firmar_jefatura = firmarJefaturaCheck.checked;
                data.equipos = tipoEntrega === 'activos' ? equiposEntregados : equipos;
                data.correo = getFullEmail();
                data.tipoRetiro = tipoRetiro;
                data.activosParaRetiro = activosParaRetiro;
                data.tipoEntrega = tipoEntrega;
                data.equiposEntregados = equiposEntregados;
                data.activosMantiene = activosMantiene;

                const photoPromises = fotosParaActa.map(item => {
                    if (item.type === 'base64') {
                        return Promise.resolve(item.data);
                    }
                    return toBase64(item.data);
                });
                data.fotos = await Promise.all(photoPromises);

                return data;
            }

            // CORRECCIÓN: Función updatePreview actualizada para mostrar activos que mantiene
            async function updatePreview() {
                try {
                    const data = await getFormData();
                    previewContent.innerHTML = await getPreviewHtml(data);
                } catch (error) {
                    console.error("Error al actualizar la vista previa:", error);
                }
            }
            

            function validateForm() {
                const requiredFields = ['acta_n', 'fecha', 'tecnico_responsable', 'usuario', 'nombre', 'cedula', 'hostname'];
                for (const id of requiredFields) {
                    const el = document.getElementById(id);
                    if (!el || el.value.trim() === '') {
                        let fieldName = el.placeholder || id;
                        const label = document.querySelector(`label[for="${id}"]`);
                        if (label) {
                            fieldName = label.innerText;
                        }
                        //showModal('Datos Incompletos', `El campo "${fieldName}" es obligatorio.`);
                        Swal.fire({
                            icon: 'error',                             // Muestra el ícono de la palomita verde
                            title: '¡UPSS!',                            // El título principal
                            text: 'Datos Incompletos',                      // El texto secundario
                            text: `💾🧏‍♂️🧏‍♀️El campo "${fieldName}" es obligatorio.🗃️🗄️💽`, // El texto secundario
                            timer: 2000,                                 // Se cierra automáticamente después de 2.5 segundos
                            showConfirmButton: false,                    // Oculta el botón "OK"
                            timerProgressBar: true                       // Muestra una barrita de progreso para el tiempo
                        });
                        return false;
                    }
                }

                if (observacionesTextarea.value.trim() === '') {
                    //showModal('Datos Incompletos', 'El campo de observaciones no puede estar vacío.');
                    Swal.fire({
                            icon: 'error',                             // Muestra el ícono de la palomita verde
                            title: '¡UPSS!',                            // El título principal
                            text: 'Datos Incompletos',                      // El texto secundario
                            text: `El campo de observaciones no puede estar vacío. 😶‍🌫️`, // El texto secundario
                            timer: 2000,                                 // Se cierra automáticamente después de 2.5 segundos
                            showConfirmButton: false,                    // Oculta el botón "OK"
                            timerProgressBar: true                       // Muestra una barrita de progreso para el tiempo
                        });
                    return false;
                }

                const equiposParaValidar = tipoEntrega === 'activos' ? equiposEntregados : equipos;
                if (equiposParaValidar.length === 0) {
                    //showModal('Datos Incompletos', 'Debe agregar al menos un activo a la tabla.');
                    Swal.fire({
                            icon: 'fa-solid fa-desktop',                             // Muestra el ícono de la palomita verde
                            title: '¡UPSS!',                            // El título principal
                            text: 'Datos Incompletos',                      // El texto secundario
                            text: `💻🖥️Debe agregar al menos un activo a la tabla.🖲️🖱️⌨️`, // El texto secundario
                            timer: 2000,                                 // Se cierra automáticamente después de 2.5 segundos
                            showConfirmButton: false,                    // Oculta el botón "OK"
                            timerProgressBar: true                       // Muestra una barrita de progreso para el tiempo
                        });
                    return false;
                }

                return true;
            }

            //const legalTextHTML = `<h3>ACEPTACIÓN DEL USUARIO</h3><p>EL USUARIO AL SUSCRIBIR ESTA ACTA, ACEPTA LAS CONDICIONES Y OBSERVACIONES DESCRITAS.</p><h3>CONDICIONES DEL EQUIPO RECIBIDO</h3><p>EL USUARIO AL SUSCRIBIR ESTA ACTA, CONFIRMA</p><ul><li>EL EQUIPO SE ENCUENTRA EN PERFECTAS CONDICIONES Y CON LAS EXCEPCIONES DESCRITAS EN LAS OBSERVACIONES.</li><li>EL EQUIPO SE ENCUENTRA COMPLETO, CON CABLES DE ALIMENTACIÓN, ADAPTADORES, ANTENAS Y OTROS COMPONENTES BÁSICOS PARA EL ADECUADO FUNCIONAMIENTO DE ACUERDO AL TIPO DE EQUIPO RECIBIDO.</li></ul><h3>ACEPTACIÓN DE RESPONSABILIDAD</h3><p>EL TRABAJADOR/USUARIO QUE SUSCRIBE LA RECEPCIÓN DE EQUIPOS MEDIANTE ESTA ACTA AUTORIZA EXPRESAMENTE DE FORMA LIBRE Y VOLUNTARIA A LA EMPRESA DESCONTAR DE MI REMUNERACIÓN MENSUAL Y/O LIQUIDACIÓN DE HABERES, O DEL MONTO FACTURADO, POR LOS DAÑOS OCASIONADOS POR MALA MANIPULACIÓN EN LOS EQUIPOS, PERDIDA DE EQUIPOS ASIGNADOS, OBSOLESCENCIA DE LOS MISMOS CHE SEAN DIFERENTES AL DE UN DETERIORO NORMAL, ENTRE OTROS CONCEPTOS DETERMINADOS POR NEGLIGENCIA EN EL MANEJO DE EQUIPOS POR PARTE DEL COLABORADOR Y SUSTENTADOS MEDIANTE UN INFORME DEL ÁREA TÉCNICA RESPONSABLE, EL CUAL CONTENDRÁ LOS ARGUMENTOS TÉCNICOS Y ECONÓMICOS A APLICARSE DE ACUERDO A LA POLÍTICA DE MANEJO DE EQUIPOS TI POR INCIDENTES O DESVINCULACIÓN.</p><h3>NORMAS DE SEGURIDAD E USO DE EQUIPOS</h3><ul><li>LOS EQUIPOS ESTÁN CONTEMPLADOS COMO PUESTOS DE TRABAJO INDIVIDUAL, POR LO TANTO, CUALQUIER MAL MANEJO O UTILIZACIÓN INDEBIDA DE LA INFORMACIÓN DE ESTE, SERÁ DE EXCLUSIVA RESPONSABILIDAD DEL CUSTODIO (USUARIO/TRABAJADOR), ASÍ COMO EL REALIZAR COPIAS DE SEGURIDAD DE LOS DATOS CHE CONSIDERE RELEVANTE.</li><li>LA SOCIEDAD PODRÁ REALIZAR EL MONITOREO DEL USO DE EQUIPO, PARA DETERMINAR EL MANEJO ADEUDADO DEL BIEN, COMO LA PRODUCTIVIDAD DEL MISMO POR LO QUE A TRAVÉS DEL PRESENTE DOCUMENTO AUTORIZA EXPRESAMENTE LA REVISIÓN Y MONITOREO DEL EQUIPO, SIN CHE PUEDA ALEJAR DESCONOCIMIENTO O VIOLACIÓN A GARANTÍA O DERECHO DEL COLABORADOR.</li><li>LA UTILIZACIÓN DE INTERNET ES PARA TRABAJOS DE LA EMPRESA, LOS EQUIPOS SON UNA HERRAMIENTA DE TRABAJO DE LA EMPRESA, DE MODO QUE ESTÁ PROHIBIDA LA UTILIZACIÓN DE JUEGOS, CHAT (MESSENGER, ETC), PROGRAMAS DE DESCARGA (KAZZA, EMULE...) O MENSAJERÍA A MÓVILES, MÚSICA, VIDEOS, CONTENIDOS NO ACORDES A LA ÉTICA Y MORAL, TRABAJOS E INFORMACIÓN DE CARÁCTER PERSONAL SIENDO SU RESPONSABILIDAD CONSERVAR ESPACIO SUFICIENTE EN EL DISCO DURO O SU INFORMACIÓN.</li><li>ESTÁ TOTALMENTE PROHIBIDA LA INSTALACIÓN DE SOFTWARE EN LOS EQUIPOS, LOS EQUIPOS DEBERÁN CONTENER LA CONFIGURACIÓN ESTÁNDAR Y NO MODIFICAR PANEL DE CONTROL FONDOS DE PANTALLA, EL USUARIO DEBERÁ MANTENER LIMPIEZA EXTERNA EN LOS EQUIPOS INFORMÁTICOS SIN UTILIZAR LÍQUIDOS O SOLVENTES QUE PUEDAN AFECTAR EL ESTADO DEL EQUIPO.</li><li>EN CASO DE ENCONTRAR SOFTWARE NO AUTORIZADO EN SU EQUIPO DEBERÁ COMUNICAR A SEGURIDAD DE LA INFORMACIÓN.</li><li>NO SE PUEDEN MOVER LOS EQUIPOS DE SU Puesto ORIGINAL (SALVO AUTORIZACIÓN DIRECTA DE SU GERENCIA O JEFATURA), DESCONECTAR CABLE ALGUNO O INTERCAMBIAR TECLADOS, RATONES U OTROS ACCESORIOS. SI EL EQUIPO NO FUNCIONA CORRECTAMENTE SE COMUNICARÁ A MESA DE AYUDA (F11). SE DEBERÁ CUIDAR AL EQUIPO E SUS COMPONENTES DE LA HUMEDAD, FUENTES DE CALOR, POLVO, TABACO, COMIDAS Y BEBIDAS.</li><li>LOS EQUIPOS SERÁN INSTALADOS, CONFIGURADOS Y MANTENIDOS EXCLUSIVamente POR TI. NINGÚN USUARIO ESTÁ AUTORIZADO A UTILIZAR ANALIZADORES DE TRÁFICO.</li><li>IGUALMENTE ESTÁ PROHIBIDO UTILIZAR PROGRAMAS O DISPOSITIVOS QUE PERMITAN EL RASTREO DE PUERTOS O QUE PERMITAN DESCUBRIR VULNERABILIDADES, PROGRAMAS DE CONEXIÓN REMOTA (TEAM VIEWER, ANY DESK, ETC); EL USO DE ESTAS HERRAMIENTAS ESTÁ PERMITIDO ÚNICAMENTE A LOS ADMINISTRADORES DE LA RED Y BAJO SITUACIONES ESPECIALES (INCIDENTES DE SEGURIDAD, DENUNCIAS DE USUARIOS, ETC.) QUE LOS JUSTIFIQUEN.</li><li>LAS CUENTAS DE IDENTIFICACIÓN Y SUS CLAVES ASIGNADAS SON DE USO PERSONAL E INTRANSFERIBLE, SIENDO RESPONSABLE EL USUARIO/TRABAJADOR/CUSTODIO, LAS CONSECUENCIAS DE ENTREGARLAS. LAS CUENTAS DE IDENTIFICACIÓN DISPONDRÁN DE SU PROPIA NORMATIVA DE ASIGNACIÓN, USO Y REVOCACIÓN. NO ESTÁ PERMITIDO FACILITAR U OFRECER LAS CUENTAS DE CORREO O USUARIO Y CONTRASEÑAS A TERCERAS PERSONAS. ESTÁ PROHIBIDA LA UTILIZACIÓN ABUSIVA DE CORREO ELECTRÓNICO Y DE LAS LISTAS DE DISTRIBUCIÓN INCLUYENDO LA REALIZACIÓN DE PRÁCTICAS TALES COMO ENVÍO MASIVO, ACTIVIDADES PRIVADAS, PROPAGACIÓN DE CARTAS ENCADENADAS, EL INSULTO, LA AMENAZA O DIFAMACIÓN A CUALQUIER PERSONA.</li><li>LOS USUARIOS EVITARAN EN LA MEDIDA DE SUS POSIBILIDADES, QUE SUS EQUIPOS SE VEAN AFECTADOS POR VIRUS, TROYANOS, PUERTAS TRASERAS, ETC. PARA LO CUAL TI PROPORCIONARÁ LAS HERRAMIENTAS Y ASISTENCIA NECESARIA. EN CASO DE INFECCIÓN TENDRÁ LA OBLIGACIÓN DE NOTIFICAR A T.I.</li><li>EN CASO DE INCUMPLIMIENTO DE LAS REGLAS Y OBLIGACIONES DESCRITAS, TI PODRÁ LLEVAR A LA INMEDIATA SUSPENSIÓN DEL SERVICIO PRESTADO Y/O EL BLOQUEO TEMPORAL DE SISTEMAS, CUENTAS O CONEXIONES DE RED EN LA MEDIDA CHE SE REQUIERA PARA GARANTIZAR EL BUEN SERVICIO Y PROTEGER LOS INTERESES DE LA EMPRESA Y EL RESTO DE LOS USUARIOS, COMUNICANDO AL USUARIO DE SER POSIBLE.</li><li>EL EQUIPO NO PUEDE SALIR DE LA ORGANIZACIÓN, SALVO EXCEPCIONES PREVIA AUTORIZACIÓN DEL ÁREA DE SEGURIDAD DE LA INFORMACIÓN.</li><li>SE ENCUENTRA PROHIBIDO EL USO DEL EQUIPO DE MANERA REMOTA, SALVO EXCEPCIONES PREVIA AUTORIZACIÓN DEL ÁREA DE SEGURIDAD DE LA INFORMACIÓN.</li><li>CUALQUIER INOBSERVANCIA O INCUMPLIMIENTO A LAS CONDICIONES E RESPONSABILIDADES DESCRITAS EN ESTA ACTA, EL USUARIO/TRABAJADOR/CUSTODIO, ACEPTA LA RESPONSABILIDAD Y LOS VALORES CHE DERIVEN DE LA ACCIÓN.</li></ul><h3>CONSIDERACIONES IMPORTANTES</h3><ol><li>EL USUARIO POR LA PRESENTE ACTA HA RECIBIDO LOS EQUIPOS Y PROGRAMAS DETALLADOS.</li><li>CON LA ENTREGA DE DICHOS EQUIPOS SE LE ENTREGO ADJUNTO LAS NORMAS DE SEGURIDAD E USO DE EQUIPOS DE TI PARA SU CORRECTO USO Y APLICACIÓN.</li><li>QUE CONOCE DE LA OBLIGATORIEDAD DE ESTE.</li><li>QUE, EN CASO DE PÉRDIDA O DETERIORO DE LOS EQUIPOS O CUALQUIER SINIESTRO, NOTIFICARÁ A LA EMPRESA INMEDIATamente PARA LOS TRÁMITES CORRESPONDIENTES.</li><li>LOS COSTOS POR REPOSICIÓN O DAÑO DEL EQUIPO SERÁN CALCULADOS DE ACUERDO CON EL TIPO DEL SINIESTRO PRESENTADO EN SU MOMENTO Y SEGÚN LAS CONDICIONES EN QUE ESTE SE HAYA DADO.</li><li>QUE ES CONOCEDOR DE LAS RESPONSABILIDADES QUE ACARREARA EL INCUMPLIMIENTO DE ESTAS OBLIGACIONES (SEGÚN REGLAMENTO INTERNO).</li><li>LA DUPLICACIÓN SIN LICENCIA O USO DE PROGRAMAS PIRATAS, ES ILEGAL Y PUEDE SER MOTIVO DE EXPONERLOS A USTEDES Y A LA EMPRESA A RESPONSABILIDAD CIVIL O PENAL BAJO LAS LEYES DE DERECHOS DE AUTOR. ESTO INCLUYE LA OBTENCIÓN DE PROGRAMAS NO AUTORIZADOS A TRAVÉS DE INTERNET.</li><li>LA EXTRACCIÓN O DIVULGACIÓN DE INFORMACIÓN DE LA EMPRESA, POR CUALQUIER MEDIO, DEBERÁ CONTAR CON LA AUTORIZACIÓN DE LOS DIRECTIVOS, Y SU INCUMPLIMIENTO SE SOMETE A LA LEY DE PROPIEDAD INTELECTUAL. (ARTÍCULOS 601 DEL CÓDIGO CIVIL, 45 DEL CÓDIGO DE TRABAJO LITERAL H,Y 183 DE LA LEY DE PROPIEDAD INTELECTUAL)</li><li>CUALQUIER DUDA ACERCA DEL USO O NECESIDAD DE SOFTWARE, DEBERÁ SER CONSULTADA A T.I.</li></ol><p>PARA QUE CONSTE LO EXPUESTO, SE FIRMA LA PRESENTE ACTA DE RECEPCIÓN (FORMULARIO DE DISTRIBUCIÓN - REUBICACIÓN DE ACTIVOS FIJOS)<br>NOTA: TODO MOVIMIENTO DE EQUIPO SEGÚN SE HA DEFINIDO EN LINEAMIENTO PTI-IS-001 DEBERÁ ESTAR ACOMPAÑADO POR EL ACTA ENTREGA - RECEPCIÓN DEBIDAMENTE FIRMADO. SE ENTREGARÁ UN DOCUMENTO FÍSICO AL USUARIO/TRABAJADOR</p>`;
            // Busca esta línea en tu código (alrededor de la línea 1385) y reemplázala:
            // Línea problemática actual:
            // const legalTextHTML = '<h3>ACEPTACION DEL USUARIO</h3>' + ...

            // REEMPLAZAR CON ESTA VERSIÓN CORREGIDA:
            const legalTextHTML = '<h3>ACEPTACION DEL USUARIO</h3>' +
                '<p>EL USUARIO AL SUSCRIBIR ESTA ACTA, ACEPTA LAS CONDICIONES Y OBSERVACIONES DESCRITAS.</p>' +
                '<h3>CONDICIONES DEL EQUIPO RECIBIDO</h3>' +
                '<p>EL USUARIO AL SUSCRIBIR ESTA ACTA, CONFIRMA</p>' +
                '<ul>' +
                '<li>EL EQUIPO SE ENCUENTRA EN PERFECTAS CONDICIONES Y CON LAS EXCEPCIONES DESCRITAS EN LAS OBSERVACIONES.</li>' +
                '<li>EL EQUIPO SE ENCUENTRA COMPLETO, CON CABLES DE ALIMENTACION, ADAPTADORES, ANTENAS Y OTROS COMPONENTES BASICOS PARA EL ADECUADO FUNCIONAMIENTO DE ACUERDO AL TIPO DE EQUIPO RECIBIDO.</li>' +
                '</ul>' +
                '<h3>ACEPTACION DE RESPONSABILIDAD</h3>' +
                '<p>EL TRABAJADOR/USUARIO QUE SUSCRIBE LA RECEPCION DE EQUIPOS MEDIANTE ESTA ACTA AUTORIZA EXPRESAMENTE DE FORMA LIBRE Y VOLUNTARIA A LA EMPRESA DESCONTAR DE MI REMUNERACION MENSUAL Y/O LIQUIDACION DE HABERES, O DEL MONTO FACTURADO, POR LOS DAÑOS OCASIONADOS POR MALA MANIPULACION EN LOS EQUIPOS, PERDIDA DE EQUIPOS ASIGNADOS, OBSOLESCENCIA DE LOS MISMOS QUE SEAN DIFERENTES AL DE UN DETERIORO NORMAL, ENTRE OTROS CONCEPTOS DETERMINADOS POR NEGLIGENCIA EN EL MANEJO DE EQUIPOS POR PARTE DEL COLABORADOR Y SUSTENTADOS MEDIANTE UN INFORME DEL AREA TECNICA RESPONSABLE, EL CUAL CONTENDRA LOS ARGUMENTOS TECNICOS Y ECONOMICOS A APLICARSE DE ACUERDO A LA POLITICA DE MANEJO DE EQUIPOS TI POR INCIDENTES O DESVINCULACION.</p>' +
                '<h3>NORMAS DE SEGURIDAD E USO DE EQUIPOS</h3>' +
                '<ul>' +
                '<li>LOS EQUIPOS ESTAN CONTEMPLADOS COMO PUESTOS DE TRABAJO INDIVIDUAL, POR LO TANTO, CUALQUIER MAL MANEJO O UTILIZACION INDEBIDA DE LA INFORMACION DE ESTE, SERA DE EXCLUSIVA RESPONSABILIDAD DEL CUSTODIO (USUARIO/TRABAJADOR), ASI COMO EL REALIZAR COPIAS DE SEGURIDAD DE LOS DATOS QUE CONSIDERE RELEVANTE.</li>' +
                '<li>LA UTILIZACIÓN DE INTERNET ES PARA TRABAJOS DE LA EMPRESA, LOS EQUIPOS SON UNA HERRAMIENTA DE TRABAJO DE LA EMPRESA, DE MODO QUE ESTÁ PROHIBIDA LA UTILIZACIÓN DE JUEGOS, CHAT (MESSENGER, ETC), PROGRAMAS DE DESCARGA (KAZZA, EMULE...) O MENSAJERÍA A MÓVILES, MÚSICA, VIDEOS, CONTENIDOS NO ACORDES A LA ÉTICA Y MORAL, TRABAJOS E INFORMACIÓN DE CARÁCTER PERSONAL SIENDO SU RESPONSABILIDAD CONSERVAR ESPACIO SUFICIENTE EN EL DISCO DURO O SU INFORMACIÓN.</li>' +
                '<li>ESTÁ TOTALMENTE PROHIBIDA LA INSTALACIÓN DE SOFTWARE EN LOS EQUIPOS, LOS EQUIPOS DEBERÁN CONTENER LA CONFIGURACIÓN ESTÁNDAR Y NO MODIFICAR PANEL DE CONTROL FONDOS DE PANTALLA, EL USUARIO DEBERÁ MANTENER LIMPIEZA EXTERNA EN LOS EQUIPOS INFORMÁTICOS SIN UTILIZAR LÍQUIDOS O SOLVENTES QUE PUEDAN AFECTAR EL ESTADO DEL EQUIPO.</li>' +            
                '<li>EN CASO DE ENCONTRAR SOFTWARE NO AUTORIZADO EN SU EQUIPO DEBERÁ COMUNICAR A SEGURIDAD DE LA INFORMACIÓN.</li>' +
               
                '<li>NO SE PUEDEN MOVER LOS EQUIPOS DE SU PUESTO ORIGINAL (SALVO AUTORIZACIÓN DIRECTA DE SU GERENCIA O JEFATURA), DESCONECTAR CABLE ALGUNO O INTERCAMBIAR TECLADOS, RATONES U OTROS ACCESORIOS. SI EL EQUIPO NO FUNCIONA CORRECTAMENTE SE COMUNICARÁ A MESA DE AYUDA (F11). SE DEBERÁ CUIDAR AL EQUIPO Y SUS COMPONENTES DE LA HUMEDAD, FUENTES DE CALOR, POLVO, TABACO, COMIDAS Y BEBIDAS.</li>' +
                '<li>LOS EQUIPOS SERÁN INSTALADOS, CONFIGURADOS Y MANTENIDOS EXCLUSIVAMENTE POR TI. NINGÚN USUARIO ESTÁ AUTORIZADO A UTILIZAR ANALIZADORES DE TRÁFICO.</li>' +
                '<li>IGUALMENTE ESTÁ PROHIBIDO UTILIZAR PROGRAMAS O DISPOSITIVOS QUE PERMITAN EL RASTREO DE PUERTOS O QUE PERMITAN DESCUBRIR VULNERABILIDADES, PROGRAMAS DE CONEXIÓN REMOTA (TEAM VIEWER, ANY DESK, ETC); EL USO DE ESTAS HERRAMIENTAS ESTÁ PERMITIDO ÚNICAMENTE A LOS ADMINISTRADORES DE LA RED Y BAJO SITUACIONES ESPECIALES (INCIDENTES DE SEGURIDAD, DENUNCIAS DE USUARIOS, ETC.) QUE LOS JUSTIFIQUEN.</li>' +
                '<li>LAS CUENTAS DE IDENTIFICACIÓN Y SUS CLAVES ASIGNADAS SON DE USO PERSONAL E INTRANSFERIBLE, SIENDO RESPONSABLE EL USUARIO/TRABAJADOR/CUSTODIO, LAS CONSECUENCIAS DE ENTREGARLAS. LAS CUENTAS DE IDENTIFICACIÓN DISPONDRÁN DE SU PROPIA NORMATIVA DE ASIGNACIÓN, USO Y REVOCACIÓN. NO ESTÁ PERMITIDO FACILITAR U OFRECER LAS CUENTAS DE CORREO O USUARIO Y CONTRASEÑAS A TERCERAS PERSONAS. ESTÁ PROHIBIDA LA UTILIZACIÓN ABUSIVA DE CORREO ELECTRÓNICO Y DE LAS LISTAS DE DISTRIBUCIÓN INCLUYENDO LA REALIZACIÓN DE PRÁCTICAS TALES COMO: ENVÍO MASIVO, ACTIVIDADES PRIVADAS, PROPAGACIÓN DE CARTAS ENCADENADAS, EL INSULTO, LA AMENAZA O DIFAMACIÓN A CUALQUIER PERSONA.</li>'+
                '<li>LOS USUARIOS EVITARAN EN LA MEDIDA DE SUS POSIBILIDADES, QUE SUS EQUIPOS SE VEAN AFECTADOS POR VIRUS, TROYANOS, PUERTAS TRASERAS, ETC. PARA LO CUAL TI PROPORCIONARÁ LAS HERRAMIENTAS Y ASISTENCIA NECESARIA. EN CASO DE INFECCIÓN TENDRÁ LA OBLIGACIÓN DE NOTIFICAR A T.I.</li>'+
                '<li>EN CASO DE INCUMPLIMIENTO DE LAS REGLAS Y OBLIGACIONES DESCRITAS, TI PODRÁ LLEVAR A LA INMEDIATA SUSPENSIÓN DEL SERVICIO PRESTADO Y/O EL BLOQUEO TEMPORAL DE SISTEMAS, CUENTAS O CONEXIONES DE RED EN LA MEDIDA QUE SE REQUIERA PARA GARANTIZAR EL BUEN SERVICIO Y PROTEGER LOS INTERESES DE LA EMPRESA Y EL RESTO DE LOS USUARIOS, COMUNICANDO AL USUARIO DE SER POSIBLE.</li>'+
                '<li>EL EQUIPO NO PUEDE SALIR DE LA ORGANIZACIÓN, SALVO EXCEPCIONES PREVIA AUTORIZACIÓN DEL ÁREA DE SEGURIDAD DE LA INFORMACIÓN.</li>'+
                '<li>SE ENCUENTRA PROHIBIDO EL USO DEL EQUIPO DE MANERA REMOTA, SALVO EXCEPCIONES PREVIA AUTORIZACIÓN DEL ÁREA DE SEGURIDAD DE LA INFORMACIÓN.</li>'+
                '<li>CUALQUIER INOBSERVANCIA O INCUMPLIMIENTO A LAS CONDICIONES Y RESPONSABILIDADES DESCRITAS EN ESTA ACTA, EL USUARIO/TRABAJADOR/CUSTODIO, ACEPTA LA RESPONSABILIDAD Y LOS VALORES QUE DERIVEN DE LA ACCIÓN.</li>'+

                '</ul>' +
                '<h3>CONSIDERACIONES IMPORTANTES</h3>' +
                '<ol>' +
                '<li>EL USUARIO POR LA PRESENTE ACTA HA RECIBIDO LOS EQUIPOS Y PROGRAMAS DETALLADOS.</li>' +
                '<li>CON LA ENTREGA DE DICHOS EQUIPOS SE LE ENTREGO ADJUNTO LAS NORMAS DE SEGURIDAD Y USO DE EQUIPOS DE TI PARA SU CORRECTO USO Y APLICACIÓN.</li>' +
                '<li>QUE CONOCE DE LA OBLIGATORIEDAD DE ESTE.</li>' +
                '<li>QUE, EN CASO DE PÉRDIDA O DETERIORO DE LOS EQUIPOS, NOTIFICARÁ A LA EMPRESA INMEDIATAMENTE PARA LOS TRÁMITES CORRESPONDIENTES.</li>' +
                '<li>LOS COSTOS POR REPOSICIÓN O DAÑO DEL EQUIPO SERÁN CALCULADOS DE ACUERDO CON EL TIPO DEL SINIESTRO PRESENTADO EN SU MOMENTO Y SEGÚN LAS CONDICIONES EN QUE ESTE SE HAYA DADO.</li>' +
                '<li>QUE ES CONOCEDOR DE LAS RESPONSABILIDADES QUE ACARREARA EL INCUMPLIMIENTO DE ESTAS OBLIGACIONES (SEGÚN REGLAMENTO INTERNO).</li>' +
                '<li>LA DUPLICACIÓN SIN LICENCIA O USO DE PROGRAMAS PIRATAS, ES ILEGAL Y PUEDE SER MOTIVO DE EXPONERLOS A USTEDES Y A LA EMPRESA A RESPONSABILIDAD CIVIL O PENAL BAJO LAS LEYES DE DERECHOS DE AUTOR. ESTO INCLUYE LA OBTENCIÓN DE PROGRAMAS NO AUTORIZADOS A TRAVÉS DE INTERNET.</li>'+
                '<li>LA EXTRACCIÓN O DIVULGACIÓN DE INFORMACIÓN DE LA EMPRESA, POR CUALQUIER MEDIO, DEBERÁ CONTAR CON LA AUTORIZACIÓN DE LOS DIRECTIVOS, Y SU INCUMPLIMIENTO SE SOMETE A LA LEY DE PROPIEDAD INTELECTUAL. (ARTÍCULOS 601 DEL CÓDIGO CIVIL, 45 DEL CÓDIGO DE TRABAJO LITERAL HY 183 DE LA LEY DE PROPIEDAD INTELECTUAL).</li>'+
                '<li>CUALQUIER DUDA ACERCA DEL USO O NECESIDAD DE SOFTWARE DEBERÁ SER CONSULTADA A T.I.</li>'+
                '</ol>' +
                '<p><h3>NOTA: TODO MOVIMIENTO DE EQUIPO SEGÚN SE HA DEFINIDO EN LINEAMIENTO PTI-IS-001 DEBERÁ ESTAR ACOMPAÑADO POR EL ACTA ENTREGA - RECEPCIÓN DEBIDAMENTE FIRMADO. SE ENTREGARÁ UN DOCUMENTO FÍSICO AL USUARIO/TRABAJADOR.</h3></p>';
            // CORRECCIÓN PRINCIPAL: Función getPreviewHtml actualizada para mostrar activos que mantiene
            async function getPreviewHtml(data) {
                let finalHtml = '';

                const formattedDate = data.fecha ? new Date(data.fecha + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                const tecnicoSeleccionado = tecnicos.find(t => t.cedula === data.tecnico_responsable) || { nombre: '', cedula: '' };
                const generadoPor = tecnicoSeleccionado.nombre;

                finalHtml += `
                  <div id="acta-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid rgba(24,121,174,1); margin-bottom: 15px;">
                      <div style="width: 4cm;"></div>
                      <h1 style="font-size: 16pt; font-weight: bold; color: rgba(24,121,174,1); margin: 0; padding: 0; border: none; text-align: center; flex-grow: 1;">ACTA DE ${data.tipo_acta.toUpperCase()}</h1>
                      <img src="consenso.png" alt="Logo Consenso" style="height: 1.5cm; object-fit: contain; max-width: 4cm;">
                  </div>
                  <table class="data-table" style="border: 1px solid rgba(24,121,174,1);">
                      <thead><tr><th colspan="8" style="background-color: rgba(24,121,174,1); color: white; text-align: center; font-size: 11pt;">DATOS DEL CONTRATO</th></tr></thead>
                      <tbody>
                          <tr><td class="label">N° ACTA</td><td>${data.acta_n}</td><td class="label">FECHA</td><td>${formattedDate}</td><td class="label">GENERADO POR</td><td colspan="3">${generadoPor}</td></tr>
                          <tr><td class="label" rowspan="2">USUARIO</td><td rowspan="2">${data.usuario}</td><td class="label" rowspan="2">NOMBRE</td><td rowspan="2" colspan="3">${data.nombre}</td><td class="label">CIUDAD</td><td>${data.ciudad}</td></tr>
                          <tr><td class="label">UBICACIÓN</td><td>${data.ubicacion}</td></tr>
                          <tr><td class="label" rowspan="2">EMPRESA</td><td rowspan="2">${data.empresa}</td><td class="label">CÉDULA</td><td colspan="3">${data.cedula}</td><td class="label">DEPARTAMENTO</td><td>${data.departamento}</td></tr>
                          <tr><td class="label">CORREO</td><td colspan="3">${data.correo}</td><td class="label">ZONA</td><td>${data.zona}</td></tr>
                          <tr><td class="label">HOSTNAME</td><td>${data.hostname}</td><td class="label">JEFATURA</td><td colspan="3">${data.jefatura}</td><td class="label">TICKET</td><td>${data.ticket}</td></tr>
                          <tr><td class="label" style="background-color: rgba(24,121,174,1); color: white;">OBSERVACIONES</td><td colspan="7">${data.observaciones}</td></tr>
                      </tbody>
                  </table>`;

                const tipoActaUpper = data.tipo_acta.toUpperCase();

                // Lógica especial para entrega de activos específicos
                if (tipoActaUpper.includes('ENTREGA') && data.tipoEntrega === 'activos') {
                    // Mostrar activos entregados
                    if (data.equiposEntregados && data.equiposEntregados.length > 0) {
                        const entregadosRows = data.equiposEntregados.map(e =>
                            `<tr><td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td><td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.estado || ''}</td><td>${e.dano ? 'SÍ' : 'NO'}</td><td>${e.codigo || 'NA'}</td></tr>`
                        ).join('');

                        finalHtml += `
                          <h2 style="margin-top: 15px;">ACTIVOS ENTREGADOS</h2>
                          <table class="equipment-table">
                              <thead><tr><th>TIPO</th><th>MTM/SKU</th><th>MARCA</th><th>DESCRIPCIÓN</th><th>SERIE</th><th>ESTADO</th><th>DAÑOS</th><th>CÓDIGO DE ACTIVO</th></tr></thead>
                              <tbody>${entregadosRows}</tbody>
                          </table>`;
                    }

                    // Mostrar activos que mantiene
                    if (data.activosMantiene && data.activosMantiene.length > 0) {
                        const mantienesRows = data.activosMantiene.map(e =>
                            `<tr><td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td><td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.estado || ''}</td><td>${e.dano ? 'SÍ' : 'NO'}</td><td>${e.codigo || 'NA'}</td></tr>`
                        ).join('');

                        finalHtml += `
                          <h2 style="margin-top: 15px;">ACTIVOS QUE MANTIENE EL USUARIO</h2>
                          <table class="equipment-table">
                              <thead><tr><th>TIPO</th><th>MTM/SKU</th><th>MARCA</th><th>DESCRIPCIÓN</th><th>SERIE</th><th>ESTADO</th><th>DAÑOS</th><th>CÓDIGO DE ACTIVO</th></tr></thead>
                              <tbody>${mantienesRows}</tbody>
                          </table>`;
                    }
                }
                // Lógica especial para retiros específicos
                else if (tipoActaUpper.includes('RETIRO') && tipoRetiro === 'especificos') {
                    const equiposRetirados = activosParaRetiro;
                    const equiposQueMantiene = equipos.filter(eq => !activosParaRetiro.some(ar => ar.id === eq.id));

                    // Tabla de equipos retirados
                    if (equiposRetirados.length > 0) {
                        const retiradosRows = equiposRetirados.map(e =>
                            `<tr><td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td><td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.estado || ''}</td><td>${e.dano ? 'SÍ' : 'NO'}</td><td>${e.codigo || 'NA'}</td></tr>`
                        ).join('');

                        finalHtml += `
                          <h2 style="margin-top: 15px;">ACTIVOS RETIRADOS</h2>
                          <table class="equipment-table">
                              <thead><tr><th>TIPO</th><th>MTM/SKU</th><th>MARCA</th><th>DESCRIPCIÓN</th><th>SERIE</th><th>ESTADO</th><th>DAÑOS</th><th>CÓDIGO DE ACTIVO</th></tr></thead>
                              <tbody>${retiradosRows}</tbody>
                          </table>`;
                    }

                    // Tabla de equipos que mantiene
                    if (equiposQueMantiene.length > 0) {
                        const mantienesRows = equiposQueMantiene.map(e =>
                            `<tr><td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td><td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.estado || ''}</td><td>${e.dano ? 'SÍ' : 'NO'}</td><td>${e.codigo || 'NA'}</td></tr>`
                        ).join('');

                        finalHtml += `
                          <h2 style="margin-top: 15px;">ACTIVOS QUE MANTIENE EL USUARIO</h2>
                          <table class="equipment-table">
                              <thead><tr><th>TIPO</th><th>MTM/SKU</th><th>MARCA</th><th>DESCRIPCIÓN</th><th>SERIE</th><th>ESTADO</th><th>DAÑOS</th><th>CÓDIGO DE ACTIVO</th></tr></thead>
                              <tbody>${mantienesRows}</tbody>
                          </table>`;
                    }
                } else {
                    // Lógica original para otros tipos de acta o retiro completo
                    const equiposPresentes = data.equipos.filter(e => !e.faltante);
                    //const paquetes = equiposPresentes.filter(e => ['PC', 'LAPTOP'].includes((e.tipo || '').toUpperCase()));
                    const tiposDeComputadora = ['PC', 'LAPTOP', 'IMAC', 'MAC STUDIO', 'MACBOOK', 'MACBOOKPRO', 'WORKSTATION'];
                    const paquetes = equiposPresentes.filter(e => tiposDeComputadora.includes((e.tipo || '').toUpperCase()));
                    //const equiposSinPaquete = equiposPresentes.filter(e => !e.idPaquete && !['PC', 'LAPTOP'].includes((e.tipo || '').toUpperCase()));
                    const equiposSinPaquete = equiposPresentes.filter(e => !e.idPaquete && !tiposDeComputadora.includes((e.tipo || '').toUpperCase()));

                    const tableHeader = `<thead><tr class="equipment-table"><th>TIPO</th><th>MTM/SKU</th><th>MARCA</th><th>DESCRIPCIÓN</th><th>SERIE</th><th>ESTADO</th><th>DAÑOS</th><th>CÓDIGO DE ACTIVO</th></tr></thead>`;

                    paquetes.forEach(paquete => {
                        finalHtml += `<h2 class="package-header">PAQUETE ${paquete.serie}</h2>`;
                        let paqueteRows = `<tr><td>${paquete.tipo || ''}</td><td>${paquete.mtm || 'NA'}</td><td>${paquete.marca || ''}</td><td>${paquete.desc || ''}</td><td>${paquete.serie || 'NA'}</td><td>${paquete.estado || ''}</td><td>${paquete.dano ? 'SÍ' : 'NO'}</td><td>${paquete.codigo || 'NA'}</td></tr>`;

                        const perifericosAsignados = equiposPresentes.filter(p => p.idPaquete === paquete.serie);
                        perifericosAsignados.forEach(p => {
                            paqueteRows += `<tr><td>${p.tipo || ''}</td><td>${p.mtm || 'NA'}</td><td>${p.marca || ''}</td><td>${p.desc || ''}</td><td>${p.serie || 'NA'}</td><td>${p.estado || ''}</td><td>${p.dano ? 'SÍ' : 'NO'}</td><td>${p.codigo || 'NA'}</td></tr>`;
                        });

                        finalHtml += `<table class="equipment-table">${tableHeader}<tbody>${paqueteRows}</tbody></table>`;
                    });

                    if (equiposSinPaquete.length > 0) {
                        finalHtml += `<h2 class="package-header">ACTIVOS SIN ASIGNAR</h2>`;
                        let sinPaqueteRows = '';
                        equiposSinPaquete.forEach(e => {
                            sinPaqueteRows += `<tr><td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td><td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.estado || ''}</td><td>${e.dano ? 'SÍ' : 'NO'}</td><td>${e.codigo || 'NA'}</td></tr>`;
                        });
                        finalHtml += `<table class="equipment-table">${tableHeader}<tbody>${sinPaqueteRows}</tbody></table>`;
                    }

                    const equiposFaltantes = data.equipos.filter(e => e.faltante);
                    if (equiposFaltantes.length > 0) {
                        const faltantesRows = equiposFaltantes.map(e => `
                          <tr>
                              <td>${e.tipo || ''}</td><td>${e.mtm || 'NA'}</td><td>${e.marca || ''}</td>
                              <td>${e.desc || ''}</td><td>${e.serie || 'NA'}</td><td>${e.codigo || 'NA'}</td>
                          </tr>`).join('');
                        finalHtml += `
                          <h2 style="margin-top: 10px;">EQUIPOS FALTANTES</h2>
                          <table class="equipment-table" style="margin-top: 5px;">
                              <thead><tr><th>TIPO</th><th>MTM/SKU</th><th>MARCA</th><th>DESCRIPCIÓN</th><th>SERIE</th><th>CÓDIGO DE ACTIVO</th></tr></thead>
                              <tbody>${faltantesRows}</tbody>
                          </table>`;
                    }
                }

                const photoItems = (data.fotos || []).map(base64 => `<div class="photo-item"><img src="${base64}" alt="Fotografía del acta"></div>`).join('');
                const photoGalleryHTML = (data.fotos && data.fotos.length > 0) ? `<h2 style="margin-top: 20px;">FOTOGRAFÍAS</h2><div class="photo-gallery">${photoItems}</div>` : '';

                const esRetiroDevolucion = tipoActaUpper.includes('RETIRO') || tipoActaUpper.includes('DEVOLUCION');
                let firmaIzquierda = {}, firmaDerecha = {};

                if (esRetiroDevolucion) {
                    firmaIzquierda = { titulo: 'RECIBE', nombre: tecnicoSeleccionado.nombre, cedula: tecnicoSeleccionado.cedula };
                    firmaDerecha = { titulo: 'ENTREGA', nombre: data.nombre, cedula: data.cedula };
                    if (data.firmar_jefatura) { firmaDerecha.nombre = data.jefatura_nombre; firmaDerecha.cedula = data.jefatura_cedula; }
                } else {
                    firmaIzquierda = { titulo: 'RECIBE', nombre: data.nombre, cedula: data.cedula };
                    firmaDerecha = { titulo: 'ENTREGA', nombre: tecnicoSeleccionado.nombre, cedula: tecnicoSeleccionado.cedula };
                    if (data.firmar_jefatura) { firmaIzquierda.nombre = data.jefatura_nombre; firmaIzquierda.cedula = data.jefatura_cedula; }
                }

                const signatureHTML = `<table style="width: 100%; margin-top: 80px; page-break-inside: avoid; border: none !important;">
                                      <tbody>
                                          <tr>
                                              <td style="width: 50%; text-align: center; border: none !important; vertical-align: bottom; padding: 0 15px;">
                                                  <div style="height: 80px;"></div>
                                                  <div style="border-top: 1px solid black; margin-bottom: 8px;"></div>
                                                  <p style="text-align: center; margin: 0; font-size: 10pt; line-height: 1.4;">
                                                      <strong>${firmaIzquierda.titulo}</strong><br>${firmaIzquierda.nombre || 'NA'}<br>CI: ${firmaIzquierda.cedula || 'NA'}
                                                  </p>
                                              </td>
                                              <td style="width: 50%; text-align: center; border: none !important; vertical-align: bottom; padding: 0 15px;">
                                                  <div style="height: 80px;"></div>
                                                  <div style="border-top: 1px solid black; margin-bottom: 8px;"></div>
                                                  <p style="text-align: center; margin: 0; font-size: 10pt; line-height: 1.4;">
                                                      <strong>${firmaDerecha.titulo}</strong><br>${firmaDerecha.nombre || 'NA'}<br>CI: ${firmaDerecha.cedula || 'NA'}
                                                  </p>
                                              </td>
                                          </tr>
                                      </tbody>
                                   </table>`;

                return `<div>${finalHtml}${photoGalleryHTML}<div class="clausulas-container"><div class="legal-text">${legalTextHTML}</div></div>${signatureHTML}</div>`;
            }

            async function generatePdfWithAutoTable(getFilenameData, pageContentFunction, modalTitle) {
                if (!validateForm()) return;

                showModal(modalTitle, '', [], 'progress');
                await new Promise(res => setTimeout(res, 100));

                try {
                    updateModalProgress(10, 'Obteniendo datos del formulario...');
                    const dataForPdf = await getFormData();

                    updateModalProgress(25, 'Cargando recursos (logo, etc.)...');
                    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const logoRightBase64 = await imageToBase64('consenso.png');

                    updateModalProgress(50, 'Construyendo documento y tablas...');
                    await pageContentFunction(doc, dataForPdf, logoRightBase64);

                    updateModalProgress(90, 'Guardando archivo...');
                    const { filename, folderName } = await getFilenameData(dataForPdf);

                    const result = await window.api.savePdf({
                        pdfData: doc.output('arraybuffer'),
                        folderName: folderName,
                        filename: filename
                    });

                    updateModalProgress(100, '¡Completado!');
                    setTimeout(() => {
                        hideModal();
                        if (result.success) {
                            showModal('Éxito', `PDF guardado correctamente en:<br>${result.path}`);
                        } else {
                            showModal('Error', `No se pudo guardar el PDF: ${result.message}`);
                        }
                    }, 500);

                } catch (error) {
                    hideModal();
                    console.error(`Error al generar PDF:`, error);
                    showModal('Error', `Ocurrió un error al generar el PDF: ${error.message}`);
                }
            }

            async function pageContent(doc, data, logoRightBase64) {
                const tecnicoSeleccionado = tecnicos.find(t => t.cedula === data.tecnico_responsable) || { nombre: '', cedula: '' };
                const generadoPor = tecnicoSeleccionado.nombre;
                const formattedDate = data.fecha ? new Date(data.fecha + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';

                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                const logoHeight = 15;

                if (logoRightBase64) {
                    try {
                        const imgProps = doc.getImageProperties(logoRightBase64);
                        const imgWidth = (imgProps.width * logoHeight) / imgProps.height;
                        const x = pageWidth - imgWidth - margin;
                        doc.addImage(logoRightBase64, 'JPEG', x, 10, imgWidth, logoHeight);
                    } catch (e) { console.error("Error adding right logo:", e); }
                }

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor('#1879ae');

                const titleY = 10 + logoHeight + 8;
                doc.text(`ACTA DE ${data.tipo_acta.toUpperCase()}`, pageWidth / 2, titleY, { align: 'center' });

                const startY = titleY + 10;
                doc.setDrawColor('#1879ae');
                doc.setLineWidth(0.5);
                doc.line(margin, startY - 7, pageWidth - margin, startY - 7);

                const labelStyle = { fillColor: '#F2F2F2', textColor: '#1879ae', fontStyle: 'bold' };
                const headerStyle = { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold', halign: 'center' };

                doc.autoTable({
                    startY: startY,
                    body: [
                        [{ content: 'DATOS DEL CONTRATO', colSpan: 8, styles: headerStyle }],
                        [{ content: 'N° ACTA', styles: labelStyle }, data.acta_n || '', { content: 'FECHA', styles: labelStyle }, formattedDate, { content: 'GENERADO POR', styles: labelStyle }, { content: generadoPor || 'NA', colSpan: 3 }],
                        [{ content: 'USUARIO', rowSpan: 2, styles: labelStyle }, { content: data.usuario || 'NA', rowSpan: 2 }, { content: 'NOMBRE', rowSpan: 2, styles: labelStyle }, { content: data.nombre || 'NA', rowSpan: 2, colSpan: 3 }, { content: 'CIUDAD', styles: labelStyle }, data.ciudad || ''],
                        [{ content: 'UBICACIÓN', styles: labelStyle }, data.ubicacion || ''],
                        [{ content: 'EMPRESA', rowSpan: 2, styles: labelStyle }, { content: data.empresa || 'NA', rowSpan: 2 }, { content: 'CÉDULA', styles: labelStyle }, { content: data.cedula || 'NA', colSpan: 3 }, { content: 'DEPARTAMENTO', styles: labelStyle }, data.departamento || ''],
                        [{ content: 'CORREO', styles: labelStyle }, { content: data.correo || 'NA', colSpan: 3 }, { content: 'ZONA', styles: labelStyle }, data.zona || ''],
                        [{ content: 'HOSTNAME', styles: labelStyle }, data.hostname || '', { content: 'JEFATURA', styles: labelStyle }, { content: data.jefatura || 'NA', colSpan: 3 }, { content: 'TICKET', styles: labelStyle }, data.ticket || ''],
                        [{
                            content: 'OBSERVACIONES',
                            styles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                        }, {
                            content: data.observaciones || '',
                            colSpan: 7
                        }]
                    ],
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 7, cellPadding: 1.5, lineColor: '#1879ae', lineWidth: 0.1 },
                });

                let finalY = doc.autoTable.previous.finalY;

                const tipoActaUpper = data.tipo_acta.toUpperCase();

                // Lógica especial para entrega de activos específicos
                if (tipoActaUpper.includes('ENTREGA') && data.tipoEntrega === 'activos') {
                    // Tabla de activos entregados
                    if (data.equiposEntregados && data.equiposEntregados.length > 0) {
                        const entregadosBody = data.equiposEntregados.map(e => [
                            e.tipo || 'NA', e.mtm || 'NA', e.marca || 'NA', e.desc || 'NA',
                            e.serie || 'NA', e.estado || 'NA', e.dano ? 'SÍ' : 'NO', e.codigo || 'NA'
                        ]);

                        doc.autoTable({
                            startY: finalY + 5,
                            body: [['ACTIVOS ENTREGADOS']],
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 10, fontStyle: 'bold', lineColor: '#1879ae', lineWidth: 0.1 },
                            bodyStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', halign: 'center', cellPadding: 2 }
                        });
                        finalY = doc.autoTable.previous.finalY;

                        doc.autoTable({
                            startY: finalY,
                            head: [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'DAÑOS', 'CÓDIGO DE ACTIVO']],
                            body: entregadosBody,
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                            headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                        });
                        finalY = doc.autoTable.previous.finalY;
                    }

                    // Tabla de activos que mantiene
                    if (data.activosMantiene && data.activosMantiene.length > 0) {
                        const mantienesBody = data.activosMantiene.map(e => [
                            e.tipo || 'NA', e.mtm || 'NA', e.marca || 'NA', e.desc || 'NA',
                            e.serie || 'NA', e.estado || 'NA', e.dano ? 'SÍ' : 'NO', e.codigo || 'NA'
                        ]);

                        doc.autoTable({
                            startY: finalY + 5,
                            body: [['ACTIVOS QUE MANTIENE EL USUARIO']],
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 10, fontStyle: 'bold', lineColor: '#1879ae', lineWidth: 0.1 },
                            bodyStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', halign: 'center', cellPadding: 2 }
                        });
                        finalY = doc.autoTable.previous.finalY;

                        doc.autoTable({
                            startY: finalY,
                            head: [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'DAÑOS', 'CÓDIGO DE ACTIVO']],
                            body: mantienesBody,
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                            headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                        });
                        finalY = doc.autoTable.previous.finalY;
                    }
                }
                // Lógica especial para retiros específicos
                else if (tipoActaUpper.includes('RETIRO') && data.tipoRetiro === 'especificos') {
                    const equiposRetirados = data.activosParaRetiro || [];
                    const equiposQueMantiene = data.equipos.filter(eq => !equiposRetirados.some(ar => ar.id === eq.id));

                    // Tabla de equipos retirados
                    if (equiposRetirados.length > 0) {
                        const retiradosBody = equiposRetirados.map(e => [
                            e.tipo || 'NA', e.mtm || 'NA', e.marca || 'NA', e.desc || 'NA',
                            e.serie || 'NA', e.estado || 'NA', e.dano ? 'SÍ' : 'NO', e.codigo || 'NA'
                        ]);

                        doc.autoTable({
                            startY: finalY + 5,
                            body: [['ACTIVOS RETIRADOS']],
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 10, fontStyle: 'bold', lineColor: '#1879ae', lineWidth: 0.1 },
                            bodyStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', halign: 'center', cellPadding: 2 }
                        });
                        finalY = doc.autoTable.previous.finalY;

                        doc.autoTable({
                            startY: finalY,
                            head: [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'DAÑOS', 'CÓDIGO DE ACTIVO']],
                            body: retiradosBody,
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                            headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                        });
                        finalY = doc.autoTable.previous.finalY;
                    }

                    // Tabla de equipos que mantiene
                    if (equiposQueMantiene.length > 0) {
                        const mantienesBody = equiposQueMantiene.map(e => [
                            e.tipo || 'NA', e.mtm || 'NA', e.marca || 'NA', e.desc || 'NA',
                            e.serie || 'NA', e.estado || 'NA', e.dano ? 'SÍ' : 'NO', e.codigo || 'NA'
                        ]);

                        doc.autoTable({
                            startY: finalY + 5,
                            body: [['ACTIVOS QUE MANTIENE EL USUARIO']],
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 10, fontStyle: 'bold', lineColor: '#1879ae', lineWidth: 0.1 },
                            bodyStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', halign: 'center', cellPadding: 2 }
                        });
                        finalY = doc.autoTable.previous.finalY;

                        doc.autoTable({
                            startY: finalY,
                            head: [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'DAÑOS', 'CÓDIGO DE ACTIVO']],
                            body: mantienesBody,
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                            headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                        });
                        finalY = doc.autoTable.previous.finalY;
                    }
                } else {
                    // Lógica original para otros tipos de acta
                    const equiposPresentes = data.equipos.filter(e => !e.faltante);
                    const paquetes = equiposPresentes.filter(e => ['PC', 'LAPTOP'].includes((e.tipo || '').toUpperCase()));
                    const equiposSinPaquete = equiposPresentes.filter(e => !e.idPaquete && !['PC', 'LAPTOP'].includes((e.tipo || '').toUpperCase()));
                    const tableHead = [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'DAÑOS', 'CÓDIGO DE ACTIVO']];

                    const paqueteHeaderStyles = {
                        font: 'helvetica',
                        fontSize: 8,
                        fontStyle: 'bold',
                        lineColor: '#c7d2fe',
                        lineWidth: 0.1,
                    };
                    const paqueteBodyStyles = {
                        fillColor: '#e0e7ff',
                        textColor: '#312e81',
                        halign: 'left',
                        cellPadding: 2,
                    };

                    paquetes.forEach(paquete => {
                        doc.autoTable({
                            startY: finalY + 5,
                            body: [[`PAQUETE ${paquete.serie}`]],
                            theme: 'grid',
                            styles: paqueteHeaderStyles,
                            bodyStyles: paqueteBodyStyles,
                        });
                        finalY = doc.autoTable.previous.finalY;

                        const paqueteBody = [];
                        paqueteBody.push([paquete.tipo || 'NA', paquete.mtm || 'NA', paquete.marca || 'NA', paquete.desc || 'NA', paquete.serie || 'NA', paquete.estado || 'NA', paquete.dano ? 'SÍ' : 'NO', paquete.codigo || 'NA']);

                        const perifericosAsignados = equiposPresentes.filter(p => p.idPaquete === paquete.serie);
                        perifericosAsignados.forEach(p => {
                            paqueteBody.push([p.tipo || 'NA', p.mtm || 'NA', p.marca || 'NA', p.desc || 'NA', p.serie || 'NA', p.estado || 'NA', p.dano ? 'SÍ' : 'NO', p.codigo || 'NA']);
                        });

                        doc.autoTable({
                            startY: finalY,
                            head: tableHead,
                            body: paqueteBody,
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                            headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                        });
                        finalY = doc.autoTable.previous.finalY;
                    });

                    if (equiposSinPaquete.length > 0) {
                        doc.autoTable({
                            startY: finalY + 5,
                            body: [['ACTIVOS SIN ASIGNAR']],
                            theme: 'grid',
                            styles: paqueteHeaderStyles,
                            bodyStyles: paqueteBodyStyles,
                        });
                        finalY = doc.autoTable.previous.finalY;

                        const sinPaqueteBody = equiposSinPaquete.map(p => [p.tipo || 'NA', p.mtm || 'NA', p.marca || 'NA', p.desc || 'NA', p.serie || 'NA', p.estado || 'NA', p.dano ? 'SÍ' : 'NO', p.codigo || 'NA']);

                        doc.autoTable({
                            startY: finalY,
                            head: tableHead,
                            body: sinPaqueteBody,
                            theme: 'grid',
                            styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                            headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                        });
                        finalY = doc.autoTable.previous.finalY;
                    }
                }

                const equiposFaltantes = data.equipos.filter(e => e.faltante);
                if (equiposFaltantes.length > 0) {
                    const bodyFaltantes = [];
                    bodyFaltantes.push([{ content: 'EQUIPOS FALTANTES', colSpan: 6, styles: headerStyle }]);
                    bodyFaltantes.push([{ content: 'TIPO', styles: labelStyle }, { content: 'MTM/SKU', styles: labelStyle }, { content: 'MARCA', styles: labelStyle }, { content: 'DESCRIPCIÓN', styles: labelStyle }, { content: 'SERIE', styles: labelStyle }, { content: 'CÓDIGO DE ACTIVO', styles: labelStyle }]);
                    equiposFaltantes.forEach(e => {
                        bodyFaltantes.push([e.tipo || 'NA', e.mtm || 'NA', e.marca || 'NA', e.desc || 'NA', e.serie || 'NA', e.codigo || 'NA']);
                    });
                    doc.autoTable({ startY: finalY + 5, body: bodyFaltantes, theme: 'grid', styles: { font: 'helvetica', fontSize: 7, cellPadding: 1.5, lineColor: '#1879ae', lineWidth: 0.1 } });
                    finalY = doc.autoTable.previous.finalY;
                }

                // --- INICIO: CAMBIO DE ESTILO DEL TÍTULO DE FOTOGRAFÍAS ---
                if (data.fotos && data.fotos.length > 0) {
                    if (finalY + 40 > pageHeight) {
                        doc.addPage();
                        finalY = 20;
                    }

                    doc.autoTable({
                        startY: finalY + 5,
                        body: [['FOTOGRAFÍAS']],
                        theme: 'grid',
                        styles: {
                            font: 'helvetica',
                            fontSize: 10,
                            fontStyle: 'bold',
                            lineColor: '#1879ae',
                            lineWidth: 0.1,
                        },
                        bodyStyles: {
                            fillColor: '#1879ae',
                            textColor: '#FFFFFF',
                            halign: 'center',
                            cellPadding: 2,
                        }
                    });
                    finalY = doc.autoTable.previous.finalY + 2;
                    // --- FIN: CAMBIO DE ESTILO ---

                    const photoDataUrls = data.fotos;
                    const photoWidth = 42, photoHeight = 31.5, xMargin = 15, yMargin = 5, xGap = 4;
                    let xPos = xMargin;
                    for (let i = 0; i < photoDataUrls.length; i++) {
                        if (i > 0 && i % 4 === 0) { xPos = xMargin; finalY += photoHeight + yMargin; }
                        if (finalY + photoHeight > pageHeight - margin) { doc.addPage(); finalY = 20; xPos = xMargin; }
                        doc.addImage(photoDataUrls[i], 'JPEG', xPos, finalY, photoWidth, photoHeight);
                        xPos += photoWidth + xGap;
                    }
                    if (photoDataUrls.length > 0) { finalY += photoHeight + yMargin; }
                }

                updateModalProgress(65, 'Generando imagen de cláusulas...');
                const clausulasElement = document.createElement('div');
                clausulasElement.style.width = '180mm';
                clausulasElement.style.padding = '10px';
                clausulasElement.innerHTML = `<div class="legal-text" style="font-family: Arial, sans-serif;">${legalTextHTML}</div>`;
                document.body.appendChild(clausulasElement);

                const canvas = await html2canvas(clausulasElement, { scale: 3 });
                document.body.removeChild(clausulasElement);
                const clausulasImgData = canvas.toDataURL('image/png');
                updateModalProgress(75, 'Añadiendo cláusulas al PDF...');

                const clausulaImgWidth = pageWidth - (margin * 2);
                const clausulaImgHeight = canvas.height * clausulaImgWidth / canvas.width;
                const signatureBlockHeight = 60;

                if (finalY + clausulaImgHeight + signatureBlockHeight > pageHeight) {
                    doc.addPage();
                    finalY = 20;
                } else {
                    finalY += 10;
                }

                doc.addImage(clausulasImgData, 'PNG', margin, finalY, clausulaImgWidth, clausulaImgHeight);

                let signatureY = finalY + clausulaImgHeight + 25;

                const esRetiroDevolucion = tipoActaUpper.includes('RETIRO') || tipoActaUpper.includes('DEVOLUCION');
                let firmaIzquierda = {}, firmaDerecha = {};

                if (esRetiroDevolucion) {
                    firmaIzquierda = { titulo: 'RECIBE', nombre: tecnicoSeleccionado.nombre, cedula: tecnicoSeleccionado.cedula };
                    firmaDerecha = { titulo: 'ENTREGA', nombre: data.nombre, cedula: data.cedula };
                    if (data.firmar_jefatura) { firmaDerecha.nombre = data.jefatura_nombre; firmaDerecha.cedula = data.jefatura_cedula; }
                } else {
                    firmaIzquierda = { titulo: 'RECIBE', nombre: data.nombre, cedula: data.cedula };
                    firmaDerecha = { titulo: 'ENTREGA', nombre: tecnicoSeleccionado.nombre, cedula: tecnicoSeleccionado.cedula };
                    if (data.firmar_jefatura) { firmaIzquierda.nombre = data.jefatura_nombre; firmaIzquierda.cedula = data.jefatura_cedula; }
                }

                doc.setDrawColor('#000000'); doc.setLineWidth(0.3);
                doc.line(30, signatureY, 90, signatureY);
                doc.setFontSize(9); doc.setFont('helvetica', 'bold');
                doc.text(firmaIzquierda.titulo, 60, signatureY + 7, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text(firmaIzquierda.nombre || 'NA', 60, signatureY + 12, { align: 'center' });
                doc.text(`CI: ${firmaIzquierda.cedula || 'NA'}`, 60, signatureY + 17, { align: 'center' });

                doc.line(120, signatureY, 180, signatureY);
                doc.setFont('helvetica', 'bold');
                doc.text(firmaDerecha.titulo, 150, signatureY + 7, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text(firmaDerecha.nombre || 'NA', 150, signatureY + 12, { align: 'center' });
                doc.text(`CI: ${firmaDerecha.cedula || 'NA'}`, 150, signatureY + 17, { align: 'center' });
            }

            const imageToBase64 = (url) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const dataURL = canvas.toDataURL(url.endsWith('.png') ? 'image/png' : 'image/jpeg');
                        resolve(dataURL);
                    };
                    img.onerror = (err) => {
                        console.error(`No se pudo cargar la imagen del encabezado: ${url}`, err);
                        resolve(null);
                    };
                    img.src = url;
                });
            };

            document.getElementById('generate-pdf').addEventListener('click', () => {
                const getFilenameData = (dataForPdf) => {
                    let siglas = '';
                    const tipoActaUpper = dataForPdf.tipo_acta.toUpperCase();
                    let folderName = 'actas_otros';

                    if (tipoActaUpper.includes('RETIRO')) {
                        siglas = 'RET'; folderName = 'actas_retiro';
                    } else if (tipoActaUpper.includes('ENTREGA')) {
                        siglas = 'ASIG'; folderName = 'actas_entrega';
                    } else if (tipoActaUpper.includes('DEVOLUCION')) {
                        siglas = 'DEV'; folderName = 'actas_devolucion';
                    } else if (tipoActaUpper.includes('REGULARIZACION')) {
                        siglas = 'REG'; folderName = 'actas_regularizacion';
                    }

                    const nombreUsuario = (dataForPdf.nombre || 'SIN_USUARIO').replace(/\s+/g, '_').toUpperCase();
                    const equiposParaPdf = dataForPdf.tipoEntrega === 'activos' ? dataForPdf.equiposEntregados : dataForPdf.equipos;
                    const pc = equiposParaPdf.find(e => e.tipo === 'PC' || e.tipo === 'LAPTOP');
                    const seriePC = pc ? pc.serie : 'SIN_SERIE_PC';
                    const fecha = new Date(dataForPdf.fecha + 'T00:00:00');
                    const fechaStr = fecha.getDate().toString().padStart(2, '0') +
                        (fecha.getMonth() + 1).toString().padStart(2, '0') +
                        fecha.getFullYear();

                    const filename = `ACT - ${siglas} - ${nombreUsuario} - ${seriePC} - ${fechaStr}.pdf`;
                    return { filename, folderName };
                };

                generatePdfWithAutoTable(getFilenameData, pageContent, 'Generando Acta PDF...');
            });

            function initializeForm() {
                populateSelect(document.getElementById('eq_tipo'), tipoOptions);
                populateSelect(document.getElementById('eq_marca'), marcaOptions);
                populateSelect(document.getElementById('eq_desc'), descOptions);
                populateSelect(document.getElementById('eq_estado'), estadoOptions);
                populateSelect(document.getElementById('ubicacion'), ubicacionOptions);
                populateSelect(document.getElementById('empresa'), empresaOptions);
                populateSelect(document.getElementById('tecnico_responsable'), tecnicos, 'cedula', 'display');

                populateSelect(correoDominioSelect, domainOptions.filter(d => d !== 'otro'));
                const otroOpt = document.createElement('option');
                otroOpt.value = 'otro';
                otroOpt.textContent = 'Otro...';
                correoDominioSelect.appendChild(otroOpt);

                populateSelect(document.getElementById('change-eq_tipo'), tipoOptions);
                populateSelect(document.getElementById('change-eq_marca'), marcaOptions);
                populateSelect(document.getElementById('change-eq_desc'), descOptions);
                populateSelect(document.getElementById('change-eq_estado'), estadoOptions);
                populateSelect(document.getElementById('change-tecnico_responsable'), tecnicos, 'cedula', 'display');
                //populateSelect(document.getElementById('devolucion-tecnico-select'), tecnicos, 'cedula', 'nombre');


                document.getElementById('nav-form-btn').addEventListener('click', () => switchView('main-view'));
                document.getElementById('nav-change-btn').addEventListener('click', () => switchView('change-view'));
                document.getElementById('nav-saved-actas-btn').addEventListener('click', () => switchView('saved-actas-view'));
                document.getElementById('nav-finalized-actas-btn').addEventListener('click', () => switchView('finalized-actas-view'));
                document.getElementById('nav-dashboard-btn').addEventListener('click', () => switchView('dashboard-view'));
                document.getElementById('nav-retirados-btn').addEventListener('click', () => switchView('retirados-view'));
                document.getElementById('nav-devolucion-btn').addEventListener('click', () => switchView('devolucion-view'));
                document.getElementById('export-dashboard-btn').addEventListener('click', () => exportDashboardToExcel('main'));
                

                document.getElementById('cancel-user-selection-btn').addEventListener('click', hideUserSelectionModal);
                //----------------------------
/*
                document.getElementById('ad-search-btn').addEventListener('click', () => {
                    const searchTerm = document.getElementById('ad-search-input').value.trim();
                    if (!searchTerm) {
                        showModal('Atención', 'Por favor, ingrese un nombre de usuario o cédula para buscar.');
                        return;
                    }
                    // Si hay un término de búsqueda, muestra el panel de credenciales
                    document.getElementById('ad-credentials-panel').classList.remove('hidden');
                    document.getElementById('ad-username').focus();
                });
*/
//##################################################################
/*
                adSearchBtn.addEventListener('click', async () => {
                    const searchTerm = adSearchInput.value.trim();
                    if (!searchTerm) {
                        showErrorModal('Atención', 'Por favor, ingrese un término de búsqueda.');
                        return;
                    }
                    if (activosData.length === 0) {
                        showErrorModal('Atención', 'Por favor, cargue primero el archivo de Excel para poder buscar los activos del usuario.');
                        return;
                    }
                    showLoadingModal('Buscando en Directorio Activo', 'Por favor, espere...');

                    //showLoader();

                    adSearchText.textContent = 'Buscando...';
                    adSearchSpinner.classList.remove('hidden');
                    adSearchBtn.disabled = true;

                    try {
                        const result = await window.api.searchAdReal({ searchTerm });

                        if (result.success && result.user) {
                            // 1. ÉXITO EN AD: Ahora procesamos todo aquí dentro.
                            const userData = result.user;
                            populateFormWithUserData(userData, true); // Usamos tu función para llenar los campos

                            // 2. BUSCAMOS LOS ACTIVOS (esta lógica estaba en otra parte, ahora la unificamos aquí)
                            const cedulaAD = normalizeCedula(userData.description);
                            let todosLosActivosDelUsuario = [];
                            if (cedulaAD) {
                                todosLosActivosDelUsuario = activosData.filter(asset =>
                                    normalizeCedula(getSafeProp(asset, 'Cédulas') || getSafeProp(asset, 'ok cedula')) === cedulaAD
                                );
                            }
                            
                            // Re-calculamos la lista de equipos basado en los activos encontrados
                            equipos = extractEquiposFromAssets(todosLosActivosDelUsuario);
                            renderEquiposList();
                            updatePreview();

                            // 3. MOSTRAMOS LA NOTIFICACIÓN BONITA UNIFICADA
                            showSuccessModal(
                                '¡Datos Cargados Exitosamente!',
                                userData.cn || 'N/A',
                                'Active Directory (AD)',
                                equipos.length // Pasamos el número de activos encontrados
                            );

                        } else if (result.reason === 'NEEDS_CREDENTIALS') {
                            // Si necesita credenciales, muestra la ventana emergente
                            //showModal('Autenticación Requerida', result.message || 'Por favor, ingrese sus credenciales de red.');
                            adCredentialsPanel.classList.remove('hidden');
                            adUsernameInput.focus();
                        } else {
                            // Otro tipo de error
                            showErrorModal('Error de Búsqueda', result.message || 'No se pudo encontrar al usuario.');
                        }
                    } catch (error) {
                        console.error('Error en búsqueda AD:', error);
                        showErrorModal('Error', 'Error al conectar con el Directorio Activo: ' + error.message);
                    } finally {
                        hideLoader();
                        adSearchText.textContent = 'Buscar en AD';
                        adSearchSpinner.classList.add('hidden');
                        adSearchBtn.disabled = false;
                    }
                });
*/
//################################################################################
                // ✅ USA SOLAMENTE ESTA VERSIÓN PARA EL BOTÓN DE BÚSQUEDA EN AD
            adSearchBtn.addEventListener('click', async () => {
                const searchTerm = adSearchInput.value.trim();
                if (!searchTerm) {
                    showErrorModal('Atención', 'Por favor, ingrese un término de búsqueda.');
                    return;
                }
                if (activosData.length === 0) {
                    showErrorModal('Atención', 'Por favor, cargue primero el archivo de Excel.');
                    return;
                }
                
                // Esta función simplemente llama a la función reutilizable que creamos antes.
                await performAdSearch(searchTerm);
            });
//################################################################################
                adSearchBtn.addEventListener('click', async () => {
                const searchTerm = adSearchInput.value.trim();
                if (!searchTerm) {
                    showErrorModal('Atención', 'Por favor, ingrese un término de búsqueda.');
                    return;
                }
                if (activosData.length === 0) {
                    showErrorModal('Atención', 'Por favor, cargue primero el archivo de Excel.');
                    return;
                }

                showLoadingModal('Contactando Directorio Activo', 'Por favor, espere...');

                try {
                const result = await window.api.searchAdReal({ searchTerm });

                if (result.success) {
                    // Éxito, el usuario fue encontrado
                    hideLoadingModal();
                    populateFormWithUserData(result.user, true);
                    showDetailedSuccessModal('¡Datos Cargados!', result.user.cn, 'Active Directory (AD)', equipos.length);

                } else if (result.reason === 'INVALID_CREDENTIALS') {
                    // ¡NUEVO! Se activa cuando las credenciales son incorrectas
                    hideLoadingModal();
                    credencialesIncorrectas(); // <-- ¡Llamamos a tu alerta bonita!
                    adCredentialsPanel.classList.remove('hidden'); // Mostramos el panel de nuevo
                    adPasswordInput.value = ''; // Limpiamos la contraseña para que la vuelva a escribir
                    adPasswordInput.focus();

                } else if (result.reason === 'NEEDS_CREDENTIALS') {
                    // Se activa la primera vez, cuando no hay credenciales
                    hideLoadingModal();
                    adCredentialsPanel.classList.remove('hidden');
                    adUsernameInput.focus();
                    
                } else {
                    // Cualquier otro error
                    hideLoadingModal();
                    showErrorModal('Error de Búsqueda', result.message);
                }
            } catch (error) {
                hideLoadingModal();
                showErrorModal('Error Crítico', 'Error en la comunicación: ' + error.message);
            }
            });
                //##################################################################
                /*
                // CÓDIGO MEJORADO: Implementa la búsqueda automática primero
                document.getElementById('ad-search-btn').addEventListener('click', async () => {
                    const adSearchInput = document.getElementById('ad-search-input');
                    const adSearchSpinner = document.getElementById('ad-search-spinner');
                    const adSearchText = document.getElementById('ad-search-text');

                    const searchTerm = adSearchInput.value.trim();
                    if (!searchTerm) {
                        showModal('Atención', 'Por favor, ingrese un nombre de usuario o cédula para buscar.');
                        return;
                    }
                    if (activosData.length === 0) {
                        showModal('Atención', 'Por favor, cargue primero el archivo de Excel para poder buscar los activos del usuario.');
                        return;
                    }

                    // Mostrar spinner e iniciar búsqueda automática
                    adSearchText.textContent = 'Buscando automáticamente...';
                    adSearchSpinner.classList.remove('hidden');

                    try {
                        const result = await window.api.searchAd(searchTerm);

                        if (result.success) {
                            // ¡ÉXITO AUTOMÁTICO!
                            populateFormWithUserData(result.user);
                            showModal('Éxito', `Usuario '${result.user.cn}' encontrado automáticamente.`);
                        } else if (result.reason === 'NEEDS_CREDENTIALS') {
                            // FALLO AUTOMÁTICO: Pedir credenciales
                            showModal('Información', 'No se pudo conectar automáticamente. Por favor, ingrese sus credenciales de red.');
                            document.getElementById('ad-credentials-panel').classList.remove('hidden');
                            document.getElementById('ad-username').focus();
                        } else {
                            // Otro tipo de error
                            showModal('Error', result.message || 'Ocurrió un error desconocido durante la búsqueda.');
                        }

                    } catch (error) {
                        showModal('Error', 'Error de comunicación con el backend: ' + error.message);
                    } finally {
                        // Ocultar spinner
                        adSearchText.textContent = 'Buscar en AD';
                        adSearchSpinner.classList.add('hidden');
                    }
                });

*/
                eqForm.btn.addEventListener('click', handleAddOrUpdate);
                eqForm.tipo.addEventListener('change', function () {
                    if (this.value === 'OTRO') {
                        eqForm.tipo_manual.classList.remove('hidden');
                    } else {
                        eqForm.tipo_manual.classList.add('hidden');
                        eqForm.tipo_manual.value = '';
                    }
                    if (this.value === 'OTRO') {
                        eqForm.marca_manual.classList.remove('hidden');
                    } else {
                        eqForm.marca_manual.classList.add('hidden');
                        eqForm.marca_manual.value = '';
                    }
                });

                // Para la DESCRIPCIÓN del formulario principal  
                eqForm.desc.addEventListener('change', function () {
                    if (this.value === 'OTRO') {
                        eqForm.desc_manual.classList.remove('hidden');
                    } else {
                        eqForm.desc_manual.classList.add('hidden');
                        eqForm.desc_manual.value = '';
                    }
                });

                // Para el TIPO del formulario de CAMBIOS
                changeEqForm.tipo.addEventListener('change', function () {
                    if (this.value === 'OTRO') {
                        changeEqForm.tipo_manual.classList.remove('hidden');
                    } else {
                        changeEqForm.tipo_manual.classList.add('hidden');
                        changeEqForm.tipo_manual.value = '';
                    }
                });
                eqForm.tipo_manual.classList.add('hidden');
                eqForm.marca_manual.classList.add('hidden');
                eqForm.desc_manual.classList.add('hidden');
                changeEqForm.tipo_manual.classList.add('hidden');
                form.addEventListener('input', updatePreview);

                changeEqForm.tipo.addEventListener('change', updateChangeCodigoActivo);
                changeEqForm.serie.addEventListener('input', updateChangeCodigoActivo);

                firmarJefaturaCheck.addEventListener('change', () => {
                    jefaturaFirmaContainer.classList.toggle('hidden', !firmarJefaturaCheck.checked);
                    updatePreview();
                });

                preguardarBtn.addEventListener('click', handlePreguardar);
                document.getElementById('add-to-dashboard-btn').addEventListener('click', addActaToDashboard);
                document.getElementById('fecha').valueAsDate = new Date();

                correoDominioSelect.addEventListener('change', () => {
                    const isOtro = correoDominioSelect.value === 'otro';
                    correoDominioManual.classList.toggle('hidden', !isOtro);
                    correoDominioSelect.classList.toggle('rounded-r-md', isOtro);
                    updatePreview();
                });
                correoDominioManual.addEventListener('input', updatePreview);

                salidaPersonalCheck.addEventListener('change', (e) => {
                    const salidaText = "SALIDA DE PERSONAL\n";
                    const currentObs = observacionesTextarea.value;

                    if (e.target.checked) {
                        if (!currentObs.startsWith(salidaText)) {
                            observacionesTextarea.value = salidaText + currentObs;
                        }
                    } else {
                        if (currentObs.startsWith(salidaText)) {
                            observacionesTextarea.value = currentObs.substring(salidaText.length);
                        }
                    }
                    updatePreview();
                });

                draftsSearchInput.addEventListener('input', (e) => {
                    renderSavedActasList(e.target.value);
                });

                document.getElementById('saved-actas-search-input').addEventListener('input', (e) => {
                    renderSavedActasDashboard(e.target.value);
                });

                document.getElementById('saved-actas-table').addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-saved-draft-btn');
                    const deleteBtn = e.target.closest('.delete-saved-draft-btn');

                    if (editBtn) {
                        const acta_n = editBtn.dataset.id;
                        const success = await loadDraft(acta_n);
                        if (success && !document.getElementById('change-view').classList.contains('active')) {
                            switchView('main-view');
                        }
                    }

                    if (deleteBtn) {
                        const draftId = deleteBtn.dataset.id;
                        showModal('Confirmar Eliminación', `¿Seguro que quieres eliminar el borrador ${draftId}?`, [
                            { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                            {
                                text: 'Eliminar', class: 'bg-red-600 hover:bg-red-700', action: async () => {
                                    await window.api.deleteDraft(draftId);
                                    hideModal();
                                    renderSavedActasDashboard();
                                }
                            }
                        ]);
                    }
                });

                document.getElementById('finalized-actas-search-input').addEventListener('input', (e) => {
                    renderFinalizedActasDashboard(e.target.value);
                });

                document.getElementById('finalized-actas-table').addEventListener('click', async (e) => {
                    const viewBtn = e.target.closest('.view-pdf-btn');
                    const editBtn = e.target.closest('.edit-finalized-btn');

                    if (editBtn) {
                        const acta_n = editBtn.dataset.id;
                        
                        // 1. Llamamos a nuestra función mejorada UNA SOLA VEZ
                        const result = await loadDraft(acta_n);

                        // 2. Si la carga fue exitosa (result no es null)
                        if (result) {
                            // 3. Mostramos una notificación moderna y rápida
                            showSuccessToast(`Acta '${acta_n}' cargada para edición.`);
                            showDetailedSuccessModal(
                                '¡Acta Cargada!' ,
                                result.acta.nombre,
                                'Historial de Actas',
                                result.equipos.length
                            );
                            // 4. Te llevamos a la vista del formulario principal
                            switchView('main-view');
                        }
                    }
/*
                    if (editBtn) {
                        const acta_n = editBtn.dataset.id;
                        try {
                            const result = await window.api.loadFinalizedActa(acta_n);
                            if (result && result.success) {
                                const success = await loadDraft(result.acta);
                                if (success && !document.getElementById('change-view').classList.contains('active')) {
                                    switchView('main-view');
                                }
                            } else {
                                showModal('Error', 'No se pudo cargar el acta finalizada: ' + (result ? result.message : 'Respuesta inválida'));
                            }
                        } catch (error) {
                            showModal('Error', 'Error al cargar el acta: ' + error.message);
                        }
                    }
*/
                    if (editBtn) {
                        const acta_n = editBtn.dataset.id;
                        // CORRECCIÓN: Llamamos directamente a la función local loadDraft, que ya sabe cómo
                        // comunicarse con el backend y llenar el formulario.
                        const success = await loadDraft(acta_n);

                        if (success) {
                            // Una vez que los datos se cargaron correctamente, simplemente
                            // te llevamos a la vista del formulario principal.
                            showModal('Éxito', `Acta '${acta_n}' cargada para edición.`);
                            
                            // Verificamos si es un acta de cambio para ir a la vista correcta
                            const result = await window.api.loadDraft(acta_n);
                            if (result.success && result.acta.type === 'change') {
                                switchView('change-view');
                            } else {
                                switchView('main-view');
                            }
                        }
                        // La función loadDraft ya maneja sus propios errores, así que no necesitamos un try-catch aquí.
                    }
                    /////                  
                });

                document.getElementById('tipo_acta').addEventListener('change', () => {
                    toggleRetiroPanel();
                    toggleEntregaPanel();
                    updatePreview();
                });

                // Event listeners para selectores manuales
                const manualFields = [
                    { select: eqForm.tipo, manual: eqForm.tipo_manual },
                    { select: eqForm.marca, manual: eqForm.marca_manual },
                    { select: eqForm.desc, manual: eqForm.desc_manual },
                    { select: document.getElementById('change-eq_tipo'), manual: document.getElementById('change-eq_tipo_manual') }
                ];

                manualFields.forEach(({ select, manual }) => {
                    if (select && manual) {
                        select.addEventListener('change', () => {
                            if (select.value === 'OTRO') {
                                manual.classList.remove('hidden');
                                manual.focus();
                            } else {
                                manual.classList.add('hidden');
                                manual.value = '';
                            }
                        });
                    }
                });

                // Devolución event listeners
                //document.getElementById('devolucion-search-btn').addEventListener('click', searchDevolucion);
                /*
                document.getElementById('devolucion-search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchDevolucion();
                    }
                });
                */



               // document.getElementById('devolucion-manual-btn').addEventListener('click', loadManualDevolucionData);
/*
                document.getElementById('generate-devolucion-pdf').addEventListener('click', async () => {
                    if (!currentDevolucionData) {
                        showModal('Atención', 'Por favor, busque un colaborador primero.');
                        return;
                    }

                    showModal('Generando PDF de Devolución...', '', [], 'progress');
                    await new Promise(res => setTimeout(res, 100));

                    try {
                        updateModalProgress(25, 'Preparando documento...');
                        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        const logoRightBase64 = await imageToBase64('consenso.png');

                        updateModalProgress(50, 'Generando contenido...');
                        await generateDevolucionPdfContent(doc, currentDevolucionData, logoRightBase64);

                        updateModalProgress(75, 'Guardando archivo...');
                        const nombreUsuario = (currentDevolucionData.Colaborador || 'SIN_USUARIO').replace(/\s+/g, '_').toUpperCase();
                        const hoy = new Date();
                        const fechaStr = hoy.getDate().toString().padStart(2, '0') +
                            (hoy.getMonth() + 1).toString().padStart(2, '0') +
                            hoy.getFullYear();
                        const filename = `ACT - DEV - ${nombreUsuario} - ${fechaStr}.pdf`;

                        const result = await window.api.savePdf({
                            pdfData: doc.output('arraybuffer'),
                            folderName: 'actas_devolucion',
                            filename: filename
                        });

                        updateModalProgress(100, '¡Completado!');
                        setTimeout(() => {
                            hideModal();
                            if (result.success) {
                                showModal('Éxito', `PDF de devolución guardado correctamente en:<br>${result.path}`);
                            } else {
                                showModal('Error', `No se pudo guardar el PDF: ${result.message}`);
                            }
                        }, 500);

                    } catch (error) {
                        hideModal();
                        console.error('Error al generar PDF de devolución:', error);
                        showModal('Error', `Ocurrió un error al generar el PDF: ${error.message}`);
                    }
                });
*/
//***********************************************************************************************************
                // ✅✅ INICIO DEL BLOQUE CORREGIDO QUE DEBES PEGAR ✅✅
                document.getElementById('generate-devolucion-pdf').addEventListener('click', async () => {
                    // Validar que haya datos del colaborador
                    if (!currentDevolucionData.colaborador || !currentDevolucionData.colaborador.nombre) {
                        showModal('Atención', 'Por favor, cargue los datos de un colaborador primero.');
                        return;
                    }

                    showModal('Generando PDF de Devolución...', '', [], 'progress');
                    await new Promise(res => setTimeout(res, 100));

                    try {
                        updateModalProgress(25, 'Preparando documento...');
                        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        
                        // La función generateDevolucionPreview ya actualizó `currentDevolucionData`
                        // y generó el HTML. Ahora lo usamos para crear el PDF.
                        updateModalProgress(50, 'Convirtiendo vista previa a PDF...');
                        const content = document.getElementById('devolucion-content-wrapper');
                        await html2canvas(content, { scale: 2 }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            const pdfWidth = doc.internal.pageSize.getWidth();
                            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        });

                        updateModalProgress(75, 'Guardando archivo...');
                        const nombreUsuario = (currentDevolucionData.colaborador.nombre || 'SIN_USUARIO').replace(/\s+/g, '_').toUpperCase();
                        const hoy = new Date();
                        const fechaStr = hoy.getDate().toString().padStart(2, '0') +
                            (hoy.getMonth() + 1).toString().padStart(2, '0') +
                            hoy.getFullYear();
                        const filename = `ACTA_DEVOLUCION - ${nombreUsuario} - ${fechaStr}.pdf`;

                        const result = await window.api.savePdf({
                            pdfData: doc.output('arraybuffer'),
                            folderName: 'actas_devolucion', // Guarda en una carpeta específica
                            filename: filename
                        });

                        updateModalProgress(100, '¡Completado!');
                        setTimeout(() => {
                            hideModal();
                            if (result.success) {
                                showModal('Éxito', `PDF de devolución guardado correctamente en:<br>${result.path}`);
                            } else {
                                showModal('Error', `No se pudo guardar el PDF: ${result.message}`);
                            }
                        }, 500);

                    } catch (error) {
                        hideModal();
                        console.error('Error al generar PDF de devolución:', error);
                        showModal('Error', `Ocurrió un error al generar el PDF: ${error.message}`);
                    }
                });
                // ✅✅ FIN DEL BLOQUE CORREGIDO ✅✅
//***********************************************************************************************************
                // Event listeners para cambios
                clearChangeBtn.addEventListener('click', () => {
                    showModal('Confirmar Limpieza', '¿Estás seguro de que quieres borrar todos los datos del formulario de cambio?', [
                        { text: 'Cancelar', class: 'bg-gray-500 hover:bg-gray-600', action: hideModal },
                        {
                            text: 'Sí, Limpiar', class: 'bg-red-600 hover:bg-red-700', action: () => {
                                hideModal();
                                clearChangeForm();
                            }
                        }
                    ]);
                });

                preguardarChangeBtn.addEventListener('click', async () => {
                    const changeData = await getChangeFormData();
                    if (!changeData.acta_n) {
                        showModal('Atención', 'Por favor, ingrese un N° ACTA para poder guardar el borrador.');
                        return;
                    }
                    const result = await window.api.saveDraft(changeData);
                    if (result.success) {
                        showModal('Éxito', `Borrador de cambio ${changeData.acta_n} guardado correctamente.`);
                    } else {
                        showModal('Error', `No se pudo guardar el borrador: ${result.message}`);
                    }
                });

                generateChangePdfBtn.addEventListener('click', () => {
                    const getChangeFilenameData = (dataForPdf) => {
                        const nombreUsuario = (dataForPdf.nombre || 'SIN_USUARIO').replace(/\s+/g, '_').toUpperCase();
                        const equipoNuevo = dataForPdf.equiposNuevosAgregados.length > 0 ? dataForPdf.equiposNuevosAgregados[0] : null;
                        const serieEquipoNuevo = equipoNuevo ? equipoNuevo.serie : 'SIN_SERIE';
                        const fecha = new Date(dataForPdf.fecha + 'T00:00:00');
                        const fechaStr = fecha.getDate().toString().padStart(2, '0') +
                            (fecha.getMonth() + 1).toString().padStart(2, '0') +
                            fecha.getFullYear();

                        const filename = `ACT - CAMBIO - ${nombreUsuario} - ${serieEquipoNuevo} - ${fechaStr}.pdf`;
                        return { filename, folderName: 'actas_cambio' };
                    };

                    generatePdfWithAutoTable(getChangeFilenameData, generateChangePdfContent, 'Generando PDF de Cambio...');
                });
                setupDevolucionView();
                renderSavedActasList();
                renderFinalizedActasDashboard();
                updatePreview();
            }
//----------------------------------------------------
            function clearChangeForm() {
                document.getElementById('change-acta_n').value = '';
                document.getElementById('change-fecha').valueAsDate = new Date();
                document.getElementById('change-tecnico_responsable').value = '';
                document.getElementById('change-ticket').value = '';
                document.getElementById('change-observaciones').value = '';
                changeExcelSearchInput.value = '';
                changeContractDataContainer.innerHTML = '<p class="text-center text-gray-500">Busque un colaborador para iniciar.</p>';
                change_assignedEquipos = [];
                change_addedEquipos = [];
                change_currentUserData = null;
                change_fotosEntregado = [];
                change_fotosRetirado = [];
                renderChangeAssignedTable();
                renderChangeAddedTable();
                updateChangePreview();
                updateChangeSummaryTables();
            }

            async function generateDevolucionPdfContent(doc, userData, logoRightBase64) {
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const logoHeight = 15;

                if (logoRightBase64) {
                    try {
                        const imgProps = doc.getImageProperties(logoRightBase64);
                        const imgWidth = (imgProps.width * logoHeight) / imgProps.height;
                        const x = pageWidth - imgWidth - margin;
                        doc.addImage(logoRightBase64, 'JPEG', x, 10, imgWidth, logoHeight);
                    } catch (e) { console.error("Error adding right logo:", e); }
                }

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor('#1879ae');

                const titleY = 10 + logoHeight + 8;
                doc.text('ACTA DE DEVOLUCIÓN DE EQUIPOS', pageWidth / 2, titleY, { align: 'center' });

                const startY = titleY + 10;
                doc.setDrawColor('#1879ae');
                doc.setLineWidth(0.5);
                doc.line(margin, startY - 7, pageWidth - margin, startY - 7);

                const labelStyle = { fillColor: '#F2F2F2', textColor: '#1879ae', fontStyle: 'bold' };
                const headerStyle = { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold', halign: 'center' };

                const today = new Date().toLocaleDateString('es-ES');

                doc.autoTable({
                    startY: startY,
                    body: [
                        [{ content: 'DATOS DEL COLABORADOR', colSpan: 8, styles: headerStyle }],
                        [{ content: 'Colaborador', styles: labelStyle }, { content: userData.Colaborador || 'N/A', colSpan: 3 }, { content: 'Fecha', styles: labelStyle }, { content: today, colSpan: 3 }],
                        [{ content: 'Cédula', styles: labelStyle }, { content: userData['Cédulas'] || 'N/A', colSpan: 3 }, { content: 'Usuario', styles: labelStyle }, { content: userData['Nombre de usuario'] || 'N/A', colSpan: 3 }],
                        [{ content: 'Hostname', styles: labelStyle }, { content: userData.Hostname || 'N/A', colSpan: 7 }]
                    ],
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 7, cellPadding: 1.5, lineColor: '#1879ae', lineWidth: 0.1 },
                });

                let finalY = doc.autoTable.previous.finalY;

                // Tabla de equipos a devolver
                const equiposBody = [];
                equiposBody.push([{ content: 'EQUIPOS A DEVOLVER', colSpan: 5, styles: headerStyle }]);
                equiposBody.push([
                    { content: 'TIPO', styles: labelStyle },
                    { content: 'SERIE', styles: labelStyle },
                    { content: 'DESCRIPCIÓN', styles: labelStyle },
                    { content: 'CÓDIGO DE ACTIVO', styles: labelStyle },
                    { content: 'ESTADO', styles: labelStyle }
                ]);

                // PC/Laptop principal
                equiposBody.push([
                    'PC/LAPTOP',
                    userData['SERIE PC'] || 'N/A',
                    userData['Modelo Consenso'] || 'N/A',
                    userData['Código de activo del equipo'] || 'N/A',
                    'USADO'
                ]);

                // Monitor si existe
                if (userData['SERIE MON']) {
                    equiposBody.push([
                        'MONITOR',
                        userData['SERIE MON'],
                        userData['Tipo Monitor'] || 'N/A',
                        userData['Código de activo del Monitor'] || 'N/A',
                        'USADO'
                    ]);
                }

                // Teclado si existe
                if (userData['Código de activo del teclado']) {
                    equiposBody.push([
                        'TECLADO',
                        'N/A',
                        'TECLADO ESTÁNDAR',
                        userData['Código de activo del teclado'],
                        'USADO'
                    ]);
                }

                // Mouse si existe
                if (userData['Código de activo del Mouse']) {
                    equiposBody.push([
                        'MOUSE',
                        'N/A',
                        'MOUSE ESTÁNDAR',
                        userData['Código de activo del Mouse'],
                        'USADO'
                    ]);
                }

                doc.autoTable({
                    startY: finalY + 5,
                    body: equiposBody,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 7, cellPadding: 1.5, lineColor: '#1879ae', lineWidth: 0.1 },
                });

                finalY = doc.autoTable.previous.finalY;

                // Texto de devolución
                const textoDevolucion = `
Por medio de la presente, el colaborador ${userData.Colaborador || 'N/A'} con cédula ${userData['Cédulas'] || 'N/A'} hace entrega de los equipos informáticos detallados anteriormente, los cuales estuvieron bajo su custodia durante su permanencia en la empresa.

Los equipos se entregan en las condiciones detalladas y cualquier daño o faltante ha sido debidamente documentado.
               `.trim();

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor('#000000');

                const textLines = doc.splitTextToSize(textoDevolucion, pageWidth - (margin * 2));
                doc.text(textLines, margin, finalY + 15);

                const textHeight = textLines.length * 4;
                let signatureY = finalY + 15 + textHeight + 30;

                // Firmas
                doc.setDrawColor('#000000');
                doc.setLineWidth(0.3);

                // Firma izquierda - ENTREGA
                doc.line(30, signatureY, 90, signatureY);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('ENTREGA', 60, signatureY + 7, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text(userData.Colaborador || 'N/A', 60, signatureY + 12, { align: 'center' });
                doc.text(`CI: ${userData['Cédulas'] || 'N/A'}`, 60, signatureY + 17, { align: 'center' });

                // Firma derecha - RECIBE
                doc.line(120, signatureY, 180, signatureY);
                doc.setFont('helvetica', 'bold');
                doc.text('RECIBE (TÉCNICO TI)', 150, signatureY + 7, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text('TÉCNICO RESPONSABLE', 150, signatureY + 12, { align: 'center' });
                doc.text('CI: ______________', 150, signatureY + 17, { align: 'center' });
            }

            async function generateChangePdfContent(doc, dataForPdf, logoRightBase64) {
                const data = dataForPdf;
                const formattedDate = data.fecha ? new Date(data.fecha + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                const tecnicoSeleccionado = tecnicos.find(t => t.cedula === data.tecnico_responsable) || { nombre: '', cedula: '' };

                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const logoHeight = 15;

                if (logoRightBase64) {
                    try {
                        const imgProps = doc.getImageProperties(logoRightBase64);
                        const imgWidth = (imgProps.width * logoHeight) / imgProps.height;
                        const x = pageWidth - imgWidth - margin;
                        doc.addImage(logoRightBase64, 'JPEG', x, 10, imgWidth, logoHeight);
                    } catch (e) { console.error("Error adding right logo:", e); }
                }

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor('#1879ae');

                const titleY = 10 + logoHeight + 8;
                doc.text('ACTA DE CAMBIO DE EQUIPOS', pageWidth / 2, titleY, { align: 'center' });

                const startY = titleY + 10;
                doc.setDrawColor('#1879ae');
                doc.setLineWidth(0.5);
                doc.line(margin, startY - 7, pageWidth - margin, startY - 7);

                const labelStyle = { fillColor: '#F2F2F2', textColor: '#1879ae', fontStyle: 'bold' };
                const headerStyle = { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold', halign: 'center' };

                doc.autoTable({
                    startY: startY,
                    body: [
                        [{ content: 'DATOS DEL CONTRATO', colSpan: 8, styles: headerStyle }],
                        [{ content: 'Nro. Acta:', styles: labelStyle }, data.acta_n || '', { content: 'Fecha:', styles: labelStyle }, formattedDate, { content: 'Generado por:', styles: labelStyle }, { content: tecnicoSeleccionado.nombre || 'NA', colSpan: 3 }],
                        [{ content: 'Usuario:', styles: labelStyle }, data.usuario || '', { content: 'Nombre:', styles: labelStyle }, { content: data.nombre || '', colSpan: 3 }, { content: 'Ciudad:', styles: labelStyle }, data.ciudad || ''],
                        [{ content: 'Empresa:', styles: labelStyle }, data.empresa || '', { content: 'C.I.:', styles: labelStyle }, { content: data.cedula || '', colSpan: 3 }, { content: 'Ubicación:', styles: labelStyle }, data.ubicacion || ''],
                        [{ content: 'Correo:', styles: labelStyle }, data.correo || '', { content: 'Jefe:', styles: labelStyle }, { content: data.jefatura || '', colSpan: 3 }, { content: 'Ticket:', styles: labelStyle }, data.ticket || ''],
                        [{ content: 'OBSERVACIONES', styles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' } }, { content: data.observaciones || '', colSpan: 7 }]
                    ],
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 7, cellPadding: 1.5, lineColor: '#1879ae', lineWidth: 0.1 },
                });

                let finalY = doc.autoTable.previous.finalY;

                const retiredItems = data.equiposRetirados || [];
                const deliveredItem = data.equipoEntregadoId ? data.equiposNuevosAgregados.find(eq => eq.id === data.equipoEntregadoId) : null;
                const retiredIds = retiredItems.map(eq => eq.id);
                const maintainedItems = (data.equiposAsignadosOriginalmente || []).filter(eq => !retiredIds.includes(eq.id));

                // Tabla de equipos retirados
                if (retiredItems.length > 0) {
                    const retiredBody = retiredItems.map(e => [
                        e.tipo || 'NA', e.mtm || 'NA', e.marca || 'NA', e.desc || 'NA',
                        e.serie || 'NA', e.estado || 'NA', e.codigo || 'NA'
                    ]);

                    doc.autoTable({
                        startY: finalY + 5,
                        body: [['EQUIPOS RETIRADOS']],
                        theme: 'grid',
                        styles: { font: 'helvetica', fontSize: 10, fontStyle: 'bold', lineColor: '#1879ae', lineWidth: 0.1 },
                        bodyStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', halign: 'center', cellPadding: 2 }
                    });
                    finalY = doc.autoTable.previous.finalY;

                    doc.autoTable({
                        startY: finalY,
                        head: [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'CÓDIGO DE ACTIVO']],
                        body: retiredBody,
                        theme: 'grid',
                        styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                        headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                    });
                    finalY = doc.autoTable.previous.finalY;
                }

                // Tabla de equipo entregado
                let deliveredBody = [];
                if (deliveredItem) {
                    deliveredBody = [[
                        deliveredItem.tipo || 'NA', deliveredItem.mtm || 'NA', deliveredItem.marca || 'NA',
                        deliveredItem.desc || 'NA', deliveredItem.serie || 'NA', deliveredItem.estado || 'NA',
                        deliveredItem.codigo || 'NA'
                    ]];
                } else {
                    deliveredBody = [['-- Sin equipo nuevo seleccionado para entregar --', '', '', '', '', '', '']];
                }

                doc.autoTable({
                    startY: finalY + 5,
                    body: [['EQUIPO A ENTREGAR']],
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 10, fontStyle: 'bold', lineColor: '#1879ae', lineWidth: 0.1 },
                    bodyStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', halign: 'center', cellPadding: 2 }
                });
                finalY = doc.autoTable.previous.finalY;

                doc.autoTable({
                    startY: finalY,
                    head: [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'CÓDIGO DE ACTIVO']],
                    body: deliveredBody,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                    headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                });
                finalY = doc.autoTable.previous.finalY;

                // Tabla de equipos que mantiene
                if (maintainedItems.length > 0) {
                    const maintainedBody = maintainedItems.map(e => [
                        e.tipo || 'NA', e.mtm || 'NA', e.marca || 'NA', e.desc || 'NA',
                        e.serie || 'NA', e.estado || 'NA', e.codigo || 'NA'
                    ]);

                    doc.autoTable({
                        startY: finalY + 5,
                        body: [['Equipos que Mantiene el Usuario']],
                        theme: 'grid',
                        styles: { font: 'helvetica', fontSize: 10, fontStyle: 'bold', lineColor: '#1879ae', lineWidth: 0.1 },
                        bodyStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', halign: 'center', cellPadding: 2 }
                    });
                    finalY = doc.autoTable.previous.finalY;

                    doc.autoTable({
                        startY: finalY,
                        head: [['TIPO', 'MTM/SKU', 'MARCA', 'DESCRIPCIÓN', 'SERIE', 'ESTADO', 'CÓDIGO DE ACTIVO']],
                        body: maintainedBody,
                        theme: 'grid',
                        styles: { font: 'helvetica', fontSize: 6, cellPadding: 1, lineColor: '#1879ae', lineWidth: 0.1 },
                        headStyles: { fillColor: '#1879ae', textColor: '#FFFFFF', fontStyle: 'bold' }
                    });
                    finalY = doc.autoTable.previous.finalY;
                }

                // Firmas
                const firmaIzquierda = { titulo: 'FIRMA CONFORME (USUARIO)', nombre: data.nombre, cedula: data.cedula };
                const firmaDerecha = { titulo: 'FIRMA CONFORME (TÉCNICO)', nombre: tecnicoSeleccionado.nombre, cedula: tecnicoSeleccionado.cedula };

                let signatureY = finalY + 40;

                doc.setDrawColor('#000000');
                doc.setLineWidth(0.3);

                // Firma izquierda
                doc.line(30, signatureY, 90, signatureY);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(firmaIzquierda.titulo, 60, signatureY + 7, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text(firmaIzquierda.nombre || 'NA', 60, signatureY + 12, { align: 'center' });
                doc.text(`CI: ${firmaIzquierda.cedula || 'NA'}`, 60, signatureY + 17, { align: 'center' });

                // Firma derecha
                doc.line(120, signatureY, 180, signatureY);
                doc.setFont('helvetica', 'bold');
                doc.text(firmaDerecha.titulo, 150, signatureY + 7, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text(firmaDerecha.nombre || 'NA', 150, signatureY + 12, { align: 'center' });
                doc.text(`CI: ${firmaDerecha.cedula || 'NA'}`, 150, signatureY + 17, { align: 'center' });
            }

            window.addEventListener('DOMContentLoaded', initializeForm);

        });
</script>
    
</body>

</html>